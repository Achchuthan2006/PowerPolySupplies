<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Product | Power Poly Supplies</title>
  <meta name="description" content="Product details, bulk pricing tiers, and availability for Power Poly Supplies.">
  <link rel="stylesheet" href="./css/styles.css?v=20260126"/>
  <link rel="icon" type="image/png" href="./assets/poly%20logo%20without%20background.png"/>
</head>
<body>
  <header class="site-header">
    <div class="promo-strip">
      <div class="container promo-inner">
        <div><strong data-i18n="brand.name">Power Poly Supplies</strong> | <span data-i18n="brand.tagline">Power your packaging</span></div>
        <div style="font-weight:700;" data-i18n="promo.right">Bulk-ready stock | Fast response | Canada-wide supply</div>
      </div>
    </div>
    <div class="navbar">
      <div class="container navbar-inner">
        <a class="brand" href="./index.html">
          <img src="./assets/poly%20logo%20without%20background.png" alt="Power Poly Supplies" width="62" height="62" decoding="async">
          <div class="brand-text">
            <span class="brand-title" data-i18n="brand.name">Power Poly Supplies</span>
            <span class="brand-tagline" data-i18n="brand.tagline">Power your packaging</span>
          </div>
        </a>
        <button class="menu-btn" id="menuBtn" aria-label="Open menu" data-i18n="nav.menu">Menu</button>
        <nav class="navlinks" id="navLinks">
          <a href="./index.html" data-i18n="nav.home">Home</a>
          <a href="./specials.html" data-i18n="nav.specials">Special Offers</a>
          <div class="dropdown">
            <button class="dropbtn" type="button"><span data-i18n="nav.shop">Shop by Category</span> <span class="caret" aria-hidden="true"></span></button>
            <div class="dropdown-menu">
              <a href="./products.html?cat=Garment%20Bags" data-i18n="nav.garment">Garment Cover Bags</a>
              <a href="./products.html?cat=Polybags" data-i18n="nav.polybags">Polybags</a>
              <a href="./products.html?cat=Hangers" data-i18n="nav.hangers">Hangers</a>
              <a href="./products.html?cat=Wraps" data-i18n="nav.wraps">Wraps</a>
              <a href="./products.html?cat=Racks" data-i18n="nav.racks">Racks</a>
            </div>
          </div>
          <a href="./about.html" data-i18n="nav.about">About Us</a>
          <a href="./contact.html"><span class="nav-icon phone-icon" aria-hidden="true"></span><span data-i18n="nav.contact">Contact</span></a>
          <a href="./feedback.html"><span class="nav-icon pen-icon" aria-hidden="true"></span><span data-i18n="nav.feedback">Feedback</span></a>
          <a href="./login.html"><span class="nav-icon user-icon" aria-hidden="true"></span><span data-i18n="nav.account">Account</span></a>
          <a href="./cart.html"><span class="nav-icon cart-icon" aria-hidden="true"></span><span data-i18n="nav.cart">Cart</span> <span class="badge" data-cart-badge>0</span></a>
          <form class="search-bar nav-search" action="./products.html" method="get" role="search">
            <input type="search" name="q" placeholder="Search" aria-label="Search products" data-i18n-placeholder="nav.search_placeholder">
            <button type="submit" data-i18n="nav.search_button">Search</button>
          </form>

        </nav>
      </div>
    </div>
  </header>

  <div class="container page" id="wrap"></div>

  <script src="./config.js"></script>

  <script src="./js/store.js"></script>
  <script src="./js/notifications.js"></script>
  <script src="./js/i18n.js"></script>
  <script src="./js/ui.js"></script>
  <script>
    PPS.updateCartBadge();

    function qs(name){ return new URLSearchParams(location.search).get(name); }

    function categoryLabel(category){
      const lang = window.PPS_I18N?.getLang?.() || "en";
      if(lang === "fr"){
        const map = {
          "Garment Bags": "Housses de vetements",
          "Hangers": "Cintres",
          "Polybags": "Sacs en poly",
          "Wraps": "Films",
          "Racks": "Portants"
        };
        return map[category] || category || "";
      }
      if(lang === "ko"){
        const map = {
          "Garment Bags": "Garment Bags",
          "Hangers": "Hangers",
          "Polybags": "Polybags",
          "Wraps": "Wraps",
          "Racks": "Racks"
        };
        return map[category] || category || "";
      }
      if(lang === "es"){
        const map = {
          "Garment Bags": "Bolsas para prendas",
          "Hangers": "Ganchos",
          "Polybags": "Bolsas de polietileno",
          "Wraps": "Film",
          "Racks": "Percheros"
        };
        return map[category] || category || "";
      }
      return category || "";
    }

    const heartIcon = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s-6.7-4.4-9.5-7.2A5.6 5.6 0 0 1 12 5.6a5.6 5.6 0 0 1 9.5 8.2C18.7 16.6 12 21 12 21z"/></svg>';
    const bookmarkIcon = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/></svg>';

    function favoriteTitle(active){
      return active
        ? (window.PPS_I18N?.t("favorite.remove") || "Remove from favorites")
        : (window.PPS_I18N?.t("favorite.add") || "Add to favorites");
    }

    function favoriteButton(productId){
      const active = PPS.isFavorite(productId);
      return `<button class="favorite-btn ${active ? "active" : ""}" type="button" data-fav-id="${productId}" aria-pressed="${active ? "true" : "false"}" title="${favoriteTitle(active)}">${heartIcon}</button>`;
    }

    function wishlistTitle(active){
      return active ? "Remove from wishlist" : "Add to wishlist";
    }

    function wishlistButton(productId){
      const active = PPS.isInAnyWishlist?.(productId);
      return `<button class="wishlist-btn ${active ? "active" : ""}" type="button" data-wl-id="${productId}" aria-pressed="${active ? "true" : "false"}" title="${wishlistTitle(active)}">${bookmarkIcon}</button>`;
    }

    function syncWishlistButton(btn){
      const id = btn.dataset.wlId;
      const active = PPS.isInAnyWishlist?.(id);
      btn.classList.toggle("active", !!active);
      btn.setAttribute("aria-pressed", active ? "true" : "false");
      btn.title = wishlistTitle(active);
    }

    function syncFavoriteButton(btn){
      const id = btn.dataset.favId;
      const active = PPS.isFavorite(id);
      btn.classList.toggle("active", active);
      btn.setAttribute("aria-pressed", active ? "true" : "false");
      btn.title = favoriteTitle(active);
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".favorite-btn");
      if(!btn) return;
      e.preventDefault();
      e.stopPropagation();
      PPS.toggleFavorite(btn.dataset.favId);
      syncFavoriteButton(btn);
    });

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".wishlist-btn");
      if(!btn) return;
      e.preventDefault();
      e.stopPropagation();
      const session = PPS.getSession?.();
      if(!session){
        window.location.href = "./login.html";
        return;
      }
      const id = btn.dataset.wlId;
      const active = PPS.isInAnyWishlist?.(id);
      if(active){
        PPS.removeFromWishlist?.(id);
      }else{
        PPS.addToWishlist?.(id);
      }
      syncWishlistButton(btn);
    });

    window.addEventListener("pps:favorites", ()=>{
      document.querySelectorAll(".favorite-btn").forEach(syncFavoriteButton);
    });

    window.addEventListener("pps:wishlists", ()=>{
      document.querySelectorAll(".wishlist-btn").forEach(syncWishlistButton);
    });

    (async ()=>{
      const slug = qs("slug");
      const products = await PPS.loadProducts();
      const p = products.find(x=>x.slug===slug);
      const wrap = document.getElementById("wrap");

      if(!p){
        wrap.innerHTML = `<p>${window.PPS_I18N?.t("product.not_found") || "Product not found."}</p>`;
        return;
      }

      function renderStars(value){
        const full = Math.round(value);
        return new Array(5).fill(0).map((_, idx)=>`
          <span class="star ${idx < full ? "filled" : ""}" aria-hidden="true">&#9733;</span>
        `).join("");
      }

      function stockClass(stock){
        const labels = {
          out: window.PPS_I18N?.t("product.stock.out") || "Out of stock",
          low: window.PPS_I18N?.t("product.stock.low") || "Almost out of stock",
          in: window.PPS_I18N?.t("product.stock.in") || "In stock"
        };
        if(stock <= 0) return { cls:"out", label: labels.out };
        if(stock <= 10) return { cls:"low", label: labels.low };
        return { cls:"in", label: labels.in };
      }

      function getBulkTierPriceCents(product, qty){
        if((product?.category || "") === "Garment Bags"){
          return PPS.getTieredPriceCents(product, qty);
        }
        const base = Math.max(0, Number(product?.priceCents) || 0);
        if(qty >= 20) return Math.max(0, base - 300);
        if(qty >= 15) return Math.max(0, base - 200);
        if(qty >= 10) return Math.max(0, base - 100);
        return base;
      }

      const RECENT_KEY = "pps_recently_viewed_v1";
      function readRecentSlugs(){
        try{
          const raw = localStorage.getItem(RECENT_KEY);
          const arr = JSON.parse(raw || "[]");
          return Array.isArray(arr) ? arr.map(String).filter(Boolean) : [];
        }catch(_err){
          return [];
        }
      }
      function writeRecentSlugs(slugs){
        try{
          localStorage.setItem(RECENT_KEY, JSON.stringify(slugs.slice(0, 10)));
        }catch(_err){
          // ignore
        }
      }
      function rememberRecent(slug){
        const s = String(slug || "");
        if(!s) return;
        const prev = readRecentSlugs().filter(x=>x !== s);
        prev.unshift(s);
        writeRecentSlugs(prev);
      }

      function extractSpecsFromName(name){
        const text = String(name || "");
        const specs = [];
        const sizeMatch = text.match(/(\d+(?:\.\d+)?)\s*\"\s*x\s*(\d+(?:\.\d+)?)\s*\"\s*x\s*(\d+(?:\.\d+)?)\s*\"/i);
        if(sizeMatch){
          specs.push({ label: "Size", value: `${sizeMatch[1]}" x ${sizeMatch[2]}" x ${sizeMatch[3]}"` });
        }
        const paren = text.match(/\(([^)]+)\)/);
        if(paren && paren[1]){
          specs.push({ label: "Variant", value: paren[1].trim() });
        }
        return specs;
      }

      function qualityBadgesHtml(category){
        const cat = String(category || "");
        if(cat === "Hangers"){
          const pack = window.PPS_I18N?.t("pack.hangers_500") || "500 pcs / box";
          const label = window.PPS_I18N?.t("pack.label") || "Pack";
          return `
            <div class="feature-badges" aria-label="${label}">
              <span class="feature-pill">${pack}</span>
            </div>
          `;
        }
        if(cat !== "Garment Bags" && cat !== "Polybags") return "";
        return `
          <div class="feature-badges" aria-label="Product features">
            <span class="feature-pill">100% Korean-made</span>
            <span class="feature-pill">100% virgin material</span>
            <span class="feature-pill">Easy-tear perforation</span>
          </div>
        `;
      }

      function addBusinessDays(date, days){
        const d = new Date(date.getTime());
        let left = Math.max(0, Number(days) || 0);
        while(left > 0){
          d.setDate(d.getDate() + 1);
          const day = d.getDay();
          if(day !== 0 && day !== 6){
            left -= 1;
          }
        }
        return d;
      }
      function formatShortDate(d){
        try{
          return new Intl.DateTimeFormat(undefined, { month:"short", day:"numeric" }).format(d);
        }catch(_err){
          return d.toDateString();
        }
      }

      async function loadReviews(){
        const status = document.getElementById("reviewsStatus");
        const list = document.getElementById("reviewsList");
        const headerAvg = document.getElementById("reviewsHeader");
        try{
          const data = await PPS.fetchReviews(p.id);
          const { reviews=[], average=0, count=0 } = data;
          const countTemplate = window.PPS_I18N?.t("product.reviews.count") || "{{count}} reviews";
          const countLabel = count > 0
            ? countTemplate.replace("{{count}}", String(count))
            : (window.PPS_I18N?.t("product.reviews.none") || "No reviews yet");
          headerAvg.innerHTML = `${renderStars(average)} <span class="review-meta">(${average.toFixed(1)} / 5 - ${countLabel})</span>`;
          if(reviews.length === 0){
            const none = window.PPS_I18N?.t("product.reviews.none_desc") || "No reviews yet. Be the first to rate this product.";
            list.innerHTML = `<div class="card" style="padding:10px;">${none}</div>`;
            return;
          }
          list.innerHTML = reviews.map(r=>`
            <div class="card" style="padding:12px;">
              <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
                <div style="font-weight:800;">${r.name || (window.PPS_I18N?.t("product.reviews.anonymous") || "Anonymous")}</div>
                <div>${renderStars(r.rating)}</div>
              </div>
              <div style="color:var(--muted); font-size:13px; margin-top:6px;">${new Date(r.createdAt).toLocaleString()}</div>
              <div style="margin-top:10px;">${(r.comment || "").replace(/</g,"&lt;")}</div>
            </div>
          `).join("");
        }catch(err){
          status.textContent = window.PPS_I18N?.t("product.reviews.load_failed") || "Unable to load reviews right now.";
          status.style.display = "block";
        }
      }

      const lang = window.PPS_I18N?.getLang?.() || "en";
      const displayName = lang === "es"
        ? (window.PPS_I18N?.autoTranslate?.(p.name || "", "es") || p.name)
        : p.name;
      const displayCategory = categoryLabel(p.category || "");
      const desc = lang === "fr"
        ? (p.description_fr || p.description)
        : lang === "ko"
          ? (p.description_ko || p.description)
          : lang === "hi"
            ? (p.description_hi || p.description)
            : lang === "ta"
              ? (p.description_ta || p.description)
              : lang === "es"
                ? (window.PPS_I18N?.autoTranslate?.(p.description_es || p.description || "", "es") || (p.description_es || p.description || ""))
                : p.description;
      const compareCents = (Number(p.priceCents) || 0) + 1000;
      const memberCents = Number(p.priceCents) || 0;
      const savingsCents = Math.max(0, compareCents - memberCents);
      const isMember = Boolean(PPS.getSession?.());
      const bannerTemplate = window.PPS_I18N?.t("member.banner") || "Log in to save {{amount}} with Power Poly Member Pricing";
      const bannerText = bannerTemplate.replace("{{amount}}", PPS.money(savingsCents, p.currency));

      wrap.innerHTML = `
        <section class="hero fade-in" style="margin-bottom:16px;">
          <nav class="breadcrumbs" aria-label="Breadcrumb">
            <a href="./index.html">Home</a>
            <span class="crumb-sep" aria-hidden="true">/</span>
            <a href="./products.html?cat=${encodeURIComponent(p.category || "")}">${displayCategory || "Products"}</a>
            <span class="crumb-sep" aria-hidden="true">/</span>
            <span aria-current="page">${displayName}</span>
          </nav>
          <p style="margin:0; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted);" data-i18n="product.kicker">Product detail</p>
          <h1 style="margin:4px 0 6px;">${displayName}</h1>
          <p style="margin:0; color:var(--muted);">${window.PPS_I18N?.t("product.category") || "Category:"} ${displayCategory || "N/A"}</p>
        </section>
        <div class="grid product-detail-grid" style="grid-template-columns: 1.1fr .9fr; gap:24px;">
          <div class="card fade-in">
            ${(()=>{
              const images = Array.from(new Set([
                p.image,
                ...(Array.isArray(p.images) ? p.images : []),
                p.image2,
                p.image3
              ].filter(Boolean)));
              const main = images[0] || "./assets/poly%20logo%20without%20background.png";
              const thumbs = images.length > 1
                ? `<div class="product-gallery-thumbs" id="galleryThumbs">
                    ${images.map((src, idx)=>`
                      <button type="button" class="thumb ${idx===0 ? "active" : ""}" data-src="${String(src).replace(/"/g,"&quot;")}" aria-label="View image ${idx+1}">
                        <img src="${src}" alt="" loading="lazy" decoding="async" width="120" height="86">
                      </button>
                    `).join("")}
                  </div>`
                : "";
              return `
                <div class="product-gallery">
                  <div class="product-gallery-main">
                    <img id="mainImg" src="${main}" alt="${displayName}" width="900" height="640" decoding="async">
                    <button class="product-zoom-btn" type="button" id="productZoomBtn" aria-label="Zoom image">
                      <span class="zoom-plus" aria-hidden="true">+</span>
                    </button>
                  </div>
                  ${thumbs}
                </div>
                <div class="pps-zoom-overlay" id="ppsZoomOverlay" aria-hidden="true">
                  <div class="pps-zoom-dialog" role="dialog" aria-modal="true" aria-label="Product image zoom">
                    <button class="pps-modal-close" type="button" id="ppsZoomClose" aria-label="Close">&times;</button>
                    <div class="pps-zoom-stage" id="ppsZoomStage" aria-hidden="true">
                      <img id="ppsZoomImg" src="${main}" alt="${displayName}" decoding="async">
                    </div>
                    <div class="pps-zoom-controls" role="group" aria-label="Zoom controls">
                      <button class="btn btn-outline btn-sm" type="button" id="ppsZoomOut" aria-label="Zoom out">&minus;</button>
                      <button class="btn btn-outline btn-sm" type="button" id="ppsZoomReset" aria-label="Reset zoom">Reset</button>
                      <button class="btn btn-primary btn-sm" type="button" id="ppsZoomIn" aria-label="Zoom in">+</button>
                    </div>
                    <div class="pps-zoom-hint">Tip: scroll or pinch trackpad to zoom, drag to pan.</div>
                  </div>
                </div>
              `;
            })()}
          </div>
          <div class="card fade-in" style="padding:18px;">
            <h2 style="margin:0;">${displayName}</h2>
            <p style="color:var(--muted); margin-top:8px;">${displayCategory}</p>
              <div class="member-pricing">
                <div>
                  <div class="market-label" data-i18n="market.price.label">Market price</div>
                  <span class="compare-price">${PPS.money(compareCents, p.currency)}</span>
                </div>
                <div>
                  <div class="member-label" data-i18n="member.price.label">Power Poly Member Price</div>
                  <span class="price" style="font-size:22px;">${PPS.money(memberCents,p.currency)}</span>
                </div>
              ${favoriteButton(p.id)}
              ${wishlistButton(p.id)}
              </div>
            ${!isMember && savingsCents > 0 ? `<a class="member-banner" href="./login.html">${bannerText}</a>` : ""}
            ${(()=>{ const s = stockClass(p.stock); return `<div class="stock ${s.cls}"><span class="dot"></span>${s.label}</div>`; })()}
            ${p.stock > 0 && p.stock <= 15 ? `<div class="stock-urgency">Only <strong>${p.stock}</strong> boxes left — order soon.</div>` : ""}
            ${qualityBadgesHtml(p.category)}

            ${(()=>{
              const specs = extractSpecsFromName(displayName);
              if(String(p?.category || "") === "Hangers"){
                specs.push({
                  label: window.PPS_I18N?.t("spec.pack") || "Pack",
                  value: window.PPS_I18N?.t("pack.hangers_500") || "500 pcs / box"
                });
              }
              if(!specs.length) return "";
              return `
                <div class="specs">
                  <div class="specs-title">Quick specs</div>
                  <ul class="specs-list">
                    ${specs.map(s=>`<li><span class="check">✓</span><span><strong>${s.label}:</strong> ${s.value}</span></li>`).join("")}
                  </ul>
                </div>
              `;
            })()}
            <p style="margin-top:14px; color:var(--text); line-height:1.5;">${desc || ""}</p>

            <div class="pricing-tiers">
              <div class="pricing-tiers-header" data-i18n="product.bulk">Bulk pricing</div>
              <div class="pricing-tiers-grid">
                ${renderTier(getBulkTierPriceCents(p, 10), p.currency, 10, p.stock)}
                ${renderTier(getBulkTierPriceCents(p, 15), p.currency, 15, p.stock)}
                ${renderTier(getBulkTierPriceCents(p, 20), p.currency, 20, p.stock)}
              </div>
            </div>

            <div class="qty-row" style="margin-top:16px;">
              <div class="qty-stepper" aria-label="Quantity selector">
                <button class="qty-btn" type="button" id="qtyMinus" aria-label="Decrease quantity">-</button>
                <input class="qty-input" id="qty" inputmode="numeric" pattern="[0-9]*" value="1" aria-label="Quantity">
                <button class="qty-btn" type="button" id="qtyPlus" aria-label="Increase quantity">+</button>
              </div>
              <div class="qty-meta">
                <div class="qty-total" id="qtyTotal"></div>
                <div class="qty-note" id="qtyNote"></div>
              </div>
            </div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-primary" ${p.stock<=0 ? "disabled" : ""} id="add">${window.PPS_I18N?.t("product.add") || "Add to cart"}</button>
              <a class="btn" href="./cart.html">${window.PPS_I18N?.t("product.go_cart") || "Go to cart"}</a>
              <a class="btn btn-outline" href="./contact.html">${window.PPS_I18N?.t("product.bulk_quote") || "Bulk quote"}</a>
            </div>

            <div class="delivery-estimate" id="deliveryEstimate" aria-live="polite"></div>
            <div style="margin-top:10px;">
              <button class="share-btn" type="button" id="shareBtn" aria-label="${window.PPS_I18N?.t("product.share") || "Share"}">
                <span class="share-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="16" height="16" focusable="false" aria-hidden="true">
                    <path d="M5 12v7a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 4v12" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    <path d="M7.5 8.5 12 4l4.5 4.5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                <span data-i18n="product.share">Share</span>
              </button>
              <div id="shareMsg" style="color:var(--muted); font-size:12px; margin-top:6px;"></div>
            </div>

            <div class="reviews-section">
              <div class="reviews-header" id="reviewsHeader">${renderStars(0)} <span class="review-meta">(${window.PPS_I18N?.t("product.reviews.none") || "No reviews yet"})</span></div>
              <div id="reviewsStatus" style="display:none; color:var(--muted); font-size:13px; margin-bottom:8px;"></div>
              <div id="reviewsList" class="grid" style="gap:10px;"></div>

              <form id="reviewForm" class="grid" style="gap:10px; margin-top:12px;">
                <div style="font-weight:800;" data-i18n="product.reviews.rate">Rate this product</div>
                <div class="star-input" id="starInput" aria-label="Select rating out of 5">
                  ${[1,2,3,4,5].map(val=>`<button type="button" data-val="${val}" class="star-btn">&#9733;</button>`).join("")}
                </div>
                <input class="input" name="name" placeholder="Your name (optional)" data-i18n-placeholder="product.reviews.name">
                <textarea class="input" name="comment" placeholder="Share your feedback" style="min-height:90px;" data-i18n-placeholder="product.reviews.comment"></textarea>
                <button class="btn btn-primary" type="submit" data-i18n="product.reviews.submit">Submit review</button>
                <div id="reviewMsg" style="color:var(--muted); font-size:13px;"></div>
              </form>
            </div>
          </div>
        </div>
        <div class="card fade-in" style="margin-top:18px; padding:18px;">
          <div class="related-header" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h3 style="margin:0;" data-i18n="product.related.title">You may also like</h3>
            <a class="btn btn-outline" href="./products.html" data-i18n="product.related.browse">Browse all</a>
          </div>
          <div id="relatedGrid" class="grid grid-4" style="margin-top:12px;"></div>
        </div>
        <div class="card fade-in" style="margin-top:18px; padding:18px;">
          <div class="related-header" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h3 style="margin:0;">Recently viewed</h3>
            <a class="btn btn-outline" href="./products.html">Browse all</a>
          </div>
          <div id="recentGrid" class="grid grid-4" style="margin-top:12px;"></div>
        </div>
        <div class="footer">&copy; <span id="y"></span> <span data-i18n="footer.short">Power Poly Supplies. Power your packaging.</span></div>
      `;

      // Product structured data (Schema.org)
      try{
        const productUrl = window.location.href;
        const imageUrl = p.image ? new URL(p.image, window.location.href).href : undefined;
        const scriptId = "productJsonLd";
        document.getElementById(scriptId)?.remove?.();
        const ld = {
          "@context": "https://schema.org",
          "@graph": [
            {
              "@type": "BreadcrumbList",
              "itemListElement": [
                { "@type":"ListItem", "position":1, "name":"Home", "item": new URL("./index.html", productUrl).href },
                { "@type":"ListItem", "position":2, "name": String(displayCategory || "Products"), "item": new URL(`./products.html?cat=${encodeURIComponent(p.category || "")}`, productUrl).href },
                { "@type":"ListItem", "position":3, "name": String(displayName || ""), "item": productUrl }
              ]
            },
            {
              "@type": "Product",
              "name": String(displayName || ""),
              "category": String(displayCategory || ""),
              "image": imageUrl ? [imageUrl] : undefined,
              "description": String(desc || ""),
              "sku": String(p.id || ""),
              "brand": { "@type":"Brand", "name":"Power Poly Supplies" },
              "offers": {
                "@type": "Offer",
                "priceCurrency": String(PPS.getCurrency?.() || p.currency || "CAD"),
                "price": ((Number(PPS.convertCents?.(memberCents, p.currency, PPS.getCurrency?.()) ?? memberCents) || 0) / 100).toFixed(2),
                "availability": (Number(p.stock) || 0) <= 0 ? "https://schema.org/OutOfStock" : "https://schema.org/InStock",
                "url": productUrl
              }
            }
          ]
        };
        const s = document.createElement("script");
        s.id = scriptId;
        s.type = "application/ld+json";
        s.textContent = JSON.stringify(ld);
        document.head.appendChild(s);
      }catch(_err){
        // ignore
      }

      window.PPS_I18N?.applyTranslations?.();
      document.getElementById("y").textContent = new Date().getFullYear();
      document.querySelectorAll(".fade-in").forEach(el => el.classList.add("show"));
      if(window.injectFooter) window.injectFooter();

      // Gallery thumbnails
      const mainImg = document.getElementById("mainImg");
      const zoomBtn = document.getElementById("productZoomBtn");
      const thumbs = document.getElementById("galleryThumbs");
      if(mainImg && thumbs){
        thumbs.addEventListener("click", (e)=>{
          const btn = e.target.closest("button.thumb");
          if(!btn) return;
          const src = btn.getAttribute("data-src");
          if(!src) return;
          mainImg.src = src;
          const zoomImg = document.getElementById("ppsZoomImg");
          if(zoomImg) zoomImg.src = src;
          thumbs.querySelectorAll("button.thumb").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
        });
      }

      // Zoom overlay (Amazon-style)
      (function setupZoom(){
        const overlay = document.getElementById("ppsZoomOverlay");
        const closeBtn = document.getElementById("ppsZoomClose");
        const stage = document.getElementById("ppsZoomStage");
        const img = document.getElementById("ppsZoomImg");
        const zoomInBtn = document.getElementById("ppsZoomIn");
        const zoomOutBtn = document.getElementById("ppsZoomOut");
        const zoomResetBtn = document.getElementById("ppsZoomReset");

        if(!overlay || !stage || !img) return;

        const CLOSE_DELAY_MS = 180;
        let closeCleanupTimer = 0;
        let ignoreOutsideClickUntil = 0;

        let scale = 1;
        let tx = 0;
        let ty = 0;
        let dragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragStartTx = 0;
        let dragStartTy = 0;

        const clamp = (n, min, max)=> Math.max(min, Math.min(max, n));
        const apply = ()=>{
          img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
          img.style.cursor = scale > 1 ? (dragging ? "grabbing" : "grab") : "zoom-in";
        };
        const reset = ()=>{
          scale = 1;
          tx = 0;
          ty = 0;
          apply();
        };
        const setOpen = (open)=>{
          if(closeCleanupTimer){
            clearTimeout(closeCleanupTimer);
            closeCleanupTimer = 0;
          }
          overlay.classList.toggle("open", !!open);
          overlay.setAttribute("aria-hidden", open ? "false" : "true");
          if(open){
            reset();
            try{
              document.body.classList.add("pps-modal-open");
              const scrollbar = Math.max(0, window.innerWidth - document.documentElement.clientWidth);
              document.body.style.paddingRight = scrollbar ? `${scrollbar}px` : "";
              document.documentElement.style.overflow = "hidden";
            }catch(_err){}
          }else{
            // Delay restoring scrollbars until the fade-out completes to avoid visible layout "twitch".
            closeCleanupTimer = setTimeout(()=>{
              closeCleanupTimer = 0;
              try{
                document.documentElement.style.overflow = "";
                document.body.style.paddingRight = "";
                document.body.classList.remove("pps-modal-open");
              }catch(_err){}
            }, CLOSE_DELAY_MS);
          }
        };

        const zoomBy = (delta, originEvent)=>{
          const next = clamp(Number(scale) + Number(delta), 1, 3);
          if(next === scale) return;

          if(originEvent && stage){
            const rect = stage.getBoundingClientRect();
            const ox = clamp((originEvent.clientX - rect.left) / Math.max(1, rect.width), 0, 1);
            const oy = clamp((originEvent.clientY - rect.top) / Math.max(1, rect.height), 0, 1);
            img.style.transformOrigin = `${Math.round(ox * 100)}% ${Math.round(oy * 100)}%`;
          }else{
            img.style.transformOrigin = "50% 50%";
          }

          scale = next;
          tx = clamp(tx, -220 * scale, 220 * scale);
          ty = clamp(ty, -160 * scale, 160 * scale);
          apply();
        };

        const open = ()=>{
          if(overlay.classList.contains("open")) return;
          ignoreOutsideClickUntil = (window.performance?.now?.() || Date.now()) + 320;
          setOpen(true);
        };
        const close = ()=> setOpen(false);

        if(zoomBtn) zoomBtn.addEventListener("click", open);
        if(mainImg) mainImg.addEventListener("click", open);
        if(closeBtn) closeBtn.addEventListener("click", close);
        overlay.addEventListener("click", (e)=>{
          const now = window.performance?.now?.() || Date.now();
          if(now < ignoreOutsideClickUntil) return;
          if(e.target === overlay) close();
        });
        document.addEventListener("keydown", (e)=>{
          if(!overlay.classList.contains("open")) return;
          if(e.key === "Escape") close();
        });

        if(zoomInBtn) zoomInBtn.addEventListener("click", ()=> zoomBy(0.5));
        if(zoomOutBtn) zoomOutBtn.addEventListener("click", ()=> zoomBy(-0.5));
        if(zoomResetBtn) zoomResetBtn.addEventListener("click", reset);

        stage.addEventListener("wheel", (e)=>{
          if(!overlay.classList.contains("open")) return;
          e.preventDefault();
          const dir = e.deltaY > 0 ? -0.25 : 0.25;
          zoomBy(dir, e);
        }, { passive:false });

        stage.addEventListener("dblclick", (e)=>{
          if(!overlay.classList.contains("open")) return;
          if(scale === 1){
            zoomBy(1, e);
          }else{
            reset();
          }
        });

        stage.addEventListener("pointerdown", (e)=>{
          if(!overlay.classList.contains("open")) return;
          if(scale <= 1) return;
          dragging = true;
          try{ img.style.transition = "none"; }catch(_err){}
          stage.setPointerCapture?.(e.pointerId);
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          dragStartTx = tx;
          dragStartTy = ty;
          apply();
        });
        stage.addEventListener("pointermove", (e)=>{
          if(!dragging) return;
          const dx = e.clientX - dragStartX;
          const dy = e.clientY - dragStartY;
          tx = clamp(dragStartTx + dx, -240 * scale, 240 * scale);
          ty = clamp(dragStartTy + dy, -180 * scale, 180 * scale);
          apply();
        });
        stage.addEventListener("pointerup", (e)=>{
          if(!dragging) return;
          dragging = false;
          stage.releasePointerCapture?.(e.pointerId);
          try{ img.style.transition = ""; }catch(_err){}
          apply();
        });
        stage.addEventListener("pointercancel", ()=>{
          dragging = false;
          try{ img.style.transition = ""; }catch(_err){}
          apply();
        });

        // Initial state
        apply();
      })();

      // Quantity + live price
      const qtyInput = document.getElementById("qty");
      const qtyMinus = document.getElementById("qtyMinus");
      const qtyPlus = document.getElementById("qtyPlus");
      const qtyTotal = document.getElementById("qtyTotal");
      const qtyNote = document.getElementById("qtyNote");
      function clampQty(val){
        const n = Math.max(1, Math.floor(Number(val) || 1));
        if(Number.isFinite(p.stock) && p.stock > 0){
          return Math.min(n, p.stock);
        }
        return n;
      }
      function updateQtyPricing(){
        if(!qtyInput || !qtyTotal || !qtyNote) return;
        const qty = clampQty(qtyInput.value);
        qtyInput.value = String(qty);
        const unit = getBulkTierPriceCents(p, qty);
        const total = unit * qty;
        qtyTotal.textContent = `Total: ${PPS.money(total, p.currency)}`;
        const tierMsg = qty >= 20 ? "20+ pricing applied" : qty >= 15 ? "15+ pricing applied" : qty >= 10 ? "10+ pricing applied" : "Standard pricing";
        qtyNote.textContent = `${PPS.money(unit, p.currency)} / box · ${tierMsg}`;
      }
      function setQty(val){
        if(!qtyInput) return;
        qtyInput.value = String(clampQty(val));
        updateQtyPricing();
      }
      if(qtyInput){
        qtyInput.addEventListener("input", updateQtyPricing);
        qtyInput.addEventListener("blur", ()=> setQty(qtyInput.value));
        updateQtyPricing();
      }
      if(qtyMinus) qtyMinus.addEventListener("click", ()=> setQty((Number(qtyInput?.value) || 1) - 1));
      if(qtyPlus) qtyPlus.addEventListener("click", ()=> setQty((Number(qtyInput?.value) || 1) + 1));

      document.getElementById("add").onclick = ()=>{
        if(p.stock<=0) return;
        const qty = clampQty(qtyInput?.value);
        PPS.addToCart(p, qty);
      };

      // Estimated delivery (business days)
      const deliveryEl = document.getElementById("deliveryEstimate");
      if(deliveryEl){
        const start = addBusinessDays(new Date(), 2);
        const end = addBusinessDays(new Date(), 5);
        deliveryEl.textContent = `Estimated delivery: ${formatShortDate(start)} – ${formatShortDate(end)} (business days)`;
      }

      // Recently viewed
      rememberRecent(p.slug);
      const recentGrid = document.getElementById("recentGrid");
      if(recentGrid){
        const recentSlugs = readRecentSlugs().filter(s=>s !== p.slug);
        const recent = recentSlugs
          .map(slug => products.find(x=>String(x.slug) === slug))
          .filter(Boolean)
          .slice(0, 4);
        if(!recent.length){
          recentGrid.innerHTML = `<div style="color:var(--muted); font-size:13px;">No recently viewed products yet.</div>`;
        }else{
          recentGrid.innerHTML = recent.map(item=>{
            const compareCents = (Number(item.priceCents) || 0) + 1000;
            const memberCents = Number(item.priceCents) || 0;
            const s = item.stock<=0 ? "out" : item.stock<=10 ? "low" : "in";
            const label = item.stock<=0
              ? (window.PPS_I18N?.t("product.stock.out") || "Out of stock")
              : item.stock<=10
                ? (window.PPS_I18N?.t("product.stock.low") || "Almost out of stock")
                : (window.PPS_I18N?.t("product.stock.in") || "In stock");
            return `
              <div class="card">
                <a href="./product.html?slug=${encodeURIComponent(item.slug)}">
                  <img src="${item.image}" alt="${item.name}" loading="lazy" decoding="async" width="400" height="190">
                </a>
                <div class="card-body">
                  <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(item.slug)}">${item.name}</a>
                  <div class="member-pricing">
                    <div>
                      <div class="market-label" data-i18n="market.price.label">Market price</div>
                      <span class="compare-price">${PPS.money(compareCents,item.currency)}</span>
                    </div>
                    <div>
                      <div class="member-label" data-i18n="member.price.label">Power Poly Member Price</div>
                      <span class="price">${PPS.money(memberCents,item.currency)}</span>
                    </div>
                  </div>
                  <div class="stock ${s}"><span class="dot"></span>${label}</div>
                </div>
              </div>
            `;
          }).join("");
          window.PPS_I18N?.applyTranslations?.();
        }
      }
      const shareBtn = document.getElementById("shareBtn");
      const shareMsg = document.getElementById("shareMsg");
      const shareData = {
        title: displayName,
        text: `${displayName} - Power Poly Supplies`,
        url: window.location.href
      };

      function setShareMsg(text){
        if(!shareMsg) return;
        shareMsg.textContent = text || "";
      }

      if(shareBtn){
        shareBtn.addEventListener("click", async ()=>{
          if(navigator.share){
            try{
              await navigator.share(shareData);
              setShareMsg(window.PPS_I18N?.t("product.share.sent") || "Thanks for sharing.");
              return;
            }catch(err){
              if(err && err.name === "AbortError") return;
              setShareMsg(window.PPS_I18N?.t("product.share.fail") || "Unable to share right now.");
              return;
            }
          }
          if(navigator.clipboard?.writeText){
            try{
              await navigator.clipboard.writeText(shareData.url);
              setShareMsg(window.PPS_I18N?.t("product.share.copied") || "Link copied to clipboard.");
              return;
            }catch(err){
              // fall through to manual copy message
            }
          }
          setShareMsg(window.PPS_I18N?.t("product.share.manual") || "Copy the URL from the address bar.");
        });
      }

      document.querySelectorAll("[data-bulk-qty]").forEach((btn)=>{
        btn.addEventListener("click", ()=>{
          if(p.stock<=0) return;
          const qty = Number(btn.dataset.bulkQty) || 1;
          PPS.addToCart(p, qty);
          const original = btn.innerHTML;
          const addedLabel = window.PPS_I18N?.t("product.added_qty") || "Added {{qty}}";
          btn.innerHTML = addedLabel.replace("{{qty}}", qty);
          btn.disabled = true;
          setTimeout(()=>{
            btn.innerHTML = original;
            btn.disabled = false;
          }, 800);
        });
      });

      // Reviews interactions
      const starButtons = Array.from(document.querySelectorAll(".star-btn"));
      const starInput = document.getElementById("starInput");
      const reviewForm = document.getElementById("reviewForm");
      const reviewMsg = document.getElementById("reviewMsg");
      let selectedRating = 5;

      function paintStars(val){
        starButtons.forEach(btn=>{
          const v = Number(btn.dataset.val);
          if(v <= val){
            btn.classList.add("active");
          }else{
            btn.classList.remove("active");
          }
        });
      }
      paintStars(selectedRating);

      starInput.addEventListener("click",(e)=>{
        if(e.target.matches(".star-btn")){
          selectedRating = Number(e.target.dataset.val) || 5;
          paintStars(selectedRating);
        }
      });

      reviewForm.addEventListener("submit", async (e)=>{
        e.preventDefault();
        reviewMsg.textContent = window.PPS_I18N?.t("product.reviews.submitting") || "Submitting review...";
        try{
          await PPS.submitReview(p.id, {
            rating: selectedRating,
            name: e.target.name.value.trim(),
            comment: e.target.comment.value.trim()
          });
          reviewMsg.textContent = window.PPS_I18N?.t("product.reviews.thanks") || "Thanks! Your review was added.";
          e.target.reset();
          selectedRating = 5;
          paintStars(selectedRating);
          loadReviews();
        }catch(err){
          reviewMsg.textContent = err.message || (window.PPS_I18N?.t("product.reviews.submit_failed") || "Failed to submit review.");
        }
      });

      loadReviews();
      renderRelated(products);
    })();

    function renderTier(priceCents, currency, qty, stock){
      const price = Math.max(0, priceCents);
      const labelTpl = window.PPS_I18N?.t("product.bulk_label") || "{{qty}}+ boxes";
      const label = labelTpl.replace("{{qty}}", qty);
      const display = PPS.money(price, currency);
      const disabled = stock <= 0 ? "disabled" : "";
      return `
        <button class="pricing-tier" type="button" data-bulk-qty="${qty}" ${disabled}>
          <strong>${label}</strong>
          <span>${display}</span>
        </button>
      `;
    }

    function renderRelated(productsArg){
      const grid = document.getElementById("relatedGrid");
      if(!grid) return;
      const products = Array.isArray(productsArg) && productsArg.length
        ? productsArg
        : (window._products || []);
      const currentSlug = qs("slug");
      const current = products.find(x=>x.slug===currentSlug);
      const sameCat = current ? products.filter(x=>x.category===current.category && x.slug!==current.slug) : [];
      const others = products.filter(x=>x.slug!==currentSlug && !sameCat.includes(x));
      const picks = [...sameCat, ...others].slice(0,4);

      if(picks.length === 0){
        const more = window.PPS_I18N?.t("product.related.more") || "More products coming soon.";
        grid.innerHTML = `<div class="card" style="padding:14px;">${more}</div>`;
        return;
      }

      grid.innerHTML = picks.map(item=>{
        const lang = window.PPS_I18N?.getLang?.() || "en";
        const displayName = lang === "es"
          ? (window.PPS_I18N?.autoTranslate?.(item.name || "", "es") || item.name)
          : item.name;
        const s = item.stock<=0 ? "out" : item.stock<=10 ? "low" : "in";
        const label = item.stock<=0
          ? (window.PPS_I18N?.t("product.stock.out") || "Out of stock")
          : item.stock<=10
            ? (window.PPS_I18N?.t("product.stock.low") || "Almost out of stock")
            : (window.PPS_I18N?.t("product.stock.in") || "In stock");
        const compareCents = (Number(item.priceCents) || 0) + 1000;
        const memberCents = Number(item.priceCents) || 0;
        const savingsCents = Math.max(0, compareCents - memberCents);
        const isMember = Boolean(PPS.getSession?.());
        const bannerTemplate = window.PPS_I18N?.t("member.banner") || "Log in to save {{amount}} with Power Poly Member Pricing";
        const bannerText = bannerTemplate.replace("{{amount}}", PPS.money(savingsCents, item.currency));
        return `
          <div class="card fade-in">
            <a href="./product.html?slug=${encodeURIComponent(item.slug)}">
              <img src="${item.image}" alt="${displayName}" loading="lazy" decoding="async" width="400" height="190">
            </a>
            <div class="card-body">
              <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(item.slug)}">${displayName}</a>
              <div class="card-meta">${categoryLabel(item.category || "")}</div>
              <div class="member-pricing">
                <div>
                  <div class="market-label" data-i18n="market.price.label">Market price</div>
                  <span class="compare-price">${PPS.money(compareCents, item.currency)}</span>
                </div>
                <div>
                  <div class="member-label" data-i18n="member.price.label">Power Poly Member Price</div>
                  <span class="price">${PPS.money(memberCents,item.currency)}</span>
                </div>
                ${favoriteButton(item.id)}
                ${wishlistButton(item.id)}
              </div>
              ${!isMember && savingsCents > 0 ? `<a class="member-banner" href="./login.html">${bannerText}</a>` : ""}
              <div class="stock ${s}"><span class="dot"></span>${label}</div>
              <div style="margin-top:12px; display:flex; gap:10px;">
                <a class="btn" href="./product.html?slug=${encodeURIComponent(item.slug)}">${window.PPS_I18N?.t("product.view") || "View"}</a>
                <button class="btn btn-primary" ${item.stock<=0 ? "disabled" : ""} onclick="addRelated('${item.id}')">${window.PPS_I18N?.t("product.add") || "Add"}</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      document.querySelectorAll(".fade-in").forEach(el => el.classList.add("show"));

      window.addRelated = (id)=>{
        const prod = products.find(x=>x.id===id);
        if(!prod || prod.stock<=0) return;
        PPS.addToCart(prod);
      };
    }
</script>
</body>
</html>
