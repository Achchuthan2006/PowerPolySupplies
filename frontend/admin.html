<!doctype html>
<html data-lang-options="en,ta">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin | Power Poly Supplies</title>
  <link rel="stylesheet" href="./css/styles.css"/>
  <link rel="icon" type="image/png" href="./assets/poly%20logo%20without%20background.png"/>
</head>
<body>
  <header class="site-header">
    <div class="promo-strip">
      <div class="container promo-inner">
        <div><strong data-i18n="brand.name">Power Poly Supplies</strong> | <span data-i18n="brand.tagline">Power your packaging</span></div>
        <div style="font-weight:700;" data-i18n="promo.right">Bulk-ready stock | Fast response | Canada-wide supply</div>
      </div>
    </div>
    <div class="navbar">
      <div class="container navbar-inner">
        <a class="brand" href="./index.html">
          <img src="./assets/poly%20logo%20without%20background.png" alt="Power Poly Supplies" width="62" height="62" decoding="async">
          <div class="brand-text">
            <span class="brand-title" data-i18n="brand.name">Power Poly Supplies</span>
            <span class="brand-tagline" data-i18n="brand.tagline">Power your packaging</span>
          </div>
        </a>
        <button class="menu-btn" id="menuBtn" aria-label="Open menu" data-i18n="nav.menu">Menu</button>
        <nav class="navlinks" id="navLinks">
          <a href="./index.html" data-i18n="nav.home">Home</a>
          <a href="./products.html" data-i18n="admin.nav.products">Products</a>
          <a href="./admin.html" data-i18n="admin.nav.admin">Admin</a>
          <a href="./admin-messages.html" data-i18n="admin.messages.title">Messages</a>
                  <form class="search-bar nav-search" action="./products.html" method="get" role="search">
            <input type="search" name="q" placeholder="Search" aria-label="Search products">
            <button type="submit">Search</button>
          </form>
</nav>
      </div>
    </div>
  </header>

  <div class="container page">
    <section class="hero fade-in">
      <p style="margin:0; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted);" data-i18n="admin.kicker">Admin</p>
      <h1 data-i18n="admin.orders.title">Admin Orders</h1>
      <p data-i18n="admin.orders.subtitle">Review incoming orders, confirm payment method, and mark them fulfilled.</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="btn btn-outline" id="refresh" type="button" data-i18n="admin.orders.refresh">Refresh</button>
        <a class="btn" href="./admin-messages.html" data-i18n="admin.messages.title">Messages</a>
      </div>
    </section>

    <div id="orders" class="grid" style="gap:12px; margin-top:14px;"></div>
    <div class="footer" data-i18n="admin.footer">Power Poly Supplies Admin</div>
  </div>

  <script src="./config.js"></script>

  <script src="./js/store.js"></script>
  <script src="./js/i18n.js"></script>
  <script src="./js/ui.js"></script>
  <script>
    function itemDescription(item, lang){
      if(!item) return "";
      if(lang === "ta"){
        const ta = item.description_ta || "";
        if(/[\u0B80-\u0BFF]/.test(ta)) return ta;
        return item.description || "";
      }
      return item.description || "";
    }

    async function load(){
      const wrap = document.getElementById("orders");

      try{
        const res = await fetch(`${PPS.API_BASE}/api/admin/orders`);
        const data = await res.json().catch(()=> ({}));

        if(!res.ok || !data.ok){
          const failed = window.PPS_I18N?.t("admin.orders.failed") || "Failed to load orders.";
        wrap.innerHTML = `<div class='card' style='padding:14px;'>${failed}</div>`;
          return;
        }

        wrap.innerHTML = data.orders.map(o=>{
          const lang = o.language === "ta" ? "ta" : "en";
          return `
          <div class="card fade-in" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; gap:10px;">
              <div style="font-weight:900;">${o.id}</div>
              <div style="color:var(--muted);">${o.status}</div>
            </div>
            <div style="margin-top:8px; font-size:13px; color:var(--muted);">
              ${o.customer?.name || ""} | ${o.customer?.email || ""}
            </div>
            <div style="margin-top:10px;">
              ${o.items.map(i=>{
                const desc = itemDescription(i, lang);
                const descHtml = desc
                  ? `<div style="color:var(--muted); font-size:12px; margin-left:2px;">${desc}</div>`
                  : "";
                return `<div style="margin-bottom:6px;"><div>${i.name} x${i.qty}</div>${descHtml}</div>`;
              }).join("")}
            </div>
            <div style="margin-top:10px; font-weight:900;">
              ${(o.totalCents/100).toFixed(2)} ${o.currency}
            </div>
            <div style="margin-top:10px; display:flex; gap:10px;">
              <button class="btn btn-primary" onclick="fulfill('${o.id}')">${window.PPS_I18N?.t("admin.orders.fulfill") || "Mark Fulfilled"}</button>
            </div>
          </div>
        `}).join("");

        document.querySelectorAll(".fade-in").forEach(el => el.classList.add("show"));
      }catch(err){
        const unreachable = window.PPS_I18N?.t("admin.orders.unreachable") || "Server unreachable. Start backend on 127.0.0.1:5000.";
        wrap.innerHTML = `<div class='card' style='padding:14px;'>${unreachable}</div>`;
      }
    }

    async function fulfill(id){
      try{
        await fetch(`${PPS.API_BASE}/api/admin/orders/${id}/fulfill`,{method:"POST"});
        load();
      }catch(err){
        alert(window.PPS_I18N?.t("admin.orders.fulfill_failed") || "Failed to mark as fulfilled. Check the backend server.");
      }
    }

    document.getElementById("refresh").onclick = load;
    load();
  </script>
</body>
</html>
