document.getElementById("y").textContent=new Date().getFullYear(),PPS.updateCartBadge();function restoreCartFromQuery(){try{const e=new URLSearchParams(window.location.search).get("cart");if(!e)return;const r=PPS.getCart();if(Array.isArray(r)&&r.length)return;const i=e.replace(/-/g,"+").replace(/_/g,"/"),o=i.length%4?"=".repeat(4-i.length%4):"",n=decodeURIComponent(escape(atob(i+o))),u=JSON.parse(n);if(!Array.isArray(u)||!u.length)return;const a=u.filter(s=>Array.isArray(s)&&s[0]).map(([s,c])=>({id:String(s),qty:Math.max(1,Number(c)||1)}));a.length&&PPS.setCart(a)}catch{}}restoreCartFromQuery();const cart=PPS.getCart();let productMap=null;const productsPromise=PPS.loadProducts().then(t=>{productMap=new Map(t.map(e=>[e.id,e]))}),summary=document.getElementById("summary"),subtotalEl=document.getElementById("subtotal"),taxLabelEl=document.getElementById("taxLabel"),taxAmountEl=document.getElementById("taxAmount"),qstRowEl=document.getElementById("qstRow"),qstLabelEl=document.getElementById("qstLabel"),qstAmountEl=document.getElementById("qstAmount"),shippingLabelEl=document.getElementById("shippingLabel"),shippingAmountEl=document.getElementById("shippingAmount"),totalEl=document.getElementById("total"),savingsRowEl=document.getElementById("savingsRow"),savingsAmountEl=document.getElementById("savingsAmount"),msg=document.getElementById("msg"),backendStatus=document.getElementById("backendStatus"),payBtn=document.getElementById("payOnline"),submitBtn=document.querySelector("#form button[type='submit']"),formEl=document.getElementById("form"),provinceSelect=document.getElementById("province"),postalInput=document.getElementById("postal"),savedAddressWrap=document.getElementById("savedAddressWrap"),savedAddressSelect=document.getElementById("savedAddressSelect"),savedAddressHint=document.getElementById("savedAddressHint");async function checkBackendHealth(){if(!backendStatus)return;if(!(new URLSearchParams(window.location.search).get("debug")==="1")){backendStatus.style.display="none";return}const e=String(PPS.API_BASE||"").trim().replace(/\/+$/,"");if(e)try{const r=new AbortController,i=setTimeout(()=>r.abort(),9e3),o=await fetch(`${e}/api/health`,{signal:r.signal});clearTimeout(i);const n=await o.json().catch(()=>({}));if(!o.ok||!n?.ok)throw new Error("Health check failed");const u=n.square||{},a=n.email||{},s=u.configured?`Square: ready (${u.env||"unknown"})`:"Square: not configured",l=!!(a.ready||a.verified||a.sendgrid?.configured)?a.smtp?.verified||a.verified?"Email: ready (SMTP)":"Email: ready (SendGrid)":a.smtp?.configured?"Email: not ready":"Email: not configured";backendStatus.textContent=`Backend: up | ${s} | ${l}`,backendStatus.style.display="block"}catch{/onrender\.com$/i.test(new URL(e).hostname)?(backendStatus.textContent="Backend: starting up (Render free tier can take ~50s). You can still try checkout.",backendStatus.style.display="block",backendStatus.classList.remove("error","success","muted"),backendStatus.classList.add("status","muted")):backendStatus.style.display="none"}}checkBackendHealth(),setInterval(checkBackendHealth,15e3);function getUnitBasePrice(t){const e=productMap?.get(t.id);return e?PPS.getTieredPriceCents(e,t.qty):t.priceCentsBase??t.priceCents}function getUnitCurrency(t){return productMap?.get(t.id)?.currency||t.currencyBase||t.currency||"CAD"}const PROVINCE_RATES={ON:{rate:.13,label:"HST 13%"},NS:{rate:.15,label:"HST 15%"},NB:{rate:.15,label:"HST 15%"},NL:{rate:.15,label:"HST 15%"},PE:{rate:.15,label:"HST 15%"},AB:{rate:.05,label:"GST 5%"},BC:{rate:.05,label:"GST 5%"},SK:{rate:.05,label:"GST 5%"},MB:{rate:.05,label:"GST 5%"},QC:{rate:.05,label:"GST 5%",qstRate:.09975,qstLabel:"QST 9.975%"},YT:{rate:.05,label:"GST 5%"},NT:{rate:.05,label:"GST 5%"},NU:{rate:.05,label:"GST 5%"}};function provinceLabel(t){return((window.PPS_I18N?.getLang?.()||"en")==="fr"?{ON:"Ontario",NS:"Nouvelle-?cosse",NB:"Nouveau-Brunswick",NL:"Terre-Neuve-et-Labrador",PE:"?le-du-Prince-?douard",AB:"Alberta",BC:"Colombie-Britannique",SK:"Saskatchewan",MB:"Manitoba",QC:"Qu?bec",YT:"Yukon",NT:"Territoires du Nord-Ouest",NU:"Nunavut"}:{ON:"Ontario",NS:"Nova Scotia",NB:"New Brunswick",NL:"Newfoundland and Labrador",PE:"Prince Edward Island",AB:"Alberta",BC:"British Columbia",SK:"Saskatchewan",MB:"Manitoba",QC:"Quebec",YT:"Yukon",NT:"Northwest Territories",NU:"Nunavut"})[t]||t||""}function provinceName(t){const e={ON:"Ontario",NS:"Nova Scotia",NB:"New Brunswick",NL:"Newfoundland and Labrador",PE:"Prince Edward Island",AB:"Alberta",BC:"British Columbia",SK:"Saskatchewan",MB:"Manitoba",QC:"Quebec",YT:"Yukon",NT:"Northwest Territories",NU:"Nunavut"};return provinceLabel(t)||t||""}function calculateTax(t,e){const r=window.PPS_I18N?.t("checkout.tax")||"Tax",i=PROVINCE_RATES[e]||{rate:0,label:r},o=Math.round(t*i.rate),n=i.qstRate?Math.round(t*i.qstRate):0,u=o+n;return{taxRate:i.rate,taxLabel:i.label,taxAmount:u,gstAmount:o,qstAmount:n,qstLabel:i.qstLabel||"",total:t+u}}function normalizePostal(t){return(t||"").toUpperCase().replace(/[^A-Z0-9]/g,"")}function getShippingForPostal(t){const e=normalizePostal(t),r=window.PPS_I18N?.t("checkout.shipping.label.gta")||"Standard delivery (GTA)",i=window.PPS_I18N?.t("checkout.shipping.label.contact")||"Delivery charges",o=window.PPS_I18N?.t("checkout.shipping.free")||"Free",n=window.PPS_I18N?.t("checkout.shipping.contact")||"Contact us";if(!e)return{zone:"Unknown",label:i,amountCents:0,displayAmount:n};const u=e[0];return u==="M"||u==="L"?{zone:"GTA",label:r,amountCents:0,displayAmount:o}:{zone:"Canada",label:i,amountCents:0,displayAmount:n}}function applyProvinceLabels(){if(!provinceSelect)return;const t=window.PPS_I18N?.getLang?.()||"en",e={ON:"Ontario",NS:t==="fr"?"Nouvelle-?cosse":"Nova Scotia",NB:t==="fr"?"Nouveau-Brunswick":"New Brunswick",NL:t==="fr"?"Terre-Neuve-et-Labrador":"Newfoundland and Labrador",PE:t==="fr"?"?le-du-Prince-?douard":"Prince Edward Island",AB:"Alberta",BC:t==="fr"?"Colombie-Britannique":"British Columbia",SK:"Saskatchewan",MB:"Manitoba",QC:t==="fr"?"Qu?bec":"Quebec",YT:"Yukon",NT:t==="fr"?"Territoires du Nord-Ouest":"Northwest Territories",NU:"Nunavut"};Array.from(provinceSelect.options).forEach(r=>{const i=r.value;i&&(r.textContent=e[i]||r.textContent)})}function setPending(t,e,r){t&&(e?r&&(t.dataset.originalText||(t.dataset.originalText=t.textContent),t.textContent=r):t.dataset.originalText&&(t.textContent=t.dataset.originalText),t.disabled=e)}function getSessionEmail(){try{const t=PPS?.getSession?.();return String(t?.email||"").trim().toLowerCase()}catch{return""}}function userKey(t,e){return`pps_account_${String(t||"").trim().toLowerCase()}_${e}`}function readJson(t,e){try{const r=localStorage.getItem(String(t||""));return r?JSON.parse(r):e}catch{return e}}function resolveDefaultAddressId(t,e){const r=Array.isArray(e)?e:[],i=userKey(t,"default_address_id_v1");try{const n=String(localStorage.getItem(i)||"").trim();if(n&&r.some(u=>String(u?.id)===String(n)))return n}catch{}const o=r[0]?.id?String(r[0].id):"";if(o)try{localStorage.setItem(i,o)}catch{}return o}function isAddressBlank(){const t=String(formEl?.address1?.value||"").trim(),e=String(formEl?.city?.value||"").trim(),r=String(formEl?.postal?.value||"").trim();return!t&&!e&&!r}function applySavedAddress(t){!t||!formEl||(formEl.name&&t.name&&(formEl.name.value=String(t.name||"").trim()),formEl.address1&&t.line1&&(formEl.address1.value=String(t.line1||"").trim()),formEl.address2&&(formEl.address2.value=String(t.line2||"").trim()),formEl.city&&(formEl.city.value=String(t.city||"").trim()),postalInput&&(postalInput.value=String(t.postal||"").trim()),provinceSelect&&t.province&&(provinceSelect.value=String(t.province||"").trim()),drawSummary())}function initSavedAddressPicker(){if(!savedAddressWrap||!savedAddressSelect)return;const t=getSessionEmail();if(!t){savedAddressWrap.style.display="none";return}const e=readJson(userKey(t,"addresses"),[]),r=Array.isArray(e)?e.filter(Boolean):[];if(!r.length){savedAddressWrap.style.display="none";return}savedAddressWrap.style.display="block";const i=resolveDefaultAddressId(t,r),o=(()=>{try{return String(localStorage.getItem(userKey(t,"checkout_selected_address_id_v1"))||"").trim()}catch{return""}})(),n=r.some(a=>String(a?.id)===String(o))?o:i||"",u=r.slice().sort((a,s)=>{const c=String(a?.id)===String(i),l=String(s?.id)===String(i);return c&&!l?-1:!c&&l?1:String(a?.label||"").localeCompare(String(s?.label||""))});if(savedAddressSelect.innerHTML=['<option value="">Manual entry</option>',...u.map(a=>{const s=String(a?.label||"Address"),c=String(a?.id)===String(i)?" (default)":"";return`<option value="${String(a?.id||"")}">${s}${c}</option>`})].join(""),savedAddressHint&&(savedAddressHint.textContent=i?"Tip: default address auto-fills when this form is empty.":""),n&&(savedAddressSelect.value=String(n),isAddressBlank())){const a=r.find(s=>String(s?.id)===String(n));a&&applySavedAddress(a)}savedAddressSelect.addEventListener("change",()=>{const a=String(savedAddressSelect.value||"").trim();if(!a)return;const s=r.find(c=>String(c?.id)===String(a));s&&applySavedAddress(s);try{localStorage.setItem(userKey(t,"checkout_selected_address_id_v1"),a)}catch{}})}function drawSummary(){const t=PPS.getCart();if(t.length===0){const s=window.PPS_I18N?.t("checkout.summary.empty")||"Your cart is empty.";summary.innerHTML=`<div style="color:var(--muted)">${s}</div>`,subtotalEl.textContent=PPS.money(0),taxAmountEl.textContent=PPS.money(0),qstRowEl&&(qstRowEl.style.display="none"),shippingLabelEl&&(shippingLabelEl.textContent="Shipping"),shippingAmountEl&&(shippingAmountEl.textContent=PPS.money(0)),totalEl.textContent=PPS.money(0),savingsRowEl&&(savingsRowEl.style.display="none"),setPending(payBtn,!0),setPending(submitBtn,!0);return}const e=PPS.getCurrency(),r=t.reduce((s,c)=>{const h=productMap?.get(c.id)?.priceCents??c.priceCentsBase??c.priceCents??0,p=getUnitBasePrice(c),y=getUnitCurrency(c),f=Math.max(0,h-p)*c.qty;return s+PPS.convertCents(f,y,e)},0),i=t.reduce((s,c)=>{const h=getUnitBasePrice(c)*c.qty,p=getUnitCurrency(c);return s+PPS.convertCents(h,p,e)},0),o=provinceSelect?.value||"",n=calculateTax(i,o),u=getShippingForPostal(postalInput?.value),a=PPS.convertCents(u.amountCents,"CAD",e);summary.innerHTML=t.map(s=>{const c=window.PPS_I18N?.getLang?.()||"en",l=productMap?.get(s.id),h=c==="fr"?s.description_fr||s.description||l?.description_fr||l?.description||"":c==="ko"?s.description_ko||s.description||l?.description_ko||l?.description||"":c==="hi"?s.description_hi||s.description||l?.description_hi||l?.description||"":c==="ta"?s.description_ta||s.description||l?.description_ta||l?.description||"":c==="es"?window.PPS_I18N?.autoTranslate?.(s.description_es||s.description||l?.description_es||l?.description||"","es")||s.description_es||s.description||l?.description_es||l?.description||"":s.description||s.description_fr||s.description_ko||s.description_hi||s.description_ta||s.description_es||l?.description||l?.description_fr||l?.description_ko||l?.description_hi||l?.description_ta||l?.description_es||"",p=h?`<div style="color:var(--muted); font-size:12px; margin-top:4px;">${h}</div>`:"",f=getUnitBasePrice(s)*s.qty,m=getUnitCurrency(s),C=PPS.convertCents(f,m,e),S=s.name||l?.name||"Item";return`
      <div style="display:flex; justify-content:space-between; gap:10px;">
        <div>
          <div>${c==="es"&&window.PPS_I18N?.autoTranslate?.(S||"","es")||S} <span style="color:var(--muted)">x${s.qty}</span></div>
          ${p}
        </div>
        <div style="font-weight:800">${PPS.money(C,e,e)}</div>
      </div>
    `}).join(""),subtotalEl.textContent=PPS.money(i,e,e),o==="QC"?(taxLabelEl.textContent=`${n.taxLabel} - ${provinceName(o)}`,taxAmountEl.textContent=PPS.money(n.gstAmount,e,e),qstRowEl&&(qstRowEl.style.display="flex"),qstLabelEl&&(qstLabelEl.textContent=`${n.qstLabel} - ${provinceName(o)}`),qstAmountEl&&(qstAmountEl.textContent=PPS.money(n.qstAmount,e,e))):(taxLabelEl.textContent=`${n.taxLabel}${o?` - ${provinceName(o)}`:""}`,taxAmountEl.textContent=PPS.money(n.taxAmount,e,e),qstRowEl&&(qstRowEl.style.display="none")),shippingLabelEl&&(shippingLabelEl.textContent=u.label),shippingAmountEl&&(shippingAmountEl.textContent=u.displayAmount?u.displayAmount:PPS.money(a,e,e)),totalEl.textContent=PPS.money(n.total+a,e,e),savingsRowEl&&savingsAmountEl&&(r>0?(savingsAmountEl.textContent=PPS.money(r,e,e),savingsRowEl.style.display="flex"):savingsRowEl.style.display="none"),setPending(payBtn,!1),setPending(submitBtn,!1)}applyProvinceLabels(),initSavedAddressPicker(),drawSummary(),productsPromise.then(()=>{try{const t=PPS.getCart();if(!t.length||!productMap)return;let e=!1;const r=t.map(i=>{if(!i||!i.id)return i;const o=productMap.get(i.id);if(!o)return i;const n={...i};return n.name||(n.name=o.name||n.name,e=!0),Number(n.priceCents)||(n.priceCents=Number(o.priceCents||0),e=!0),Number(n.priceCentsBase)||(n.priceCentsBase=Number(o.priceCents||0),e=!0),n.currency||(n.currency=o.currency||"CAD",e=!0),n.currencyBase||(n.currencyBase=o.currency||"CAD",e=!0),n.description||(n.description=o.description||"",e=!0),n.description_fr||(n.description_fr=o.description_fr||"",e=!0),n.description_ko||(n.description_ko=o.description_ko||"",e=!0),n.description_hi||(n.description_hi=o.description_hi||"",e=!0),n.description_ta||(n.description_ta=o.description_ta||"",e=!0),n.description_es||(n.description_es=o.description_es||"",e=!0),n});e&&PPS.setCart(r)}catch{}finally{drawSummary()}});function setStatus(t,e,r="muted"){t&&(t.textContent=e||"",t.classList.remove("error","success","muted"),t.classList.add(r||"muted","status"))}formEl.addEventListener("submit",async t=>{t.preventDefault();const e=PPS.getCart();if(e.length===0)return;if(!formEl.checkValidity()){formEl.reportValidity(),setStatus(msg,window.PPS_I18N?.t("checkout.status.required")||"Please fill all required fields.","error");return}setStatus(msg,window.PPS_I18N?.t("checkout.status.submitting")||"Submitting order...","muted"),setPending(submitBtn,!0,window.PPS_I18N?.t("checkout.status.submitting_btn")||"Submitting..."),setPending(payBtn,!0);const r=t.target,i={name:r.name.value.trim(),email:r.email.value.trim(),phone:r.phone.value.trim(),address1:r.address1.value.trim(),address2:r.address2.value.trim(),city:r.city.value.trim(),postal:r.postal?.value?.trim()||"",province:provinceSelect.value,deliveryNotes:r.deliveryNotes?.value?.trim()||"",language:window.PPS_I18N?.getLang?.()||"en"},o=getSessionEmail(),n=PPS.getCurrency(),u=e.reduce((p,y)=>{const m=getUnitBasePrice(y)*y.qty,C=getUnitCurrency(y);return p+PPS.convertCents(m,C,n)},0),a=calculateTax(u,provinceSelect.value),s=getShippingForPostal(postalInput?.value),c=PPS.convertCents(s.amountCents,"CAD",n),l=a.total+c,h=e.map(p=>{const y=productMap?.get(p.id),f=getUnitBasePrice(p),m=getUnitCurrency(p);return{...p,description:p.description||y?.description||"",description_fr:p.description_fr||y?.description_fr||"",description_ko:p.description_ko||y?.description_ko||"",description_hi:p.description_hi||y?.description_hi||"",description_ta:p.description_ta||y?.description_ta||"",description_es:p.description_es||y?.description_es||"",priceCentsBase:f,currencyBase:m,priceCents:PPS.convertCents(f,m,n),currency:n}});try{const p=new AbortController,y=setTimeout(()=>p.abort(),45e3),f=await fetch(`${PPS.API_BASE}/api/order`,{method:"POST",headers:{"Content-Type":"application/json"},signal:p.signal,body:JSON.stringify({customer:i,items:h,totalCents:l,currency:n,paymentMethod:"pay_later",shipping:{zone:s.zone,label:s.label,costCents:c}})});clearTimeout(y);const m=await f.json().catch(()=>({}));if(!f.ok||!m.ok){setStatus(msg,m?.message||window.PPS_I18N?.t("checkout.status.failed")||"Order failed. Check backend is running.","error");return}localStorage.removeItem("pps_cart");try{const S=o?`pps_last_order_${o}`:"pps_last_order_guest";localStorage.setItem(S,JSON.stringify({items:e.map(d=>({id:d.id,name:d.name,priceCents:d.priceCents,currency:d.currency,qty:d.qty,description:d.description||"",description_fr:d.description_fr||"",description_ko:d.description_ko||"",description_hi:d.description_hi||"",description_ta:d.description_ta||"",description_es:d.description_es||""})),placedAt:new Date().toISOString()}))}catch{}try{o&&window.PPS_ACTIVITY?.record?.("order_placed",{orderId:m?.orderId||"",totalCents:l,currency:n})}catch{}const C=m?.orderId?`?orderId=${encodeURIComponent(m.orderId)}`:"";window.location.href=`./thank-you.html${C}`}catch(p){p&&p.name==="AbortError"?setStatus(msg,"Request timed out. Please try again (Render may be waking up).","error"):setStatus(msg,window.PPS_I18N?.t("checkout.status.unreachable")||"Server unreachable. Please try again.","error")}finally{setPending(submitBtn,!1),setPending(payBtn,!1)}}),document.getElementById("payOnline").addEventListener("click",async()=>{const t=PPS.getCart();if(t.length!==0){if(!formEl.checkValidity()){formEl.reportValidity(),setStatus(msg,window.PPS_I18N?.t("checkout.status.required_province")||"Please fill all required fields including province.","error");return}setStatus(msg,window.PPS_I18N?.t("checkout.status.redirect")||"Redirecting to Square...","muted"),setPending(payBtn,!0,window.PPS_I18N?.t("checkout.status.redirect_btn")||"Redirecting..."),setPending(submitBtn,!0);try{let y=function(){return String(window.API_BASE_URL||window.PPS_API_BASE||PPS.API_BASE||"").trim().replace(/\/+$/,"").replace(/\/api$/i,"")||String(PPS.API_BASE||"").trim().replace(/\/+$/,"").replace(/\/api$/i,"")};var e=y;const r={name:formEl.name.value.trim(),email:formEl.email.value.trim(),phone:formEl.phone.value.trim(),address1:formEl.address1.value.trim(),address2:formEl.address2.value.trim(),city:formEl.city.value.trim(),postal:formEl.postal?.value?.trim()||"",province:provinceSelect.value,deliveryNotes:formEl.deliveryNotes?.value?.trim()||"",language:window.PPS_I18N?.getLang?.()||"en"},i=provinceSelect.value,o=PPS.getCurrency(),n=t.reduce((d,g)=>{const P=getUnitBasePrice(g)*g.qty,v=getUnitCurrency(g);return d+PPS.convertCents(P,v,o)},0),u=calculateTax(n,i),a=getShippingForPostal(postalInput?.value),s=PPS.convertCents(a.amountCents,"CAD",o),c=u.taxAmount>0?[{id:"tax",name:`${u.taxLabel} (${provinceName(i)})`,priceCents:u.taxAmount,currency:o,qty:1}]:[],l=s>0?[{id:"shipping",name:a.label,priceCents:s,currency:o,qty:1}]:[],p=[...t.map(d=>{const g=productMap?.get(d.id),_=getUnitBasePrice(d),P=getUnitCurrency(d);return{...d,description:d.description||g?.description||"",description_fr:d.description_fr||g?.description_fr||"",description_ko:d.description_ko||g?.description_ko||"",description_hi:d.description_hi||g?.description_hi||"",description_ta:d.description_ta||g?.description_ta||"",description_es:d.description_es||g?.description_es||"",priceCentsBase:_,currencyBase:P,priceCents:PPS.convertCents(_,P,o),currency:o}}),...c,...l];async function f(){const d=y(),g=[`${d}/api/create-payment`,`${d}/create-payment`,`${d}/pi/create-payment`],_=JSON.stringify({items:p,customer:r});let P=null;for(const b of g)try{const w=new AbortController,I=setTimeout(()=>w.abort(),2e4),N=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:_,signal:w.signal});if(clearTimeout(I),N.status!==404)return{res:N,url:b}}catch(w){P=w}if(P)throw P;const v=new Error("Payment service not found.");throw v.code="PPS_NOT_FOUND",v}const{res:m,url:C}=await f(),S=await m.json().catch(()=>({}));if(m.ok&&S?.url)window.location.href=S.url;else{const d=m.status===404||m.status===405,g=d?`Payment service not found. Check \`frontend/config.js\` API_BASE_URL points to your backend. Tried: ${C||""}`:window.PPS_I18N?.t("checkout.status.square")||"Square not configured.",_=String(S?.message||"").trim(),P=m.status===401||m.status===403,v=m.status>=500;if(!d&&(P||v)){console.error("Square create-payment failed",{status:m.status,url:C,data:S});const b=window.PPS_I18N?.t("checkout.status.payment_unavailable")||"Online payment is temporarily unavailable. Please try again later or use Pay later.";setStatus(msg,b,"error")}else setStatus(msg,_||g,"error")}}catch(r){const i=r?.name==="AbortError"?"Square request timed out. Please try again.":window.PPS_I18N?.t("checkout.status.unreachable")||"Server unreachable. Please try again.";setStatus(msg,i,"error")}finally{setPending(payBtn,!1),setPending(submitBtn,!1)}}}),provinceSelect&&provinceSelect.addEventListener("change",drawSummary),postalInput&&(postalInput.addEventListener("input",drawSummary),postalInput.addEventListener("change",drawSummary));
