(()=>{"use strict";const w="activity_v1",_="last_ip_v1",L={login:"Login",logout:"Logout",password_change:"Password change",profile_update:"Profile update",settings_update:"Settings update",order_placed:"Order placed",reward_redeemed:"Reward redeemed",reward_used:"Reward used",address_saved:"Address saved",payment_saved:"Payment saved"},a=e=>String(e||"").trim().toLowerCase(),S=()=>new Date().toISOString(),u=(e,t)=>`pps_account_${a(e)}_${t}`,A=(e,t)=>{try{const n=localStorage.getItem(e);return n?JSON.parse(n):t}catch{return t}},I=(e,t)=>{try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch{return!1}},c=()=>{try{return window.PPS?.getSession?.()||null}catch{return null}},v=e=>{const t=A(u(e,w),[]);return Array.isArray(t)?t:[]},E=(e,t)=>{const n=(Array.isArray(t)?t:[]).filter(Boolean).slice(0,200);return I(u(e,w),n),F(e),n},p=e=>{const t=A(u(e,_),{ip:"",forwardedFor:"",updatedAt:""});return{ip:String(t?.ip||""),forwardedFor:String(t?.forwardedFor||""),updatedAt:String(t?.updatedAt||"")}},b=(e,t)=>{const n={ip:String(t?.ip||"").trim(),forwardedFor:String(t?.forwardedFor||"").trim(),updatedAt:S()};return I(u(e,_),n),n},F=e=>{window.dispatchEvent(new CustomEvent("pps:activity",{detail:{email:a(e)}}))},y=async e=>{const t=a(e);if(!t)return null;const n=p(t);if(n.updatedAt){const r=Date.now()-new Date(n.updatedAt).getTime();if(Number.isFinite(r)&&r>=0&&r<600*1e3)return n}try{const r=String(window.PPS?.API_BASE||"").trim().replace(/\/+$/,"");if(!r)return n;const i=await fetch(`${r}/api/account/ip`,{cache:"no-store"}),s=await i.json().catch(()=>({}));return!i.ok||!s.ok?n:b(t,{ip:s.ip,forwardedFor:s.forwardedFor})}catch{return n}},B=async(e,t={})=>{const n=c(),r=a(n?.email);if(!r)return null;p(r).ip?y(r):await Promise.race([y(r),new Promise(f=>setTimeout(f,600))]);const s=p(r),l={id:`act_${Date.now()}_${Math.random().toString(16).slice(2)}`,type:String(e||"activity"),label:L[String(e||"")]||String(e||"Activity"),createdAt:S(),ip:s.ip||"",meta:t&&typeof t=="object"?t:{}},g=v(r);return E(r,[l,...g]),l},h=e=>E(e,[]),C=e=>{try{const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}catch{return""}},m=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),M=e=>{const t=e?.meta||{};return e?.type==="order_placed"&&t.orderId?`Order ${t.orderId}`:e?.type==="reward_redeemed"&&t.title?String(t.title):e?.type==="reward_used"&&t.code?`Code ${t.code}`:e?.type==="settings_update"?"Preferences updated":e?.type==="address_saved"?t.label?`Address: ${t.label}`:"Address saved":e?.type==="payment_saved"?t.label?`Payment: ${t.label}`:"Payment saved":e?.type==="profile_update"?"Profile updated":e?.type==="password_change"?"Password updated":""},d=()=>{const e=c(),t=a(e?.email);if(!t)return;const n=document.getElementById("activityList"),r=document.getElementById("activityMsg"),i=document.getElementById("activityType"),s=document.getElementById("activityIpHint");if(!n)return;const l=v(t),g=String(i?.value||""),f=g?l.filter(o=>String(o?.type||"")===g):l,P=p(t);s&&(s.textContent=P.ip?`Last seen IP (by backend): ${P.ip}`:"IP address is shown when available."),r&&(r.textContent=f.length?"":"No account activity recorded yet on this device."),n.innerHTML=f.slice(0,80).map(o=>{const O=C(o.createdAt),T=M(o),$=String(o.ip||"");return`
          <div class="activity-item">
            <div class="activity-top">
              <div style="font-weight:1000;">${m(o.label||o.type||"Activity")}</div>
              <div class="activity-time">${m(O)}</div>
            </div>
            <div class="activity-sub">
              ${T?`<span>${m(T)}</span>`:"<span></span>"}
              <span>${$?`IP: ${m($)}`:""}</span>
            </div>
          </div>
        `}).join("")},N=()=>{if(window.__pps_activity_inited||!document.getElementById("activityList"))return;window.__pps_activity_inited=!0;const t=c(),n=a(t?.email);n&&y(n),document.getElementById("activityType")?.addEventListener("change",d),document.getElementById("activityClear")?.addEventListener("click",()=>{const r=c(),i=a(r?.email);i&&(h(i),d())}),window.addEventListener("pps:activity",r=>{const i=a(r?.detail?.email);if(!i)return;const s=a(c()?.email);i===s&&d()}),d()};window.PPS_ACTIVITY={record:B,getActivity:v,clear:h,prefetchIp:y,initAccountActivity:N,renderAccountActivity:d}})();
