(()=>{"use strict";const N=window.PPS?.getSession?.();if(!N){window.location.href="./login.html";return}const v=t=>document.querySelector(t),O=t=>Array.from(document.querySelectorAll(t)),u={orders:[],products:[],productsById:new Map,templateEditingId:"",profileEditing:!1},n={year:v("#y"),accountMsg:v("#accountMsg"),ordersGrid:v("#ordersGrid"),ordersMsg:v("#ordersMsg"),invoicesList:v("#invoicesList"),invoicesMsg:v("#invoicesMsg"),favoritesGrid:v("#favoritesGrid"),favoritesMsg:v("#favoritesMsg"),favoritesSuggestions:v("#favoritesSuggestions"),frequentGrid:v("#frequentGrid"),frequentMsg:v("#frequentMsg"),profileGrid:v("#profileGrid"),profileActions:v("#profileActions"),nameEl:v("#accountName"),badgeEl:v("#accountBadge"),dashboardBadge:v("#dashboardBadge"),provinceEl:v("#accountProvince"),logoutBtn:v("#logoutBtn"),dashboardStats:v("#dashboardStats"),dashboardSub:v("#dashboardSub"),dashboardInsights:v("#dashboardInsights"),ordersCountBadge:v("#ordersCountBadge"),invoicesCountBadge:v("#invoicesCountBadge"),favoritesCountBadge:v("#favoritesCountBadge"),ordersUpdatedAt:v("#ordersUpdatedAt"),orderRecsGrid:v("#orderRecsGrid"),orderRecsMsg:v("#orderRecsMsg"),businessForm:v("#businessForm"),businessMsg:v("#businessMsg"),downloadStatement:v("#downloadStatement"),orderSearch:v("#orderSearch"),orderStatus:v("#orderStatus"),orderRange:v("#orderRange"),exportOrdersBtn:v("#exportOrders"),invoiceSearch:v("#invoiceSearch"),invoiceStatus:v("#invoiceStatus"),invoiceFrom:v("#invoiceFrom"),invoiceTo:v("#invoiceTo"),downloadInvoicesRangeBtn:v("#downloadInvoicesRange"),addressesGrid:v("#addressesGrid"),addAddressForm:v("#addAddressForm"),paymentGrid:v("#paymentGrid"),addPaymentForm:v("#addPaymentForm"),rewardsBody:v("#rewardsBody"),milestonesBody:v("#milestonesBody"),analyticsBody:v("#analyticsBody"),reportsBody:v("#reportsBody"),settingsForm:v("#settingsForm"),notifCountBadge:v("#notifCountBadge"),milestonesPrefsForm:v("#milestonesPrefsForm"),templateName:v("#templateName"),templateSaveFromCart:v("#templateSaveFromCart"),templatesMsg:v("#templatesMsg"),templatesList:v("#templatesList"),combosMsg:v("#combosMsg"),combosGrid:v("#combosGrid"),businessTierForm:v("#businessTierForm"),businessTierOutput:v("#businessTierOutput"),rfqForm:v("#rfqForm"),rfqOutput:v("#rfqOutput"),netTermsForm:v("#netTermsForm"),netTermsOutput:v("#netTermsOutput"),poUploadForm:v("#poUploadForm"),poUploadOutput:v("#poUploadOutput"),approvalForm:v("#approvalForm"),approvalList:v("#approvalList"),bulkTemplateForm:v("#bulkTemplateForm"),bulkTemplateList:v("#bulkTemplateList"),csvUploadForm:v("#csvUploadForm"),csvUploadOutput:v("#csvUploadOutput"),repAssignForm:v("#repAssignForm"),repAssignOutput:v("#repAssignOutput"),creditAppForm:v("#creditAppForm"),creditAppOutput:v("#creditAppOutput")};n.year&&(n.year.textContent=String(new Date().getFullYear())),window.PPS?.updateCartBadge?.();try{window.PPS_NOTIFS?.initAccountCenter?.(),window.PPS_ACTIVITY?.initAccountActivity?.(),window.PPS_WISHLISTS?.init?.(),window.PPS_PAYMENT_METHODS?.init?.()}catch{}const A=t=>{t&&n.accountMsg&&(n.accountMsg.textContent=String(t))},o=t=>String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),ht=t=>String(t||"").trim().split(/\s+/)[0]||"",P=(t,e)=>window.PPS?.money?.(Number(t)||0,e||"CAD")||"",y=(t,e)=>window.PPS_I18N?.t?.(t)||e||"",E=t=>{try{const e=new Date(t);return Number.isNaN(e.getTime())?"":e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch{return""}},Z=t=>{try{const e=new Date(t);return Number.isNaN(e.getTime())?"":e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}catch{return""}},st=t=>({ON:"Ontario",NS:"Nova Scotia",NB:"New Brunswick",NL:"Newfoundland and Labrador",PE:"Prince Edward Island",AB:"Alberta",BC:"British Columbia",SK:"Saskatchewan",MB:"Manitoba",QC:"Quebec",YT:"Yukon",NT:"Northwest Territories",NU:"Nunavut"})[t]||t||"",j=t=>{const e=String(t||"").toLowerCase().trim();return e?["paid","fulfilled"].includes(e)?"fulfilled":e==="processing"?"processing":e==="shipped"?"shipped":e==="delivered"?"delivered":["cancelled","canceled"].includes(e)?"cancelled":e:"pending"},Y=t=>{const e=j(t);return{pending:"Pending",processing:"Processing",shipped:"Shipped",delivered:"Delivered",fulfilled:"Fulfilled",cancelled:"Cancelled"}[e]||e},T=t=>`pps_account_${String(N.email||"").trim().toLowerCase()}_${t}`,F=(t,e)=>{try{const r=localStorage.getItem(t);return r?JSON.parse(r):e}catch{return e}},k=(t,e)=>{try{localStorage.setItem(t,JSON.stringify(e))}catch{}},it=T("default_address_id_v1"),ot=()=>{try{return String(localStorage.getItem(it)||"").trim()}catch{return""}},tt=t=>{try{const e=String(t||"").trim();e?localStorage.setItem(it,e):localStorage.removeItem(it)}catch{}},wt=t=>{const e=Array.isArray(t)?t:[],r=ot();if(r&&e.some(i=>String(i?.id)===String(r)))return r;const s=e[0]?.id?String(e[0].id):"";return s&&tt(s),s},St=T("rewards_ledger_v1"),$t=T("milestones_prefs_v1"),xt=()=>({showMilestones:F($t,{showMilestones:!0})?.showMilestones!==!1}),ne=t=>{const e={showMilestones:t?.showMilestones!==!1};return k($t,e),e},At=()=>{const t=F(St,{redemptions:[]});return{redemptions:Array.isArray(t?.redemptions)?t.redemptions:[]}},Ct=t=>{const e={redemptions:Array.isArray(t?.redemptions)?t.redemptions.filter(Boolean).slice(0,200):[]};return k(St,e),e},re=t=>Math.max(0,Math.floor((Number(t)||0)/100)),Mt=()=>{const t=u.orders.reduce((a,d)=>a+Number(d.totalCents||0),0),e=re(t),r=At(),s=r.redemptions.reduce((a,d)=>a+(Number(d?.pointsCost)||0),0),i=Math.max(0,e-s);return{earned:e,redeemed:s,balance:i,ledger:r}},K=t=>(Number(t)||0).toLocaleString(),se=()=>`PPS-${Math.random().toString(16).slice(2,6).toUpperCase()}-${Date.now().toString().slice(-6)}`,Tt=()=>{const t=window.location.hash||"#dashboard";O(".account-nav a").forEach(e=>e.classList.toggle("active",e.getAttribute("href")===t))},at=t=>(t?.items||[]).reduce((e,r)=>{const s=Number(r.priceCentsBase??r.priceCents??0),i=Number(r.priceCents??0),a=Math.max(0,s-i);return e+a*(Number(r.qty)||0)},0),dt=1440*60*1e3,ie=t=>{const e=new Date(t).getTime();return Number.isFinite(e)?Math.floor(e/dt):null},oe=t=>{const e=(Array.isArray(t)?t:[]).map(r=>Number(r)||0).filter(r=>r>0).sort((r,s)=>r-s);return e.length&&e[Math.floor(e.length/2)]||null},ae=t=>{const e=(Array.isArray(t)?t:[]).map(r=>Number(r)||0).filter(r=>Number.isFinite(r)&&r>0);return e.length?e.reduce((r,s)=>r+s,0)/e.length:null},de=({avgIntervalDays:t,daysUntilNext:e})=>{const r=Math.max(1,Math.round(Number(t)||0));if(!Number.isFinite(e))return"";const s=Math.round(e);return s<=0?`You typically order every ${r} days \u2014 order now?`:s===1?"Based on your pattern, you'll need to reorder in 1 day.":`Based on your pattern, you'll need to reorder in ${s} days.`},W=()=>{const t=new Map,e=Math.floor(Date.now()/dt);u.orders.forEach(a=>{const d=ie(a?.createdAt);(a.items||[]).forEach(m=>{const c=String(m.id||"");if(!c)return;const p=Math.max(0,Number(m.qty)||0),l=t.get(c)||{count:0,qtySum:0,qtyCount:0,days:[]};l.count+=1,p>0&&(l.qtySum+=p,l.qtyCount+=1),d!==null&&l.days.push(d),t.set(c,l)})});const r=Array.from(t.entries()).map(([a,d])=>{const m=Array.from(new Set(d.days)).sort((w,M)=>M-w),c=[];for(let w=0;w+1<m.length;w++){const M=m[w]-m[w+1];M>0&&c.push(M)}const p=ae(c),l=p?Math.max(1,Math.round(p)):null,g=m.length?m[0]:null,f=g===null?null:Math.max(0,e-g),h=l&&f!==null?Math.round(l-f):null,$=d.qtyCount?d.qtySum/d.qtyCount:null,C=$?Math.max(1,Math.round($)):1;return{id:a,count:d.count,product:u.productsById.get(a),avgQty:C,medianQty:oe(u.orders.flatMap(w=>(w.items||[]).filter(M=>String(M.id)===String(a)).map(M=>Number(M.qty)||0)))||1,avgIntervalDays:l,daysUntilNext:h,prediction:de({avgIntervalDays:l,daysUntilNext:h})}}),s="Garment Cover Bags 21x6x42 Extra Heavy",i=a=>String(a?.product?.name||"").toLowerCase()===s.toLowerCase();return r.filter(a=>a.product).sort((a,d)=>i(a)&&!i(d)?-1:!i(a)&&i(d)?1:(d.count||0)-(a.count||0))},Ft="order_templates_v1",Nt=T("subscriptions_v1"),Pt=T("business_profile_v1"),kt=T("business_tier_v1"),It=T("business_rfq_v1"),Lt=T("business_net_terms_v1"),Et=T("business_po_v1"),ct=T("business_approvals_v1"),lt=T("business_bulk_templates_v1"),qt=T("business_csv_upload_v1"),Bt=T("business_rep_v1"),_t=T("business_credit_app_v1"),Q=()=>{const t=T(Ft),e=F(t,{templates:[]});return(Array.isArray(e?.templates)?e.templates:[]).filter(s=>s&&s.id&&Array.isArray(s.items)&&s.items.length).map(s=>({id:String(s.id),name:String(s.name||"Template").trim()||"Template",createdAt:String(s.createdAt||""),updatedAt:String(s.updatedAt||""),items:s.items.map(i=>({id:String(i?.id||""),name:String(i?.name||""),qty:Math.max(1,Math.round(Number(i?.qty)||1))})).filter(i=>i.id)}))},ut=t=>{const e=T(Ft),r=Array.isArray(t)?t.slice(0,50):[];k(e,{templates:r})},ce=t=>`${t}_${Date.now()}_${Math.random().toString(16).slice(2)}`,Dt=t=>(Array.isArray(t)?t:[]).map(e=>({id:String(e?.id||e?.productId||""),name:String(e?.name||""),qty:Math.max(1,Math.round(Number(e?.qty)||1))})).filter(e=>e.id).slice(0,40),Ot=()=>{const t=F(Nt,{items:[]});return Array.isArray(t?.items)?t.items:[]},Rt=t=>{k(Nt,{items:Array.isArray(t)?t.slice(0,50):[]})},le=t=>Ot().find(r=>String(r.id)===String(t))||null,ue=(t,e)=>{const r=Ot();if(r.find(a=>String(a.id)===String(t)))return Rt(r.filter(a=>String(a.id)!==String(t))),null;const i={id:String(t),cadenceDays:Math.max(7,Math.round(Number(e)||30)),nextDate:new Date(Date.now()+Math.max(7,Math.round(Number(e)||30))*dt).toISOString()};return r.unshift(i),Rt(r),i},mt=()=>{const t=new Map;return u.orders.forEach(r=>{const i=(Array.isArray(r?.items)?r.items:[]).map(p=>({id:String(p?.id||""),qty:Math.max(1,Math.round(Number(p?.qty)||1))})).filter(p=>p.id);if(i.length<2)return;const d=Array.from(new Set(i.map(p=>p.id))).sort().join("|");if(!d)return;const m=t.get(d)||{sig:d,count:0,lastAt:"",qtyById:new Map};m.count+=1;const c=String(r?.createdAt||"");(!m.lastAt||new Date(c)>new Date(m.lastAt))&&(m.lastAt=c),i.forEach(p=>{const l=m.qtyById.get(p.id)||[];l.push(p.qty),m.qtyById.set(p.id,l)}),t.set(d,m)}),Array.from(t.values()).filter(r=>r.count>=2).map(r=>{const s=Array.from(r.qtyById.entries()).map(([d,m])=>{const c=u.productsById.get(String(d))||null,p=c?.name||u.orders.flatMap(g=>g.items||[]).find(g=>String(g.id)===String(d))?.name||"Item";m.sort((g,f)=>g-f);const l=m[Math.floor(m.length/2)]||1;return{id:d,name:p,qty:Math.max(1,Math.round(Number(l)||1)),product:c}}).sort((d,m)=>(m.qty||0)-(d.qty||0)),i=s.slice(0,2).map(d=>`${d.qty}x ${d.name}`),a=i.length?`Your usual: ${i.join(" + ")}`:"Your usual";return{sig:r.sig,count:r.count,lastAt:r.lastAt,title:a,items:s}}).sort((r,s)=>(s.count||0)!==(r.count||0)?(s.count||0)-(r.count||0):new Date(s.lastAt||0)-new Date(r.lastAt||0)).slice(0,6)},Ut=t=>{const e=Dt(t);if(!e.length)return;const r=e.map(s=>{const i=u.productsById.get(String(s.id))||{};return{id:s.id,name:s.name||i.name||"Item",qty:s.qty,priceCents:Number(i.priceCents||0),currency:i.currency||"CAD",description:i.description||""}}).filter(s=>s.id);window.PPS?.addItemsToCart?.(r),window.PPS?.updateCartBadge?.(),A(y("account.toast.added_to_cart","Added to cart."))},Ht=({name:t,items:e})=>{const s=String(t||"").trim()||"Order template",i=Dt(e);if(!i.length){A(y("account.templates.empty","Template is empty."));return}const a=new Date().toISOString(),d=Q();d.unshift({id:ce("tpl"),name:s,createdAt:a,updatedAt:a,items:i}),ut(d),H(),A(y("account.templates.saved","Template saved."))};function H(){if(!n.templatesList||!n.templatesMsg)return;const t=y("account.reorder","Reorder"),e=y("common.rename","Rename"),r=y("common.delete","Delete"),s=y("common.save","Save"),i=y("common.cancel","Cancel"),a=Q();if(!a.length){n.templatesMsg.textContent=y("account.templates.none","No templates yet. Save your cart or a usual combo."),n.templatesList.innerHTML="";return}n.templatesMsg.textContent="",n.templatesList.innerHTML=a.slice(0,9).map(d=>{const m=String(u.templateEditingId||"")===String(d.id),c=d.items.slice(0,4).map(l=>`<div style="color:var(--muted); font-size:13px;">${o(l.qty)}x ${o(l.name||"Item")}</div>`).join(""),p=Math.max(0,d.items.length-4);return`
          <div class="card fade-in" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div>
                ${m?`<input class="input" data-template-edit-name="${o(d.id)}" value="${o(d.name)}" style="max-width:260px;">`:`<div style="font-weight:1000;">${o(d.name)}</div>`}
                <div style="color:var(--muted); font-size:12px; margin-top:4px;">${d.items.length} item${d.items.length===1?"":"s"}</div>
              </div>
              <button class="btn btn-primary btn-sm" type="button" data-template-reorder="${o(d.id)}">${o(t)}</button>
            </div>
            <div style="margin-top:10px;">${c}${p?`<div style="color:var(--muted); font-size:12px; margin-top:4px;">+${p} more</div>`:""}</div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              ${m?`<button class="btn btn-outline btn-sm" type="button" data-template-rename-save="${o(d.id)}">${o(s)}</button>
                     <button class="btn btn-outline btn-sm" type="button" data-template-rename-cancel>${o(i)}</button>`:`<button class="btn btn-outline btn-sm" type="button" data-template-rename="${o(d.id)}">${o(e)}</button>`}
              <button class="btn btn-outline btn-sm" type="button" data-template-delete="${o(d.id)}">${o(r)}</button>
            </div>
          </div>
        `}).join(""),O(".fade-in").forEach(d=>d.classList.add("show"))}function jt(){if(!n.combosGrid||!n.combosMsg)return;if(!u.orders.length){n.combosMsg.textContent=y("account.combos.empty","Place a couple of orders and your usual combinations will show here."),n.combosGrid.innerHTML="";return}const t=mt().slice(0,3);if(!t.length){n.combosMsg.textContent=y("account.combos.none","No repeated combinations found yet. Reorder a previous order to build your usuals."),n.combosGrid.innerHTML="";return}const e=y("account.combos.reorder","Reorder combo"),r=y("account.combos.save_template","Save as template");n.combosMsg.textContent="",n.combosGrid.innerHTML=t.map(s=>{const i=s.items.slice(0,4).map(c=>`<div style="color:var(--muted); font-size:13px;">${o(c.qty)}x ${o(c.name)}</div>`).join(""),a=Math.max(0,s.items.length-4),m=y("account.combos.meta","Ordered {{count}} times \xB7 Last: {{date}}").replace("{{count}}",String(s.count)).replace("{{date}}",E(s.lastAt));return`
          <div class="card fade-in" style="padding:14px;">
            <div style="font-weight:1000;">${o(s.title)}</div>
            <div style="color:var(--muted); font-size:12px; margin-top:4px;">${o(m)}</div>
            <div style="margin-top:10px;">${i}${a?`<div style="color:var(--muted); font-size:12px; margin-top:4px;">+${a} more</div>`:""}</div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" type="button" data-combo-reorder="${o(s.sig)}">${o(e)}</button>
              <button class="btn btn-outline btn-sm" type="button" data-combo-save="${o(s.sig)}">${o(r)}</button>
            </div>
          </div>
        `}).join(""),O(".fade-in").forEach(s=>s.classList.add("show"))}const Be=t=>{const e=[];return u.orders.forEach(r=>{(r.items||[]).forEach(s=>{String(s.id)===String(t)&&e.push(Number(s.qty)||1)})}),e.length?(e.sort((r,s)=>r-s),e[Math.floor(e.length/2)]||1):1},me=t=>{const e=window.PPS_I18N?.getLang?.()||"en",r=e==="fr"?t.description_fr||t.description:e==="ko"?t.description_ko||t.description:e==="hi"?t.description_hi||t.description:e==="ta"?t.description_ta||t.description:e==="es"&&t.description_es||t.description;return String(r||"").trim()};function et(){if(!n.rewardsBody)return;const{earned:t,redeemed:e,balance:r,ledger:s}=Mt(),i=r,a=t>=25e3?"Gold":t>=1e4?"Silver":"Bronze",d=a==="Bronze"?"Silver":a==="Silver"?"Gold":null,m=a==="Bronze"?1e4:a==="Silver"?25e3:i,p=d?Math.min(100,Math.round(t/(a==="Bronze"?1e4:a==="Silver"?25e3:i)*100)):100,l=[{id:"disc_5",title:"$5 off your next order",pointsCost:500,valueCents:500,kind:"discount"},{id:"disc_10",title:"$10 off your next order",pointsCost:1e3,valueCents:1e3,kind:"discount"},{id:"disc_25",title:"$25 off your next order",pointsCost:2500,valueCents:2500,kind:"discount"},{id:"free_20",title:"Free product voucher (up to $20)",pointsCost:2e3,valueCents:2e3,kind:"free_product"}],g=(s?.redemptions||[]).filter(f=>f&&!f.usedAt);n.rewardsBody.innerHTML=`
      <div class="insights-grid">
        <div class="insight">
          <div class="insight-title">Points</div>
          <div class="insight-body">${K(i)}</div>
          <div class="insight-sub">${K(t)} earned \xB7 ${K(e)} redeemed</div>
        </div>
        <div class="insight">
          <div class="insight-title">Member tier</div>
          <div class="insight-body">${a}</div>
          <div class="insight-sub">${d?`Progress to ${d}: ${p}%`:"Top tier reached"}</div>
          <div style="margin-top:10px; height:10px; border-radius:999px; background:rgba(17,24,39,.08); overflow:hidden;">
            <div style="height:100%; width:${p}%; background:linear-gradient(90deg, var(--primary), var(--primary-strong));"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:1000;">Rewards catalog</div>
          <div style="color:var(--muted); font-size:13px;">Redeem points for a code you can use at checkout.</div>
        </div>
        <div class="grid grid-3" style="margin-top:10px;">
          ${l.map(f=>{const h=i>=f.pointsCost;return`
                <div class="card" style="padding:14px;">
                  <div style="font-weight:1000;">${o(f.title)}</div>
                  <div style="margin-top:6px; color:var(--muted); font-size:13px;">${K(f.pointsCost)} points</div>
                  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-primary btn-sm" type="button" data-reward-redeem="${o(f.id)}" ${h?"":"disabled"}>${h?"Redeem":"Not enough points"}</button>
                  </div>
                </div>
              `}).join("")}
        </div>
      </div>

      <div style="margin-top:14px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:1000;">Your reward codes</div>
          <div style="color:var(--muted); font-size:13px;">Unused codes: ${K(g.length)}</div>
        </div>
        <div style="margin-top:10px; display:grid; gap:10px;">
          ${g.length?g.slice(0,12).map(f=>{const h=o(f.code||""),$=o(f.title||"Reward"),C=Z(f.createdAt);return`
                      <div class="card" style="padding:14px;">
                        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                          <div>
                            <div style="font-weight:1000;">${$}</div>
                            <div style="color:var(--muted); font-size:13px; margin-top:4px;">Code: <span style="font-weight:900; letter-spacing:.6px;">${h}</span>${C?` \xB7 ${C}`:""}</div>
                          </div>
                          <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <a class="btn btn-primary btn-sm" href="./checkout.html?reward=${encodeURIComponent(f.code||"")}">Use at checkout</a>
                            <button class="btn btn-outline btn-sm" type="button" data-reward-copy="${h}">Copy code</button>
                            <button class="btn btn-outline btn-sm" type="button" data-reward-mark-used="${h}">Mark used</button>
                          </div>
                        </div>
                      </div>
                    `}).join(""):'<div style="color:var(--muted); font-size:13px;">No reward codes yet. Redeem from the catalog above.</div>'}
        </div>
      </div>
    `}function Gt(){if(!n.milestonesPrefsForm)return;const t=xt(),e=n.milestonesPrefsForm.querySelector('[name="showMilestones"]');e&&(e.checked=!!t.showMilestones)}const pe=()=>{const t=u.orders.length,e=u.orders.reduce((c,p)=>c+(p?.items||[]).reduce((l,g)=>l+(Number(g.qty)||0),0),0),r=u.orders.reduce((c,p)=>c+Number(p.totalCents||0),0),s=String(u.orders[0]?.currency||"CAD").toUpperCase(),i=Math.floor(r/100),a=[{id:"loyal_20",title:"Loyal customer",detail:"20 orders placed",metric:{current:t,target:20,unit:"orders"}},{id:"loyal_50",title:"Loyal customer",detail:"50 orders placed",metric:{current:t,target:50,unit:"orders"}},{id:"bulk_500",title:"Bulk buyer",detail:"500+ items ordered",metric:{current:e,target:500,unit:"items"}},{id:"bulk_1000",title:"Bulk buyer",detail:"1,000+ items ordered",metric:{current:e,target:1e3,unit:"items"}},{id:"partner_5000",title:"Trusted partner",detail:`${s} 5,000+ spent`,metric:{current:i,target:5e3,unit:s}},{id:"partner_10000",title:"Trusted partner",detail:`${s} 10,000+ spent`,metric:{current:i,target:1e4,unit:s}}],d=a.filter(c=>(Number(c.metric.current)||0)>=(Number(c.metric.target)||0)),m=a.filter(c=>(Number(c.metric.current)||0)<(Number(c.metric.target)||0));return{ordersCount:t,itemsCount:e,spentCents:r,achieved:d,nextUp:m.slice(0,3)}};function zt(){if(!n.milestonesBody)return;if(!xt().showMilestones){n.milestonesBody.innerHTML=`
        <div class="card" style="padding:14px;">
          <div style="font-weight:1000;">Customer milestones</div>
          <div style="color:var(--muted); font-size:13px; margin-top:6px;">Hidden in your settings.</div>
        </div>
      `;return}if(!u.orders.length){n.milestonesBody.innerHTML=`
        <div class="card" style="padding:14px;">
          <div style="font-weight:1000;">Customer milestones</div>
          <div style="color:var(--muted); font-size:13px; margin-top:6px;">Place your first order to start building your purchase history.</div>
        </div>
      `;return}const{achieved:e,nextUp:r}=pe(),s=a=>`<span class="milestone-pill">${o(a)}</span>`,i=a=>{const d=Math.max(0,Number(a?.current)||0),m=Math.max(1,Number(a?.target)||1);return`
        <div class="milestone-progress">
          <div class="milestone-progress-bar" style="width:${Math.min(100,Math.round(d/m*100))}%;"></div>
        </div>
        <div class="milestone-sub">${d.toLocaleString()} / ${m.toLocaleString()}</div>
      `};n.milestonesBody.innerHTML=`
      <div class="milestones-head">
        <div style="font-weight:1000;">Customer milestones</div>
        <div style="color:var(--muted); font-size:13px;">Based on your orders</div>
      </div>

      ${e.length?`
        <div class="milestone-row" style="margin-top:10px;">
          ${e.slice(0,4).map(a=>s(`${a.title} \xB7 ${a.detail}`)).join("")}
        </div>
      `:`
        <div style="margin-top:10px; color:var(--muted); font-size:13px;">Milestones will appear here as your order history grows.</div>
      `}

      ${r.length?`
        <div style="margin-top:12px;">
          <div style="font-weight:1000;">Next up</div>
          <div class="milestone-grid" style="margin-top:10px;">
            ${r.map(a=>`
              <div class="milestone-card">
                <div style="font-weight:1000;">${o(a.title)}</div>
                <div class="milestone-sub">${o(a.detail)}</div>
                ${i(a.metric)}
              </div>
            `).join("")}
          </div>
        </div>
      `:""}
    `}const Yt=t=>`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`,ve=t=>{const[e,r]=String(t||"").split("-"),s=new Date(Number(e)||0,Math.max(0,(Number(r)||1)-1),1);try{return s.toLocaleDateString(void 0,{month:"short"})}catch{return t}},ge=(t=12)=>{const e=[],r=new Date;for(let s=t-1;s>=0;s--){const i=new Date(r.getFullYear(),r.getMonth()-s,1);e.push(Yt(i))}return e},_e=(t,e,r)=>Math.max(e,Math.min(r,t)),fe=({points:t,labels:e,unitLabel:r=""})=>{const c=Math.max(1,...t.map(w=>Number(w)||0)),p=0,l=w=>28+584*(t.length<=1?0:w/(t.length-1)),g=w=>192-((Number(w)||0)-p)/(c-p)*164,f=t.map((w,M)=>`${l(M).toFixed(1)},${g(w).toFixed(1)}`).join(" "),h=`28,192 ${f} 612,192`,$=e[e.length-1]||"",C=t[t.length-1]||0;return`
      <svg class="chart-svg" viewBox="0 0 640 220" role="img" aria-label="${o(r)} over time">
        <line class="chart-axis" x1="28" y1="192" x2="612" y2="192"></line>
        <path class="chart-area" d="M ${h} Z"></path>
        <polyline class="chart-line" points="${f}"></polyline>
        ${t.map((w,M)=>`<circle class="chart-dot" cx="${l(M).toFixed(1)}" cy="${g(w).toFixed(1)}" r="${M===t.length-1?5:3}"></circle>`).join("")}
        <text class="chart-label" x="28" y="20">${o(r)}</text>
        <text class="chart-label" x="612" y="20" text-anchor="end">${o(String($))}: ${o(String(C))}</text>
        ${e.map((w,M)=>M%2?"":`<text class="chart-label" x="${l(M).toFixed(1)}" y="210" text-anchor="middle">${o(w)}</text>`).join("")}
      </svg>
    `},ye=({values:t,labels:e,unitLabel:r=""})=>{const c=Math.max(1,...t.map(g=>Number(g)||0)),p=584/Math.max(1,t.length),l=g=>192-(Number(g)||0)/c*164;return`
      <svg class="chart-svg" viewBox="0 0 640 220" role="img" aria-label="${o(r)} over time">
        <line class="chart-axis" x1="28" y1="192" x2="612" y2="192"></line>
        ${t.map((g,f)=>{const h=28+f*p+p*.12,$=p*.76,C=l(g),w=192-C;return`<rect x="${h.toFixed(1)}" y="${C.toFixed(1)}" width="${$.toFixed(1)}" height="${w.toFixed(1)}" rx="8" fill="rgba(240,127,41,.25)" stroke="rgba(240,127,41,.35)"></rect>`}).join("")}
        <text class="chart-label" x="28" y="20">${o(r)}</text>
        ${e.map((g,f)=>f%2?"":`<text class="chart-label" x="${(28+f*p+p/2).toFixed(1)}" y="210" text-anchor="middle">${o(g)}</text>`).join("")}
      </svg>
    `},be=({parts:t})=>{const e=t.reduce((c,p)=>c+(Number(p.value)||0),0)||1,r=110,s=110,i=82,a=2*Math.PI*i;let d=0;const m=t.filter(c=>(Number(c.value)||0)>0).map(c=>{const l=(Number(c.value)||0)/e*a,g=`<circle cx="${r}" cy="${s}" r="${i}" fill="transparent" stroke="${c.color}" stroke-width="20" stroke-dasharray="${l.toFixed(2)} ${(a-l).toFixed(2)}" stroke-dashoffset="${(-d).toFixed(2)}"></circle>`;return d+=l,g}).join("");return`
      <svg class="chart-svg" viewBox="0 0 220 220" role="img" aria-label="Product category breakdown">
        <circle cx="${r}" cy="${s}" r="${i}" fill="transparent" stroke="rgba(17,24,39,.08)" stroke-width="20"></circle>
        <g transform="rotate(-90 ${r} ${s})">
          ${m}
        </g>
        <text class="chart-label" x="${r}" y="${s}" text-anchor="middle" dominant-baseline="middle">${Math.round(e).toLocaleString()}</text>
      </svg>
    `};function he(){if(!n.analyticsBody)return;if(!u.orders.length){n.analyticsBody.innerHTML="";return}const t=String(u.orders[0]?.currency||"CAD").toUpperCase(),e=u.orders.length,r=u.orders.reduce((b,S)=>b+Number(S.totalCents||0),0),s=e?Math.round(r/e):0,i=new Date().getFullYear(),a=new Date(i,0,1).getTime(),d=u.orders.filter(b=>new Date(b.createdAt).getTime()>=a),m=ge(12),c=new Map(m.map(b=>[b,0])),p=new Map(m.map(b=>[b,0]));u.orders.forEach(b=>{const S=new Date(b.createdAt),L=Yt(S);c.has(L)&&(c.set(L,(c.get(L)||0)+Number(b.totalCents||0)),p.set(L,(p.get(L)||0)+1))});const l=m.map(b=>Math.round((c.get(b)||0)/100)),g=m.map(b=>p.get(b)||0),f=m.map(ve),h=new Map,$=(b,S)=>h.set(b,(h.get(b)||0)+S);u.orders.forEach(b=>{(b.items||[]).forEach(S=>{const L=String(S.id||""),bt=u.productsById.get(L),Ee=String(bt?.category||"Other")||"Other",qe=Number(S.priceCents||0)*Number(S.qty||0);$(Ee,qe)})});const C=b=>{const S=String(b||"");return/garment/i.test(S)?"Garment Bags":/hanger/i.test(S)?"Hangers":/poly/i.test(S)?"Polybags":/wrap/i.test(S)?"Wraps":/rack/i.test(S)?"Racks":"Other"},w=new Map;Array.from(h.entries()).forEach(([b,S])=>{const L=C(b);w.set(L,(w.get(L)||0)+S)});const M=Array.from(w.entries()).map(([b,S])=>({label:b,value:Math.round(S/100)})).sort((b,S)=>S.value-b.value),D=["#f07f29","#3b82f6","#10b981","#8b5cf6","#f59e0b","#64748b"],I=M.slice(0,6).map((b,S)=>({...b,color:D[S]})),B=I.reduce((b,S)=>b+S.value,0)||1,_=new Map;d.forEach(b=>{(b.items||[]).forEach(S=>{const L=String(S.id||"");L&&_.set(L,(_.get(L)||0)+(Number(S.qty)||0))})});const x=Array.from(_.entries()).sort((b,S)=>S[1]-b[1])[0]?.[0]||"",q=x&&_.get(x)||0,U=x?u.productsById.get(x)?.name||d.flatMap(b=>b.items||[]).find(b=>String(b.id)===x)?.name||"Item":"-",X=u.orders.reduce((b,S)=>b+at(S),0),z=d.reduce((b,S)=>b+at(S),0),yt=e?Math.round(u.orders.reduce((b,S)=>b+(S?.items||[]).reduce((L,bt)=>L+(Number(bt.qty)||0),0),0)/e):0;n.analyticsBody.innerHTML=`
      <div class="analytics-grid">
        <div class="chart-card">
          <div class="chart-head">
            <div>
              <div class="chart-title">Monthly spending</div>
              <div class="chart-sub">Last 12 months (${o(t)})</div>
            </div>
          </div>
          <div class="chart-wrap">
            ${fe({points:l,labels:f,unitLabel:`Spend (${t})`})}
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-head">
            <div>
              <div class="chart-title">Order frequency</div>
              <div class="chart-sub">Orders per month (last 12 months)</div>
            </div>
          </div>
          <div class="chart-wrap">
            ${ye({values:g,labels:f,unitLabel:"Orders"})}
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-head">
            <div>
              <div class="chart-title">Product breakdown</div>
              <div class="chart-sub">Share of spend by category</div>
            </div>
          </div>
          <div class="chart-wrap" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
            <div style="width:220px; max-width:220px;">
              ${be({parts:I})}
            </div>
            <div class="chart-legend" style="flex:1 1 240px;">
              ${I.map(b=>{const S=Math.round(b.value/B*100);return`
                    <div class="legend-item">
                      <span class="legend-swatch" style="background:${b.color};"></span>
                      <span>${o(b.label)}: ${S}%</span>
                    </div>
                  `}).join("")}
            </div>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-head">
            <div>
              <div class="chart-title">Smart insights</div>
              <div class="chart-sub">Based on your orders</div>
            </div>
          </div>
          <div class="insights-list">
            <div class="insight-row">
              <span class="insight-k">Average per order</span>
              <span class="insight-v">${P(s,t)}</span>
            </div>
            <div class="insight-row">
              <span class="insight-k">Average items per order</span>
              <span class="insight-v">${yt}</span>
            </div>
            <div class="insight-row">
              <span class="insight-k">Top product (${i})</span>
              <span class="insight-v">${o(U)} \xB7 ${q} units</span>
            </div>
            <div class="insight-row">
              <span class="insight-k">Saved vs retail (lifetime)</span>
              <span class="insight-v">${P(X,t)}</span>
            </div>
            <div class="insight-row">
              <span class="insight-k">Saved vs retail (${i})</span>
              <span class="insight-v">${P(z,t)}</span>
            </div>
          </div>
        </div>
      </div>
    `}function Kt(){if(!n.dashboardStats||!n.dashboardSub)return;if(!u.orders.length){n.dashboardSub.textContent="No orders yet - browse products to get started.",n.dashboardStats.innerHTML="",n.dashboardInsights&&(n.dashboardInsights.innerHTML=""),et();return}const t=u.orders[0]?.currency||"CAD",e=u.orders.length,r=u.orders.reduce((l,g)=>l+Number(g.totalCents||0),0),s=u.orders.reduce((l,g)=>l+at(g),0),i=new Date,a=new Date(i.getFullYear(),i.getMonth(),1),d=u.orders.filter(l=>new Date(l.createdAt)>=a).reduce((l,g)=>l+Number(g.totalCents||0),0),m=e?Math.round(r/e):0,c=u.orders[u.orders.length-1],p=c?.createdAt?E(c.createdAt):"";if(n.dashboardSub.textContent=p?`Member since ${p}`:"Your account summary",n.dashboardStats.innerHTML=`
      <div class="dash-card"><div class="dash-value">${e}</div><div class="dash-label">Total orders</div></div>
      <div class="dash-card"><div class="dash-value">${P(r,t)}</div><div class="dash-label">Lifetime spend</div></div>
      <div class="dash-card highlight"><div class="dash-value">${P(s,t)}</div><div class="dash-label">Money saved</div><div class="dash-sub">with member pricing</div></div>
      <div class="dash-card"><div class="dash-value">${P(d,t)}</div><div class="dash-label">This month</div></div>
      <div class="dash-card"><div class="dash-value">${P(m,t)}</div><div class="dash-label">Avg order</div></div>
    `,n.dashboardInsights){const l=W()[0];n.dashboardInsights.innerHTML=`
        <div class="insights-grid">
          <div class="insight">
            <div class="insight-title">Top item</div>
            <div class="insight-body">${o(l?.product?.name||"-")}</div>
            <div class="insight-sub">${l?`Ordered ${l.count} time${l.count===1?"":"s"}`:""}</div>
          </div>
          <div class="insight">
            <div class="insight-title">Smart note</div>
            <div class="insight-body">Tip: add your usuals to Favorites for one-click reorder.</div>
            <div class="insight-sub">Bulk tiers (10/15/20+) maximize savings</div>
          </div>
        </div>
      `}et(),he()}function V(){if(!n.ordersGrid||!n.ordersMsg)return;if(!u.orders.length){n.ordersMsg.textContent=window.PPS_I18N?.t("account.status.empty")||"No orders found for this account yet.",n.ordersGrid.innerHTML="";return}const t=y("account.actions.track","Track order"),e=y("account.actions.invoice","Invoice (PDF)"),r=y("account.actions.email_receipt","Email receipt"),s=y("account.actions.share","Share"),i=y("account.actions.report_problem","Report problem"),a=String(n.orderSearch?.value||"").trim().toLowerCase(),d=String(n.orderStatus?.value||"").trim().toLowerCase(),m=String(n.orderRange?.value||"all"),c=m==="all"?null:Date.now()-Number(m)*24*60*60*1e3,p=u.orders.filter(l=>c&&new Date(l.createdAt).getTime()<c||d&&j(l.status)!==d?!1:a?[l.id,l.status,E(l.createdAt),...(l.items||[]).map(f=>f.name)].filter(Boolean).join(" ").toLowerCase().includes(a):!0);if(n.ordersCountBadge&&(n.ordersCountBadge.textContent=String(u.orders.length)),!p.length){n.ordersMsg.textContent="No matching orders. Try a different search or filters.",n.ordersGrid.innerHTML="";return}n.ordersMsg.textContent="",n.ordersGrid.innerHTML=p.map(l=>{const g=j(l.status),f=g==="processing"?1:g==="shipped"?2:["delivered","fulfilled"].includes(g)?3:0,h=l.currency||"CAD",$=(l.items||[]).map(x=>{const q=u.productsById.get(String(x.id||""))||{},U=me(q),X=q.image||"./assets/poly%20logo%20without%20background.png",z=q.slug?`./product.html?slug=${encodeURIComponent(q.slug)}#reviewForm`:"",yt=Number(x.priceCents||0)*Number(x.qty||0);return`
              <div class="order-item">
                <img class="order-thumb" src="${o(X)}" alt="${o(x.name||"")}" loading="lazy" decoding="async" width="60" height="60">
                <div>
                  <div class="order-item-title">${o(x.name||"")}</div>
                  <div class="order-item-qty">Qty: ${Number(x.qty)||0}</div>
                  ${U?`<div class="order-item-desc">${o(U)}</div>`:""}
                  ${z?`<div style="margin-top:8px;"><a class="btn btn-outline btn-sm" style="padding:6px 10px; font-size:12px;" href="${z}">Write review</a></div>`:""}
                </div>
                <div class="order-item-price">${P(yt,h)}</div>
              </div>
            `}).join(""),w=(()=>{const x=new Date(l.createdAt);if(Number.isNaN(x.getTime()))return{label:"Estimated delivery",value:"-"};if(["delivered","fulfilled"].includes(g))return{label:"Delivered",value:E(x)};const q=new Date(x),U=new Date(x),X=g==="shipped"?1:2,z=g==="shipped"?3:g==="processing"?5:4;return q.setDate(q.getDate()+X),U.setDate(U.getDate()+z),{label:"Estimated delivery",value:`${E(q)} - ${E(U)}`}})(),M=`./contact.html?topic=tracking&order=${encodeURIComponent(l.id)}`,D=`./contact.html?topic=issue&order=${encodeURIComponent(l.id)}`,I=(l.items||[]).map(x=>u.productsById.get(String(x.id||""))||{}).filter(x=>x&&x.image).slice(0,3),B=Math.max(0,(l.items||[]).length-I.length);return`
          <div class="card fade-in order-card">
            <div class="order-top">
              <div class="order-top-left">
                ${I.length?`
            <div class="order-summary-thumbs" aria-label="Order items">
              ${I.map(x=>`<img src="${o(x.image)}" alt="" loading="lazy" decoding="async" width="34" height="34">`).join("")}
              ${B?`<span class="order-summary-more">+${B}</span>`:""}
            </div>
          `:""}
                <div>
                  <div class="order-id">Order #${o(l.id)}</div>
                  <div class="order-date">${o(Z(l.createdAt))}</div>
                  <div style="margin-top:6px; font-weight:1000;">${o(w.label)}: <span style="color:rgba(17,24,39,.95);">${o(w.value)}</span></div>
                </div>
              </div>
              <div class="order-right">
                <div class="status-pill ${o(g)}">${o(Y(g))}</div>
                <div class="order-total">${P(Number(l.totalCents||0),h)}</div>
              </div>
            </div>
            <div class="status-track" aria-label="Order progress">
              <div class="track">
                ${["Order placed","Processing","Shipped","Delivered"].map((x,q)=>`
                      <div class="track-step ${q<f?"done":""} ${q===f?"active":""} ${f===3&&q<=3?"done":""}">
                        <div class="dot"></div>
                        <div class="label">${x}</div>
                      </div>
                    `).join("")}
              </div>
            </div>
            <div class="order-items">${$}</div>
            <div class="order-actions">
              <button class="btn btn-primary" type="button" onclick="reorder('${o(l.id)}')">${window.PPS_I18N?.t("account.reorder")||"Reorder"}</button>
              <button class="btn btn-outline" type="button" onclick="trackOrder('${o(l.id)}')">${o(t)}</button>
              <button class="btn btn-outline" type="button" onclick="downloadInvoice('${o(l.id)}')">${o(e)}</button>
              <button class="btn btn-outline" type="button" onclick="emailReceipt('${o(l.id)}')">${o(r)}</button>
              <button class="btn btn-outline" type="button" onclick="shareOrder('${o(l.id)}')">${o(s)}</button>
              <a class="btn btn-outline" href="${D}">${o(i)}</a>
            </div>
          </div>
        `}).join(""),O(".fade-in").forEach(l=>l.classList.add("show"))}function nt(t){const e=String(t||"").trim();if(!e)return null;const r=e.split("-").map(c=>Number(c));if(r.length!==3||r.some(c=>!Number.isFinite(c)))return null;const[s,i,a]=r,m=new Date(s,i-1,a).getTime();return Number.isNaN(m)?null:m}function Wt(){const t=String(n.invoiceSearch?.value||"").trim().toLowerCase(),e=String(n.invoiceStatus?.value||"").trim().toLowerCase(),r=nt(n.invoiceFrom?.value),s=nt(n.invoiceTo?.value),i=s==null?null:s+1440*60*1e3-1;return u.orders.filter(a=>{const d=new Date(a.createdAt).getTime();return r!=null&&d<r||i!=null&&d>i||e&&j(a.status)!==e?!1:t?[a.id,a.status,E(a.createdAt),...(a.items||[]).map(c=>c.name)].filter(Boolean).join(" ").toLowerCase().includes(t):!0})}function G(){if(!n.invoicesList||!n.invoicesMsg)return;if(n.invoicesCountBadge&&(n.invoicesCountBadge.textContent=String(u.orders.length)),!u.orders.length){n.invoicesMsg.textContent=y("account.invoices.empty","No invoices yet. Orders will appear here once you place an order."),n.invoicesList.innerHTML="";return}const t=Wt();if(!t.length){n.invoicesMsg.textContent=y("account.invoices.none","No matching invoices. Try a different search or filters."),n.invoicesList.innerHTML="";return}n.invoicesMsg.textContent="";const e=y("account.actions.invoice","Invoice (PDF)"),r=y("account.actions.email_receipt","Email receipt");n.invoicesList.innerHTML=t.map(s=>{const i=j(s.status),a=s.currency||"CAD",d=(s.items||[]).slice(0,2).map(c=>`${c.name} x${Number(c.qty)||0}`).filter(Boolean).join(" \xB7 "),m=Math.max(0,(s.items||[]).length-2);return`
          <div class="card fade-in" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
              <div>
                <div style="font-weight:1000;">${o(y("account.order","Order"))} #${o(s.id)}</div>
                <div style="color:var(--muted); font-size:13px; margin-top:4px;">${o(Z(s.createdAt))}${d?` \xB7 ${o(d)}${m?` +${m}`:""}`:""}</div>
              </div>
              <div style="text-align:right;">
                <div class="status-pill ${o(i)}" style="display:inline-flex;">${o(Y(i))}</div>
                <div style="margin-top:6px; font-weight:1000;">${P(Number(s.totalCents||0),a)}</div>
              </div>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
              <button class="btn btn-outline btn-sm" type="button" onclick="emailReceipt('${o(s.id)}')">${o(r)}</button>
              <button class="btn btn-primary btn-sm" type="button" onclick="downloadInvoice('${o(s.id)}')">${o(e)}</button>
            </div>
          </div>
        `}).join(""),O(".fade-in").forEach(s=>s.classList.add("show"))}function we(){const t=nt(n.invoiceFrom?.value),e=nt(n.invoiceTo?.value);if(t==null||e==null){A(y("account.invoices.select_range","Select a start and end date to download a date range."));return}const r=Wt();if(!r.length){A(y("account.invoices.none","No matching invoices. Try a different search or filters."));return}const s=30;if(r.length>s){const d=y("account.invoices.too_many",""),m=d?d.replace(/\{\{count\}\}/g,String(r.length)).replace(/\{\{max\}\}/g,String(s)):`Too many invoices (${r.length}). Narrow the range to download up to ${s} at once.`;A(m)}const i=r.slice(0,s),a=`Invoices ${String(n.invoiceFrom?.value||"")} to ${String(n.invoiceTo?.value||"")}`.trim();Vt(i,{title:a||"Invoices",autoPrint:!0})}function J(t){if(!n.profileGrid)return;const e=N?.email||t?.customer?.email||"",r=N?.name||t?.customer?.name||"",s=String(N?.phone||t?.customer?.phone||"").trim(),i=String(N?.province||t?.customer?.province||"").trim(),a=i?st(i):"",d=y("account.profile.missing","Not added yet"),m=y("account.profile.add","Add"),c=y("account.profile.add_phone_hint","Add a phone number for delivery updates."),p=y("account.profile.add_province_hint","Add your province for accurate tax at checkout."),l=s?o(s):`<span class="profile-missing">${o(d)}</span> <button class="profile-add-link" type="button" data-profile-edit="phone">${o(m)}</button><div class="profile-hint">${o(c)}</div>`,g=a?o(a):`<span class="profile-missing">${o(d)}</span> <button class="profile-add-link" type="button" data-profile-edit="province">${o(m)}</button><div class="profile-hint">${o(p)}</div>`;if(n.profileGrid.innerHTML=`
      <div class="profile-item"><div class="k">Name</div><div class="v">${o(r||"-")}</div></div>
      <div class="profile-item"><div class="k">Email</div><div class="v">${o(e||"-")}</div></div>
      <div class="profile-item"><div class="k">Phone</div><div class="v">${l}</div></div>
      <div class="profile-item"><div class="k">Province</div><div class="v">${g}</div></div>
      <div class="profile-item"><div class="k">Member status</div><div class="v">&#10003; Verified Power Poly Member</div></div>
    `,n.profileActions){const f=u.profileEditing?"Cancel":"Edit profile";n.profileActions.innerHTML=`
        <div class="profile-actions">
          <button class="btn btn-outline btn-sm" type="button" id="toggleProfileEdit">${f}</button>
        </div>
        <form id="profileEditForm" class="profile-edit ${u.profileEditing?"":"is-hidden"}" novalidate>
          <div class="profile-edit-grid">
            <label class="pref-field">
              <span style="font-size:13px; color:var(--muted);">Name</span>
              <input class="input" name="name" value="${o(r||"")}" autocomplete="name">
            </label>
            <label class="pref-field">
              <span style="font-size:13px; color:var(--muted);">Phone</span>
              <input class="input" name="phone" value="${o(s||"")}" autocomplete="tel">
            </label>
            <label class="pref-field">
              <span style="font-size:13px; color:var(--muted);">Province</span>
              <select class="input" name="province" aria-label="Province">
                <option value="">Select province/territory</option>
                <option value="ON" ${i==="ON"?"selected":""}>Ontario</option>
                <option value="QC" ${i==="QC"?"selected":""}>Quebec</option>
                <option value="BC" ${i==="BC"?"selected":""}>British Columbia</option>
                <option value="AB" ${i==="AB"?"selected":""}>Alberta</option>
                <option value="MB" ${i==="MB"?"selected":""}>Manitoba</option>
                <option value="SK" ${i==="SK"?"selected":""}>Saskatchewan</option>
                <option value="NS" ${i==="NS"?"selected":""}>Nova Scotia</option>
                <option value="NB" ${i==="NB"?"selected":""}>New Brunswick</option>
                <option value="NL" ${i==="NL"?"selected":""}>Newfoundland and Labrador</option>
                <option value="PE" ${i==="PE"?"selected":""}>Prince Edward Island</option>
                <option value="YT" ${i==="YT"?"selected":""}>Yukon</option>
                <option value="NT" ${i==="NT"?"selected":""}>Northwest Territories</option>
                <option value="NU" ${i==="NU"?"selected":""}>Nunavut</option>
              </select>
            </label>
          </div>
          <div class="profile-edit-actions">
            <button class="btn btn-primary btn-sm" type="submit">Save changes</button>
          </div>
          <div class="profile-edit-note">Updates your saved profile on this device.</div>
        </form>
      `;const h=v("#toggleProfileEdit");h&&h.addEventListener("click",()=>{u.profileEditing=!u.profileEditing,J(t)});const $=v("#profileEditForm");$&&$.addEventListener("submit",C=>{C.preventDefault();const w=new FormData($),M=String(w.get("name")||"").trim().slice(0,80),D=String(w.get("phone")||"").trim().slice(0,40),I=String(w.get("province")||"").trim().slice(0,2);N.name=M,N.phone=D,N.province=I;try{window.PPS?.setSession?.(N)}catch{}try{const B=`pps_profile_${String(N.email||"").trim().toLowerCase()}`,_=F(B,{});k(B,{..._,name:M,phone:D,province:I})}catch{}if(n.nameEl){const B=window.PPS_I18N?.t("account.welcome_name")||"Welcome, {{name}}",_=window.PPS_I18N?.t("account.welcome_back")||"Welcome back",x=ht(N.name);n.nameEl.textContent=x?B.replace("{{name}}",x):_}n.provinceEl&&(n.provinceEl.textContent=I?st(I):""),u.profileEditing=!1,A("Profile updated."),J(t)})}Array.from(n.profileGrid.querySelectorAll("[data-profile-edit]")).forEach(f=>{f.addEventListener("click",()=>{u.profileEditing=!0,J(t);const h=String(f.getAttribute("data-profile-edit")||""),$=v("#profileEditForm"),C=$?.querySelector(`[name="${h}"]`);$&&$.scrollIntoView({behavior:"smooth",block:"nearest"}),C&&typeof C.focus=="function"&&C.focus()})}),zt()}function Qt(){if(!u.orders.length)return;const t=[["order_id","created_at","status","currency","total","item_id","item_name","qty","unit_price","line_total"]];u.orders.forEach(a=>{(a.items||[]).forEach(d=>{const m=Number(d.qty)||0,c=Number(d.priceCents)||0,p=c*m;t.push([a.id,a.createdAt,j(a.status),a.currency||"CAD",(Number(a.totalCents||0)/100).toFixed(2),d.id||"",d.name||"",String(m),(c/100).toFixed(2),(p/100).toFixed(2)])})});const e=t.map(a=>a.map(d=>{const m=String(d??"");return/[",\n]/.test(m)?`"${m.replace(/"/g,'""')}"`:m}).join(",")).join(`
`),r=new Blob([e],{type:"text/csv"}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s,i.download="orders.csv",document.body.appendChild(i),i.click(),i.remove(),setTimeout(()=>URL.revokeObjectURL(s),4e3)}const pt={name:"Power Poly Supplies",address:"15725 Weston Rd, Kettleby, ON L7B 0L4",email:"powerpolysupplies@gmail.com"};function Se(t){const e=String(t||"").trim().toUpperCase();return{ON:{label:"HST 13%",rate:.13},NS:{label:"HST 15%",rate:.15},NB:{label:"HST 15%",rate:.15},NL:{label:"HST 15%",rate:.15},PE:{label:"HST 15%",rate:.15},AB:{label:"GST 5%",rate:.05},BC:{label:"GST 5%",rate:.05},SK:{label:"GST 5%",rate:.05},MB:{label:"GST 5%",rate:.05},QC:{label:"GST 5% + QST 9.975%",rate:.05,qstRate:.09975},YT:{label:"GST 5%",rate:.05},NT:{label:"GST 5%",rate:.05},NU:{label:"GST 5%",rate:.05}}[e]||{label:y("invoice.tax","Tax"),rate:0}}function $e(t){const e=t.currency||"CAD",r=Array.isArray(t.items)?t.items:[],s=r.reduce((_,x)=>_+Number(x.priceCents||0)*Number(x.qty||0),0),i=Number(t.discountCents??t.discount_cents??0),a=Number(t.customer?.rewards?.amountCents??0),d=Math.max(0,Math.min(s,i||a||0)),m=String(t.customer?.rewards?.code||"").trim(),c=Math.max(0,Number(t.shipping?.costCents??t.shipping?.amountCents??0)),p=String(t.shipping?.label||y("invoice.shipping","Shipping")).trim(),l=String(t.customer?.province||N?.province||"").trim().toUpperCase(),g=Math.max(0,s-d),f=Se(l),h=Math.round(g*(Number(f.rate)||0)),$=f.qstRate?Math.round(g*Number(f.qstRate)):0,C=h+$,w=Number(t.totalCents??t.total_cents??0),M=g+c+C,D=w>0?w:M;let I=Math.max(0,Number(t.taxCents??t.tax_cents??0));!I&&C&&(I=C),!I&&D&&(I=Math.max(0,D-(g+c)));const B=String(t.paymentMethod??t.payment_method??"").trim();return{currency:e,items:r,itemsSubtotalCents:s,discountCents:d,discountLabel:m,shippingCents:c,shippingLabel:p,taxableSubtotalCents:g,gstCents:$?h:0,qstCents:$||0,taxCents:I,taxLabel:String(t.taxLabel||f.label||y("invoice.tax","Tax")).trim(),totalCents:D,paymentMethod:B,province:l}}function xe(t){return[t?.address1||t?.address_line1||"",t?.address2||t?.address_line2||"",[t?.city||"",t?.province||"",t?.postal||""].filter(Boolean).join(" "),t?.country||""].map(r=>String(r||"").trim()).filter(Boolean).join(`
`)}function Ae(t,e,r){const s=$e(t),i=t.customer||{},a=String(i.name||N?.name||"").trim(),d=String(i.email||N?.email||"").trim(),m=String(i.phone||N?.phone||"").trim(),c=xe(i),p=s.items.map($=>{const C=Number($.qty)||0,w=Number($.priceCents||0),M=w*C;return`
          <tr>
            <td class="item">${o($.name||"")}</td>
            <td class="qty">${C}</td>
            <td class="num">${o(P(w,s.currency))}</td>
            <td class="num">${o(P(M,s.currency))}</td>
          </tr>
        `}).join(""),l=s.discountCents>0?`
          <tr>
            <td>${o(e.discount)}${s.discountLabel?` (${o(s.discountLabel)})`:""}</td>
            <td class="num">-${o(P(s.discountCents,s.currency))}</td>
          </tr>
        `:"",g=s.qstCents?`
        <tr><td>GST (5%)</td><td class="num">${o(P(s.gstCents,s.currency))}</td></tr>
        <tr><td>QST (9.975%)</td><td class="num">${o(P(s.qstCents,s.currency))}</td></tr>
      `:`
        <tr><td>${o(s.taxLabel||e.tax)}</td><td class="num">${o(P(s.taxCents,s.currency))}</td></tr>
      `,f=s.paymentMethod?`<div class="meta-row"><span class="k">${o(e.payment)}</span><span class="v">${o(s.paymentMethod)}</span></div>`:"",h=s.province?`<div class="meta-row"><span class="k">${o(e.province)}</span><span class="v">${o(s.province)}</span></div>`:"";return`
      <section class="invoice">
        <div class="top">
          <div class="brand">
            ${r?`<img class="logo" src="${o(r)}" alt="" width="52" height="52">`:""}
            <div>
              <div class="company">${o(pt.name)}</div>
              <div class="muted">${o(pt.address)}</div>
              <div class="muted">${o(pt.email)}</div>
            </div>
          </div>
          <div class="meta">
            <div class="title">${o(e.invoiceTitle)}</div>
            <div class="meta-row"><span class="k">${o(e.order)}</span><span class="v">#${o(t.id)}</span></div>
            <div class="meta-row"><span class="k">${o(e.date)}</span><span class="v">${o(E(t.createdAt))}</span></div>
            <div class="meta-row"><span class="k">${o(e.status)}</span><span class="v">${o(Y(t.status))}</span></div>
            ${f}
            ${h}
          </div>
        </div>

        <div class="billto">
          <div class="section-title">${o(e.billTo)}</div>
          <div class="muted">
            ${a?`${o(a)}<br/>`:""}
            ${d?`${o(e.email)}: ${o(d)}<br/>`:""}
            ${m?`${o(e.phone)}: ${o(m)}<br/>`:""}
            ${c?`${o(c).replace(/\n/g,"<br/>")}<br/>`:""}
          </div>
        </div>

        <table class="items">
          <thead>
            <tr>
              <th>${o(e.item)}</th>
              <th class="qty">${o(e.qty)}</th>
              <th class="num">${o(e.unitPrice)}</th>
              <th class="num">${o(e.lineTotal)}</th>
            </tr>
          </thead>
          <tbody>${p}</tbody>
        </table>

        <table class="totals">
          <tbody>
            <tr><td>${o(e.subtotal)}</td><td class="num">${o(P(s.itemsSubtotalCents,s.currency))}</td></tr>
            ${l}
            <tr><td>${o(s.shippingLabel||e.shipping)}</td><td class="num">${o(P(s.shippingCents,s.currency))}</td></tr>
            ${g}
            <tr class="grand"><td>${o(e.total)}</td><td class="num">${o(P(s.totalCents,s.currency))}</td></tr>
          </tbody>
        </table>
      </section>
    `}function Ce({title:t,bodyHtml:e,autoPrint:r}){const s=window.open("","_blank");if(!s){A(y("invoice.popup_blocked","Popup blocked. Please allow popups to download invoices."));return}const i=`
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8"/>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>${o(t)}</title>
          <style>
            :root{ --muted:#6b7280; --border:#e5e7eb; --ink:#111827; }
            *{ box-sizing:border-box; }
            body{ margin:0; font-family: Arial, Helvetica, sans-serif; color:var(--ink); background:#f3f4f6; }
            .toolbar{ position:sticky; top:0; z-index:5; background:#111827; color:white; padding:10px 12px; display:flex; gap:10px; align-items:center; justify-content:space-between; }
            .toolbar .btn{ background:white; color:#111827; border:0; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; }
            .toolbar .tip{ font-size:12px; opacity:.9; }
            .wrap{ max-width:960px; margin:0 auto; padding:14px; }
            .invoice{ background:white; border:1px solid var(--border); border-radius:14px; padding:18px; margin:0 0 12px; }
            .top{ display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; }
            .brand{ display:flex; gap:12px; align-items:center; }
            .logo{ border-radius:10px; border:1px solid var(--border); background:white; }
            .company{ font-weight:1000; font-size:18px; }
            .muted{ color:var(--muted); font-size:12px; line-height:1.45; }
            .meta{ min-width:260px; text-align:right; }
            .title{ font-weight:1000; font-size:16px; }
            .meta-row{ margin-top:6px; display:flex; justify-content:space-between; gap:12px; font-size:12px; }
            .meta-row .k{ color:var(--muted); font-weight:800; }
            .meta-row .v{ font-weight:900; }
            .billto{ margin-top:14px; }
            .section-title{ font-weight:1000; margin-bottom:6px; }
            table{ width:100%; border-collapse:collapse; }
            .items{ margin-top:12px; }
            .items th{ text-align:left; font-size:12px; color:var(--muted); padding:10px 8px; border-bottom:1px solid var(--border); }
            .items td{ padding:10px 8px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
            .items .qty{ text-align:center; width:70px; }
            .items .num{ text-align:right; width:120px; }
            .items td.item{ font-weight:900; }
            .totals{ margin-top:12px; width:340px; margin-left:auto; }
            .totals td{ padding:8px 0; font-size:13px; }
            .totals td.num{ text-align:right; font-weight:900; }
            .totals .grand td{ padding-top:10px; border-top:1px solid var(--border); font-size:15px; }

            @media print{
              body{ background:white; }
              .toolbar{ display:none; }
              .wrap{ max-width:none; padding:0; }
              .invoice{ border:0; border-radius:0; padding:0; margin:0 0 18px; page-break-after:always; }
              .invoice:last-child{ page-break-after:auto; }
            }
          </style>
        </head>
        <body>
          <div class="toolbar">
            <div class="tip">${o(y("invoice.tip_pdf","Tip: choose \u201CSave as PDF\u201D in your print dialog."))}</div>
            <button class="btn" type="button" onclick="window.print()">${o(y("invoice.print","Print / Save as PDF"))}</button>
          </div>
          <div class="wrap">${e}</div>
          <script>
            (function(){
              const auto = ${r?"true":"false"};
              if(!auto) return;
              setTimeout(()=>{
                try{ window.focus(); }catch(e){}
                try{ window.print(); }catch(e){}
              }, 350);
              try{
                window.onafterprint = ()=>{ try{ window.close(); }catch(e){} };
              }catch(e){}
            })();
          <\/script>
        </body>
      </html>
    `;s.document.open(),s.document.write(i),s.document.close()}function Vt(t,e={}){const r=Array.isArray(t)?t.filter(Boolean):[];if(!r.length)return;const s=new URL("./assets/poly%20logo%20without%20background.png",window.location.href).href,i={invoiceTitle:y("invoice.title","Invoice"),order:y("invoice.order","Order"),date:y("invoice.date","Date"),status:y("invoice.status","Status"),payment:y("invoice.payment","Payment method"),province:y("invoice.province","Province"),billTo:y("invoice.bill_to","Bill to"),email:y("invoice.email","Email"),phone:y("invoice.phone","Phone"),item:y("invoice.item","Item"),qty:y("invoice.qty","Qty"),unitPrice:y("invoice.unit_price","Unit price"),lineTotal:y("invoice.line_total","Line total"),subtotal:y("invoice.subtotal","Subtotal"),discount:y("invoice.discount","Discount"),shipping:y("invoice.shipping","Shipping"),tax:y("invoice.tax","Tax"),total:y("invoice.total","Total")},a=r.map(d=>Ae(d,i,s)).join("");Ce({title:e.title||(r.length===1?`Invoice ${r[0].id}`:"Invoices"),bodyHtml:a,autoPrint:e.autoPrint!==!1})}window.downloadInvoice=t=>{const e=u.orders.find(r=>r.id===t);e&&Vt([e],{title:`Invoice ${e.id}`,autoPrint:!0})},window.trackOrder=t=>{const e=u.orders.find(s=>s.id===t);if(!e)return;const r=`./contact.html?topic=tracking&order=${encodeURIComponent(e.id)}`;window.location.href=r},window.emailReceipt=t=>{const e=u.orders.find(c=>c.id===t);if(!e)return;const r=e.currency||"CAD",s=(e.items||[]).map(c=>`- ${c.name} x${c.qty}`).join(`
`),i=`Receipt - Order ${e.id} (Power Poly Supplies)`,a=`Power Poly Supplies - Receipt
Order: ${e.id}
Date: ${E(e.createdAt)}
Status: ${Y(e.status)}
Total: ${P(e.totalCents,r)}

Items:
${s}

Need help? Reply with your order number.`,m=`mailto:${encodeURIComponent(String(N?.email||"").trim())}?subject=${encodeURIComponent(i)}&body=${encodeURIComponent(a)}`;window.location.href=m},window.reorder=t=>{const e=u.orders.find(r=>r.id===t);e&&(window.PPS?.addItemsToCart?.(e.items||[]),window.PPS?.updateCartBadge?.(),n.ordersMsg&&(n.ordersMsg.textContent=window.PPS_I18N?.t("account.status.added")||"Items added to cart. Ready to checkout."))},window.shareOrder=async t=>{const e=u.orders.find(a=>a.id===t);if(!e)return;const r=e.currency||"CAD",s=(e.items||[]).map(a=>`- ${a.name} x${a.qty}`).join(`
`),i=`Power Poly Supplies - Order ${e.id}
Date: ${E(e.createdAt)}
Status: ${Y(e.status)}
Total: ${P(e.totalCents,r)}

Items:
${s}`;try{if(navigator.share){await navigator.share({title:`Order ${e.id}`,text:i}),A("Shared.");return}await navigator.clipboard.writeText(i),A("Order details copied.")}catch{A("Could not copy (clipboard blocked).")}};function Jt(){if(!n.favoritesSuggestions)return;if(!u.orders.length||!u.productsById.size){n.favoritesSuggestions.innerHTML="";return}const t=W().filter(e=>!window.PPS?.isFavorite?.(e.id)).slice(0,3);if(!t.length){n.favoritesSuggestions.innerHTML="";return}n.favoritesSuggestions.innerHTML=`
      <div style="margin-top:12px;">
        <div style="font-weight:1000; margin-bottom:8px;">Quick add from your order history</div>
        <div class="grid grid-3">
          ${t.map(({product:e})=>`
                <div class="card fade-in">
                  <a href="./product.html?slug=${encodeURIComponent(e.slug)}">
                    <img src="${o(e.image)}" alt="${o(e.name)}" loading="lazy" decoding="async" width="400" height="190">
                  </a>
                  <div class="card-body">
                    <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(e.slug)}">${o(e.name)}</a>
                    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                      <button class="btn btn-outline" type="button" onclick="addFav('${o(e.id)}')">Add to Favorites</button>
                      <button class="btn btn-primary" ${e.stock<=0?"disabled":""} type="button" onclick="quickAdd('${o(e.id)}', 1)">Add to cart</button>
                    </div>
                  </div>
                </div>
              `).join("")}
        </div>
      </div>
    `,O(".fade-in").forEach(e=>e.classList.add("show"))}function Xt(){if(!n.favoritesGrid||!n.favoritesMsg)return;const t=window.PPS?.getFavorites?.()||[];if(n.favoritesCountBadge&&(n.favoritesCountBadge.textContent=String(t.length)),!t.length){n.favoritesMsg.textContent="No favorite items yet. Add products you reorder often.",n.favoritesGrid.innerHTML="",Jt();return}n.favoritesMsg.textContent="",n.favoritesGrid.innerHTML=t.map(e=>u.productsById.get(String(e))).filter(Boolean).map(e=>`
          <div class="card fade-in">
            <a href="./product.html?slug=${encodeURIComponent(e.slug)}">
              <img src="${o(e.image)}" alt="${o(e.name)}" loading="lazy" decoding="async" width="400" height="190">
            </a>
            <div class="card-body">
              <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(e.slug)}">${o(e.name)}</a>
              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-primary" ${e.stock<=0?"disabled":""} type="button" onclick="quickAdd('${o(e.id)}', 1)">Add to cart</button>
                <a class="btn btn-outline" href="./product.html?slug=${encodeURIComponent(e.slug)}">View</a>
              </div>
            </div>
          </div>
        `).join(""),Jt(),O(".fade-in").forEach(e=>e.classList.add("show")),window.PPS_I18N?.applyTranslations?.()}window.addFav=t=>{window.PPS?.toggleFavorite?.(t),A("Updated Favorites."),Xt()};function vt(){if(!n.frequentGrid||!n.frequentMsg)return;if(!u.orders.length||!u.productsById.size){n.frequentMsg.textContent="Your frequent items will appear after your first order.",n.frequentGrid.innerHTML="";return}const t=W().slice(0,6);if(!t.length){n.frequentMsg.textContent="No frequent items yet.",n.frequentGrid.innerHTML="";return}n.frequentMsg.textContent="",n.frequentGrid.innerHTML=t.map(({product:e,count:r,avgQty:s,prediction:i},a)=>{const d=Math.max(1,Math.round(Number(s)||1)),m=le(e.id),c=m?.cadenceDays||Math.max(14,(Number(s),30));return`
          <div class="card fade-in">
            <a href="./product.html?slug=${encodeURIComponent(e.slug)}">
              <img src="${o(e.image)}" alt="${o(e.name)}" loading="lazy" decoding="async" width="400" height="190">
            </a>
            <div class="card-body">
              <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(e.slug)}">${o(e.name)}</a>
              <div class="card-meta">
                ${a===0?'<span class="count-badge count-badge-muted" title="Frequently ordered" style="margin-right:8px;">Frequently ordered</span>':""}
                Ordered ${r} time${r===1?"":"s"} &middot; Avg qty: ${d}
              </div>
              ${i?`<div style="margin-top:8px; color:var(--muted); font-size:13px;">${o(i)}</div>`:""}
              ${m?`<div class="sub-note">Subscribed \xB7 next ${o(E(m.nextDate))}</div>`:""}
              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:800;">
                  <span style="color:var(--muted); font-size:13px;">Qty</span>
                  <input class="input" type="number" min="1" step="1" value="${d}" style="max-width:110px;" data-freq-qty>
                </label>
                <button class="btn btn-primary" ${e.stock<=0?"disabled":""} type="button" data-freq-add="${o(e.id)}">Add to cart</button>
                <button class="btn btn-outline" type="button" onclick="addFav('${o(e.id)}')">Favorite</button>
                <button class="btn btn-outline" type="button" data-subscribe-id="${o(e.id)}" data-subscribe-cadence="${c}">${m?"Unsubscribe":"Subscribe & Save"}</button>
              </div>
            </div>
          </div>
        `}).join(""),O(".fade-in").forEach(e=>e.classList.add("show")),u._frequentBound||(u._frequentBound=!0,n.frequentGrid.addEventListener("click",e=>{const r=e.target.closest?.("[data-freq-add]");if(!r)return;const s=String(r.getAttribute("data-freq-add")||""),i=r.closest(".card"),a=i?i.querySelector("[data-freq-qty]"):null,d=Math.max(1,Math.round(Number(a?.value)||1));window.quickAdd?.(s,d)})),u._subscriptionBound||(u._subscriptionBound=!0,n.frequentGrid.addEventListener("click",e=>{const r=e.target.closest?.("[data-subscribe-id]");if(!r)return;const s=r.getAttribute("data-subscribe-id"),i=Number(r.getAttribute("data-subscribe-cadence")||30);ue(s,i),vt(),A("Subscription updated.")}))}window.quickAdd=(t,e)=>{const r=u.productsById.get(String(t));r&&(window.PPS?.addToCart?.(r,Number(e)||1),window.PPS?.updateCartBadge?.(),A("Added to cart."))};function rt(){if(!n.addressesGrid)return;const t=F(T("addresses"),[]);if(!Array.isArray(t)||!t.length){n.addressesGrid.innerHTML=`
        <div class="account-empty">
          <div style="font-weight:1000;">No saved addresses yet.</div>
          <div style="margin-top:6px; color:var(--muted); font-weight:800; font-size:13px;">Add your main store, warehouse, or branch locations for faster checkout.</div>
        </div>
      `;return}const e=wt(t);n.addressesGrid.innerHTML=`
      <div class="profile-grid">
        ${t.map(r=>`
              <div class="profile-item">
                <div class="k" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                  <span>${o(r.label||"Address")}</span>
                  ${String(r.id)===String(e)?'<span class="count-badge count-badge-muted" title="Default delivery address">Default</span>':""}
                </div>
                <div class="v" style="margin-top:8px;">
                  <div style="font-weight:1000;">${o(r.name||"")}</div>
                  <div style="color:var(--muted); font-weight:800; font-size:13px; margin-top:4px;">
                    ${[r.line1,r.line2,`${r.city||""}${r.province?", "+r.province:""} ${r.postal||""}`.trim(),r.country||""].filter(Boolean).map(o).join("<br>")}
                  </div>
                  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-outline btn-sm" type="button" data-addr-edit="${o(r.id)}">Edit</button>
                    <button class="btn btn-outline btn-sm" type="button" data-addr-del="${o(r.id)}">Remove</button>
                    <button class="btn btn-outline btn-sm" type="button" data-addr-default="${o(r.id)}" ${String(r.id)===String(e)?"disabled":""}>Set default</button>
                  </div>
                </div>
              </div>
            `).join("")}
      </div>
    `}function Zt(){if(!n.orderRecsGrid||!n.orderRecsMsg)return;if(!u.orders.length||!u.products.length){n.orderRecsMsg.textContent="Recommendations will appear after your first order.",n.orderRecsGrid.innerHTML="";return}const t={},e=new Set;u.orders.forEach(i=>{(i.items||[]).forEach(a=>{e.add(String(a.id||""));const d=u.productsById.get(String(a.id||"")),m=String(d?.category||"").trim();m&&(t[m]=(t[m]||0)+(Number(a.qty)||1))})});const r=Object.keys(t).sort((i,a)=>t[a]-t[i]).slice(0,3),s=u.products.filter(i=>!e.has(String(i.id))).filter(i=>r.length?r.includes(i.category):!0).slice(0,6);if(!s.length){n.orderRecsMsg.textContent="No recommendations available yet.",n.orderRecsGrid.innerHTML="";return}n.orderRecsMsg.textContent="",n.orderRecsGrid.innerHTML=s.map(i=>`
        <div class="card fade-in" style="padding:14px;">
          <a href="./product.html?slug=${encodeURIComponent(i.slug)}">
            <img src="${o(i.image)}" alt="${o(i.name)}" loading="lazy" decoding="async" width="400" height="190">
          </a>
          <div class="card-body">
            <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(i.slug)}">${o(i.name)}</a>
            <div class="card-meta">${o(i.category||"")}</div>
            <div style="margin-top:10px; display:flex; gap:10px;">
              <button class="btn btn-primary btn-sm" type="button" onclick="quickAdd('${o(i.id)}', 1)">Add</button>
              <a class="btn btn-outline btn-sm" href="./product.html?slug=${encodeURIComponent(i.slug)}">View</a>
            </div>
          </div>
        </div>
      `).join(""),O(".fade-in").forEach(i=>i.classList.add("show"))}function Me(){if(!n.businessForm||!n.businessMsg)return;const t=F(Pt,{});["company","taxId","billingEmail"].forEach(r=>{const s=n.businessForm.querySelector(`[name="${r}"]`);s&&(s.value=t?.[r]||"")});const e=n.businessForm.querySelector('[name="invoiceByEmail"]');e&&(e.checked=!!t?.invoiceByEmail)}function R(){if(n.businessTierForm&&n.businessTierOutput){const t=F(kt,{tier:"starter",volume:0,contractPricing:!1});n.businessTierForm.querySelector('[name="tier"]')?.setAttribute("data-current",t.tier||"starter");const e=n.businessTierForm.querySelector('[name="tier"]'),r=n.businessTierForm.querySelector('[name="volume"]'),s=n.businessTierForm.querySelector('[name="contractPricing"]');e&&(e.value=t.tier||"starter"),r&&(r.value=t.volume??0),s&&(s.checked=!!t.contractPricing);const i=t.tier==="enterprise"?12:t.tier==="growth"?7:3;n.businessTierOutput.textContent=`Estimated tier discount: ${i}% \xB7 Volume: ${Number(t.volume||0)} cases.`}if(n.rfqOutput){const t=F(It,null);n.rfqOutput.textContent=t?`RFQ submitted on ${E(t.createdAt)}.`:"No RFQ submitted yet."}if(n.netTermsOutput&&n.netTermsForm){const t=F(Lt,{terms:"net30",requested:!1}),e=n.netTermsForm.querySelector('[name="terms"]'),r=n.netTermsForm.querySelector('[name="requestTerms"]');e&&(e.value=t.terms||"net30"),r&&(r.checked=!!t.requested),n.netTermsOutput.textContent=t.requested?`Net terms request submitted (${t.terms}).`:"Select a term and submit to request net terms."}if(n.poUploadOutput){const t=F(Et,null);n.poUploadOutput.textContent=t?`PO uploaded: ${t.filename} (${E(t.createdAt)})`:"No PO uploaded."}if(n.approvalList){const t=F(ct,[]);!Array.isArray(t)||!t.length?n.approvalList.innerHTML='<div class="muted">No approvers yet.</div>':n.approvalList.innerHTML=t.map(e=>`
          <div class="business-list-item">
            <div>${o(e.email||"")}</div>
            <div>$${Number(e.limit||0).toLocaleString()} limit</div>
          </div>
        `).join("")}if(n.bulkTemplateList){const t=F(lt,[]);!Array.isArray(t)||!t.length?n.bulkTemplateList.innerHTML='<div class="muted">No bulk templates saved.</div>':n.bulkTemplateList.innerHTML=t.map(e=>`
          <div class="business-list-item">
            <div>${o(e.name||"Template")}</div>
            <div>${(e.items||"").split(`
`).filter(Boolean).length} items</div>
          </div>
        `).join("")}if(n.csvUploadOutput){const t=F(qt,null);n.csvUploadOutput.textContent=t?`CSV uploaded: ${t.filename} (${t.rows} rows).`:"Upload a CSV to preview."}if(n.repAssignOutput&&n.repAssignForm){const t=F(Bt,null),e=n.repAssignForm.querySelector('[name="rep"]');e&&t?.rep&&(e.value=t.rep),n.repAssignOutput.textContent=t?`Assigned rep: ${t.label}.`:"No rep assigned yet."}if(n.creditAppOutput){const t=F(_t,null);n.creditAppOutput.textContent=t?`Application submitted (${E(t.createdAt)}). Status: Pending review.`:"No application submitted."}}function Te(t){const e=T("addresses"),r=F(e,[]),s=Array.isArray(r)?r:[],i=s.findIndex(a=>String(a.id)===String(t.id));i>=0?s[i]=t:s.unshift(t),k(e,s),rt()}function Fe(t){const e=T("addresses"),r=F(e,[]),i=(Array.isArray(r)?r:[]).filter(d=>String(d.id)!==String(t));k(e,i);const a=ot();if(a&&String(a)===String(t)){const d=i[0]?.id?String(i[0].id):"";tt(d)}rt()}function gt(){if(!n.paymentGrid)return;const t=F(T("payments"),[]);if(!Array.isArray(t)||!t.length){n.paymentGrid.innerHTML=`
        <div class="account-empty">
          <div style="font-weight:1000;">No saved payment methods.</div>
          <div style="margin-top:6px; color:var(--muted); font-weight:800; font-size:13px;">For security, we only store basic labels locally in your browser.</div>
        </div>
      `;return}n.paymentGrid.innerHTML=`
      <div class="profile-grid">
        ${t.map(e=>`
              <div class="profile-item">
                <div class="k">${o(e.label||"Card")}</div>
                <div class="v">
                  <div style="margin-top:6px;">${o(e.brand||"Card")} \u2022\u2022\u2022\u2022 ${o(e.last4||"----")}</div>
                  <div style="margin-top:4px; color:var(--muted); font-weight:800; font-size:13px;">Exp ${o(e.exp||"--/--")}</div>
                  <div style="margin-top:10px;">
                    <button class="btn btn-outline btn-sm" type="button" data-pay-del="${o(e.id)}">Remove</button>
                  </div>
                </div>
              </div>
            `).join("")}
      </div>
    `}function Ne(t){const e=T("payments"),r=F(e,[]),s=Array.isArray(r)?r:[];s.unshift(t),k(e,s),gt()}function Pe(t){const e=T("payments"),r=F(e,[]),s=Array.isArray(r)?r:[];k(e,s.filter(i=>String(i.id)!==String(t))),gt()}function ft(){if(!n.reportsBody)return;const t=u.orders.length;n.reportsBody.innerHTML=`
      <div class="account-empty">
        <div style="font-weight:1000;">Download reports</div>
        <div style="margin-top:6px; color:var(--muted); font-weight:800; font-size:13px;">Export your ${t} order${t===1?"":"s"} for accounting, or download invoices per order.</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-outline" type="button" id="exportOrdersSecondary">Export orders CSV</button>
          <a class="btn btn-outline" href="./contact.html">Need a formal invoice? Contact us</a>
        </div>
      </div>
    `;const e=v("#exportOrdersSecondary");e&&e.addEventListener("click",Qt)}function ke(){if(!n.settingsForm)return;const t=F(T("settings"),{deals:!0,updates:!0}),e=n.settingsForm.querySelector("[name=deals]"),r=n.settingsForm.querySelector("[name=updates]");e&&(e.checked=!!t?.deals),r&&(r.checked=!!t?.updates)}function Ie(){n.settingsForm&&(k(T("settings"),{deals:!!n.settingsForm.querySelector("[name=deals]")?.checked,updates:!!n.settingsForm.querySelector("[name=updates]")?.checked}),A("Settings saved."))}async function Le(){try{const t=await window.PPS?.loadProducts?.();u.products=Array.isArray(t)?t:[],u.productsById=new Map(u.products.map(e=>[String(e.id),e])),window._products=u.products,Xt(),vt(),Zt(),V(),G(),H(),jt();try{const e=window.PPS?.getFavorites?.()||[],r=W();window.PPS_NOTIFS?.refreshFromAccount?.({session:N,orders:u.orders,products:u.products,favorites:e,frequent:r}),window.PPS_NOTIFS?.initAccountCenter?.(),window.PPS_WISHLISTS?.setContext?.({orders:u.orders,products:u.products})}catch{}}catch{}}async function te(){try{const t=await fetch(`${window.PPS?.API_BASE}/api/orders`,{headers:{Authorization:`Bearer ${N.token}`}});if(!t.ok)throw new Error("bad");const e=await t.json();u.orders=Array.isArray(e)?e:[],u.orders.sort((s,i)=>new Date(i.createdAt)-new Date(s.createdAt)),n.ordersUpdatedAt&&(n.ordersUpdatedAt.textContent=`updated ${Z(new Date().toISOString())}`),n.ordersCountBadge&&(n.ordersCountBadge.textContent=String(u.orders.length));const r=u.orders[0];if(n.provinceEl&&r?.customer?.province){const s=window.PPS_I18N?.t("account.province_label")||"{{province}}";n.provinceEl.textContent=s.replace("{{province}}",st(r.customer.province))}Kt(),J(r),V(),G(),vt(),Zt(),H(),jt(),ft();try{const s=window.PPS?.getFavorites?.()||[],i=W();window.PPS_NOTIFS?.refreshFromAccount?.({session:N,orders:u.orders,products:u.products,favorites:s,frequent:i}),window.PPS_NOTIFS?.initAccountCenter?.(),window.PPS_WISHLISTS?.setContext?.({orders:u.orders,products:u.products})}catch{}}catch{n.ordersMsg&&(n.ordersMsg.textContent=window.PPS_I18N?.t("account.status.unreachable")||"Server unreachable. Start the backend to load your orders."),Kt(),J(null),ft()}}if(n.nameEl){const t=window.PPS_I18N?.t("account.welcome_name")||"Welcome, {{name}}",e=window.PPS_I18N?.t("account.welcome_back")||"Welcome back",r=ht(N.name);n.nameEl.textContent=r?t.replace("{{name}}",r):e}n.badgeEl&&(n.badgeEl.style.display="inline-flex"),n.dashboardBadge&&(n.dashboardBadge.style.display="inline-flex"),document.addEventListener("click",t=>{const e=t.target.closest("[data-addr-del]");if(e)return Fe(e.getAttribute("data-addr-del"));const r=t.target.closest("[data-addr-edit]");if(r&&n.addAddressForm){const c=r.getAttribute("data-addr-edit"),p=F(T("addresses"),[]),l=(Array.isArray(p)?p:[]).find(f=>String(f.id)===String(c));if(!l)return;n.addAddressForm.dataset.editId=String(c),["label","name","line1","line2","city","province","postal","country"].forEach(f=>{const h=n.addAddressForm.querySelector(`[name=${f}]`);h&&(h.value=l[f]||"")});const g=n.addAddressForm.querySelector('[name="makeDefault"]');g&&(g.checked=String(wt(p))===String(c)),A("Editing address..."),window.location.hash="#addresses";return}const s=t.target.closest("[data-addr-default]");if(s){const c=String(s.getAttribute("data-addr-default")||"").trim();if(!c)return;tt(c),A("Default address updated."),rt();return}const i=t.target.closest("[data-pay-del]");if(i)return Pe(i.getAttribute("data-pay-del"));const a=t.target.closest("[data-reward-redeem]");if(a){const c=a.getAttribute("data-reward-redeem")||"",{balance:p,ledger:l}=Mt(),f={disc_5:{title:"$5 off your next order",pointsCost:500,valueCents:500,kind:"discount"},disc_10:{title:"$10 off your next order",pointsCost:1e3,valueCents:1e3,kind:"discount"},disc_25:{title:"$25 off your next order",pointsCost:2500,valueCents:2500,kind:"discount"},free_20:{title:"Free product voucher (up to $20)",pointsCost:2e3,valueCents:2e3,kind:"free_product"}}[c];if(!f||p<f.pointsCost)return;const h=se(),$={id:`rw_${Date.now()}`,code:h,kind:f.kind,title:f.title,pointsCost:f.pointsCost,valueCents:f.valueCents,createdAt:new Date().toISOString(),usedAt:""},C=Ct({redemptions:[$,...l?.redemptions||[]]});A(`Redeemed: ${f.title}. Code: ${h}`);try{window.PPS_ACTIVITY?.record?.("reward_redeemed",{title:f.title,code:h,pointsCost:f.pointsCost})}catch{}et();return}const d=t.target.closest("[data-reward-copy]");if(d){const c=d.getAttribute("data-reward-copy")||"";if(!c)return;(async()=>{try{await navigator.clipboard.writeText(c),A("Reward code copied.")}catch{A("Could not copy (clipboard blocked).")}})();return}const m=t.target.closest("[data-reward-mark-used]");if(m){const c=m.getAttribute("data-reward-mark-used")||"";if(!c)return;const l=(At().redemptions||[]).map(g=>!g||String(g.code||"")!==String(c)||g.usedAt?g:{...g,usedAt:new Date().toISOString()});Ct({redemptions:l}),A("Reward marked used.");try{window.PPS_ACTIVITY?.record?.("reward_used",{code:c})}catch{}et();return}}),n.templateSaveFromCart&&n.templateSaveFromCart.addEventListener("click",()=>{const t=window.PPS?.getCart?.()||[];if(!Array.isArray(t)||!t.length){A(y("account.templates.empty_cart","Cart is empty."));return}const e=String(n.templateName?.value||"").trim()||"Weekly Stock";Ht({name:e,items:t.map(r=>({id:r.id,name:r.name,qty:r.qty}))}),n.templateName&&(n.templateName.value="")}),document.addEventListener("click",t=>{const e=t.target.closest("[data-template-reorder]");if(e){const c=e.getAttribute("data-template-reorder"),p=Q().find(l=>String(l.id)===String(c));if(!p)return;Ut(p.items);return}const r=t.target.closest("[data-template-delete]");if(r){const c=r.getAttribute("data-template-delete"),p=Q().filter(l=>String(l.id)!==String(c));ut(p),H(),A(y("account.templates.deleted","Template deleted."));return}const s=t.target.closest("[data-template-rename]");if(s){const c=s.getAttribute("data-template-rename");u.templateEditingId=String(c||""),H();return}const i=t.target.closest("[data-template-rename-save]");if(i){const c=i.getAttribute("data-template-rename-save"),p=i.closest(".card"),l=p?p.querySelector("[data-template-edit-name]"):null,g=String(l?.value||"").trim();if(!g){A(y("account.templates.enter_name","Enter a template name."));return}const f=Q(),h=f.find($=>String($.id)===String(c));if(!h)return;h.name=g,h.updatedAt=new Date().toISOString(),ut(f),u.templateEditingId="",H(),A(y("account.templates.renamed","Template renamed."));return}if(t.target.closest("[data-template-rename-cancel]")){u.templateEditingId="",H();return}const d=t.target.closest("[data-combo-reorder]");if(d){const c=d.getAttribute("data-combo-reorder"),p=mt().find(l=>String(l.sig)===String(c));if(!p)return;Ut(p.items);return}const m=t.target.closest("[data-combo-save]");if(m){const c=m.getAttribute("data-combo-save"),p=mt().find(h=>String(h.sig)===String(c));if(!p)return;const l=p.title.replace(/^Your usual:\s*/i,"").slice(0,40),f=String(n.templateName?.value||"").trim()||(l?`Weekly Stock - ${l}`:"Weekly Stock");Ht({name:f,items:p.items}),n.templateName&&(n.templateName.value="");return}}),window.addEventListener("hashchange",Tt),Tt(),n.orderSearch&&n.orderSearch.addEventListener("input",V),n.orderStatus&&n.orderStatus.addEventListener("change",V),n.orderRange&&n.orderRange.addEventListener("change",V),n.exportOrdersBtn&&n.exportOrdersBtn.addEventListener("click",Qt),n.invoiceSearch&&n.invoiceSearch.addEventListener("input",G),n.invoiceStatus&&n.invoiceStatus.addEventListener("change",G),n.invoiceFrom&&n.invoiceFrom.addEventListener("change",G),n.invoiceTo&&n.invoiceTo.addEventListener("change",G),n.downloadInvoicesRangeBtn&&n.downloadInvoicesRangeBtn.addEventListener("click",we),n.addAddressForm&&n.addAddressForm.addEventListener("submit",t=>{t.preventDefault();const e=n.addAddressForm.dataset.editId||`addr_${Date.now()}`,r={id:e};["label","name","line1","line2","city","province","postal","country"].forEach(a=>{r[a]=n.addAddressForm.querySelector(`[name=${a}]`)?.value?.trim?.()||""}),r.country||(r.country="Canada"),Te(r);const s=!!n.addAddressForm.querySelector('[name="makeDefault"]')?.checked,i=ot();(s||!i)&&tt(e),n.addAddressForm.reset(),delete n.addAddressForm.dataset.editId,A("Address saved.");try{window.PPS_ACTIVITY?.record?.("address_saved",{label:r.label||""})}catch{}});const ee=document.getElementById("addrCancelEdit");ee&&n.addAddressForm&&ee.addEventListener("click",()=>{n.addAddressForm.reset(),delete n.addAddressForm.dataset.editId,A("Address edit cancelled.")}),n.addPaymentForm&&n.addPaymentForm.addEventListener("submit",t=>{t.preventDefault();const e=n.addPaymentForm.querySelector("[name=label]")?.value?.trim?.()||"",r=n.addPaymentForm.querySelector("[name=brand]")?.value?.trim?.()||"",s=String(n.addPaymentForm.querySelector("[name=last4]")?.value||"").replace(/\D/g,"").slice(-4),i=n.addPaymentForm.querySelector("[name=exp]")?.value?.trim?.()||"";if(s.length!==4)return A("Enter the last 4 digits.");Ne({id:`pm_${Date.now()}`,label:e,brand:r,last4:s,exp:i}),n.addPaymentForm.reset(),A("Payment method saved.");try{window.PPS_ACTIVITY?.record?.("payment_saved",{label:e||(r?`${r} \u2022\u2022\u2022\u2022${s}`:"")})}catch{}}),n.businessForm&&n.businessForm.addEventListener("submit",t=>{t.preventDefault();const e={company:n.businessForm.querySelector('[name="company"]')?.value?.trim?.()||"",taxId:n.businessForm.querySelector('[name="taxId"]')?.value?.trim?.()||"",billingEmail:n.businessForm.querySelector('[name="billingEmail"]')?.value?.trim?.()||"",invoiceByEmail:!!n.businessForm.querySelector('[name="invoiceByEmail"]')?.checked};k(Pt,e),n.businessMsg&&(n.businessMsg.textContent="Business profile saved.");try{window.PPS_ACTIVITY?.record?.("business_profile_saved",{company:e.company||""})}catch{}}),n.businessTierForm&&n.businessTierForm.addEventListener("submit",t=>{t.preventDefault();const e=n.businessTierForm.querySelector('[name="tier"]')?.value||"starter",r=Number(n.businessTierForm.querySelector('[name="volume"]')?.value||0),s=!!n.businessTierForm.querySelector('[name="contractPricing"]')?.checked;k(kt,{tier:e,volume:r,contractPricing:s}),R()}),n.rfqForm&&n.rfqForm.addEventListener("submit",t=>{t.preventDefault();const e=n.rfqForm.querySelector('[name="items"]')?.value?.trim?.()||"";k(It,{items:e,createdAt:Date.now()}),n.rfqOutput&&(n.rfqOutput.textContent="RFQ submitted. Our team will respond within 1 business day."),n.rfqForm.reset()}),n.netTermsForm&&n.netTermsForm.addEventListener("submit",t=>{t.preventDefault();const e=n.netTermsForm.querySelector('[name="terms"]')?.value||"net30",r=!!n.netTermsForm.querySelector('[name="requestTerms"]')?.checked;k(Lt,{terms:e,requested:r,createdAt:Date.now()}),R()}),n.poUploadForm&&n.poUploadForm.addEventListener("submit",t=>{t.preventDefault();const e=n.poUploadForm.querySelector('[name="poFile"]')?.files?.[0];if(!e){n.poUploadOutput&&(n.poUploadOutput.textContent="Upload a PO file to continue.");return}k(Et,{filename:e.name,createdAt:Date.now()}),R(),n.poUploadForm.reset()}),n.approvalForm&&n.approvalForm.addEventListener("submit",t=>{t.preventDefault();const e=n.approvalForm.querySelector('[name="approverEmail"]')?.value?.trim?.()||"",r=Number(n.approvalForm.querySelector('[name="approverLimit"]')?.value||0);if(!e)return;const s=F(ct,[]);s.unshift({email:e,limit:r}),k(ct,s.slice(0,10)),n.approvalForm.reset(),R()}),n.bulkTemplateForm&&n.bulkTemplateForm.addEventListener("submit",t=>{t.preventDefault();const e=n.bulkTemplateForm.querySelector('[name="templateName"]')?.value?.trim?.()||"Template",r=n.bulkTemplateForm.querySelector('[name="templateItems"]')?.value?.trim?.()||"",s=F(lt,[]);s.unshift({name:e,items:r,createdAt:Date.now()}),k(lt,s.slice(0,10)),n.bulkTemplateForm.reset(),R()}),n.csvUploadForm&&n.csvUploadForm.addEventListener("submit",t=>{t.preventDefault();const e=n.csvUploadForm.querySelector('[name="csvFile"]')?.files?.[0];if(!e){n.csvUploadOutput&&(n.csvUploadOutput.textContent="Upload a CSV to preview.");return}const r=new FileReader;r.onload=()=>{const i=String(r.result||"").split(/\r?\n/).filter(Boolean);k(qt,{filename:e.name,rows:i.length,createdAt:Date.now()}),n.csvUploadOutput&&(n.csvUploadOutput.textContent=`CSV uploaded: ${e.name} (${i.length} rows).`)},r.readAsText(e)}),n.repAssignForm&&n.repAssignForm.addEventListener("submit",t=>{t.preventDefault();const e=n.repAssignForm.querySelector('[name="rep"]')?.value||"angel";k(Bt,{rep:e,label:{angel:"Angel (Sales)",andrew:"Andrew (Product guidance)",achchu:"Achchu (Orders)"}[e]||e,createdAt:Date.now()}),R()}),n.creditAppForm&&n.creditAppForm.addEventListener("submit",t=>{t.preventDefault();const e={legalName:n.creditAppForm.querySelector('[name="legalName"]')?.value?.trim?.()||"",years:Number(n.creditAppForm.querySelector('[name="years"]')?.value||0),annualSpend:Number(n.creditAppForm.querySelector('[name="annualSpend"]')?.value||0),createdAt:Date.now()};k(_t,e),R(),n.creditAppForm.reset()}),n.downloadStatement&&n.downloadStatement.addEventListener("click",()=>{const t=["Power Poly Supplies - Monthly Statement",`Generated: ${new Date().toLocaleString()}`,`Account: ${N.email}`,"",`Orders: ${u.orders.length}`],e=new Blob([t.join(`
`)],{type:"text/plain"}),r=URL.createObjectURL(e),s=document.createElement("a");s.href=r,s.download="pps_statement.txt",document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(r)}),n.settingsForm&&n.settingsForm.addEventListener("submit",t=>{t.preventDefault(),Ie();try{window.PPS_ACTIVITY?.record?.("settings_update",{})}catch{}}),n.milestonesPrefsForm&&n.milestonesPrefsForm.addEventListener("submit",t=>{t.preventDefault();const e=!!n.milestonesPrefsForm.querySelector('[name="showMilestones"]')?.checked;ne({showMilestones:e}),A("Milestones settings saved."),zt(),Gt()}),n.logoutBtn&&n.logoutBtn.addEventListener("click",async()=>{try{await fetch(`${window.PPS?.API_BASE}/api/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${N.token}`}})}catch{}try{window.PPS_ACTIVITY?.record?.("logout",{})}catch{}window.PPS?.clearSession?.(),window.location.href="./login.html"}),rt(),gt(),ke(),Gt(),ft(),Me(),R(),Le(),te(),setInterval(()=>{te()},3e4)})();
