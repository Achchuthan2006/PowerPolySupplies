(()=>{"use strict";const n=(t,e)=>{try{return window.PPS_I18N?.t?.(t)||e}catch{return e}},E=(t,e,s)=>Math.min(s,Math.max(e,t));function I(t){const e=String(t||"");let s=2166136261;for(let a=0;a<e.length;a++)s^=e.charCodeAt(a),s=Math.imul(s,16777619);return s>>>0}function w(t){const e=Date.now(),s=7+I(t?.id||t?.slug||"")%15,a=new Date(e+s*24*60*60*1e3);return a.setHours(23,59,59,999),a.getTime()}function k(t){try{return new Date(t).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch{return""}}function T(t){const e=Math.max(0,Math.floor(t/1e3)),s=Math.floor(e/86400),a=Math.floor(e%86400/3600),o=Math.floor(e%3600/60);return s>0?`${s}d ${a}h`:a>0?`${a}h ${o}m`:`${Math.max(0,o)}m`}function P(t){const e=window.PPS_I18N?.getLang?.()||"en";return e==="fr"?{"Garment Bags":"Housses de vetements",Hangers:"Cintres",Polybags:"Sacs en poly",Wraps:"Films",Racks:"Portants"}[t]||t||"":e==="ko"?{"Garment Bags":"Garment Bags",Hangers:"Hangers",Polybags:"Polybags",Wraps:"Wraps",Racks:"Racks"}[t]||t||"":e==="es"?{"Garment Bags":"Bolsas para prendas",Hangers:"Ganchos",Polybags:"Bolsas de polietileno",Wraps:"Film",Racks:"Percheros"}[t]||t||"":t||""}function B(t){if(String(t||"")!=="Hangers")return"";const s=n("pack.label","Pack"),a=n("pack.hangers_500","500 pcs / box");return`
      <div class="feature-badges" aria-label="${s}">
        <span class="feature-pill">${a}</span>
      </div>
    `}function $(t){return t<=0?"out":t<=10?"low":"in"}function S(t){return t<=0?n("specials.stock.out","Out of stock"):t<=10?n("specials.stock.low","Almost out of stock"):n("specials.stock.in","In stock")}const A='<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s-6.7-4.4-9.5-7.2A5.6 5.6 0 0 1 12 5.6a5.6 5.6 0 0 1 9.5 8.2C18.7 16.6 12 21 12 21z"/></svg>';function C(t){return t?n("favorite.remove","Remove from favorites"):n("favorite.add","Add to favorites")}function N(t){const e=window.PPS?.isFavorite?.(t);return`<button class="favorite-btn ${e?"active":""}" type="button" data-fav-id="${t}" aria-pressed="${e?"true":"false"}" title="${C(e)}">${A}</button>`}function x(t){const e=t.dataset.favId,s=window.PPS?.isFavorite?.(e);t.classList.toggle("active",s),t.setAttribute("aria-pressed",s?"true":"false"),t.title=C(s)}function D(){document.addEventListener("click",t=>{const e=t.target.closest(".favorite-btn");e&&(t.preventDefault(),t.stopPropagation(),window.PPS?.toggleFavorite?.(e.dataset.favId),x(e))}),window.addEventListener("pps:favorites",()=>{document.querySelectorAll(".favorite-btn").forEach(x)})}function _(t,e=8){t.innerHTML=new Array(e).fill(0).map(()=>'<div class="card skeleton"></div>').join("")}function Q(t){const e=window.PPS.getComparePriceCents?.(t)??(Number(t.priceCents)||0)+1e3,s=Number(t.priceCents)||0,a=Math.max(0,e-s),o=e>0?Math.round(a/e*100):0;return{compareCents:e,memberCents:s,savingsCents:a,pct:E(o,0,90)}}function q(t,e){const s=new Date(t);let a=Math.max(0,Math.floor(Number(e)||0));for(;a>0;){s.setDate(s.getDate()+1);const o=s.getDay();o===0||o===6||a--}return s}function M(t){try{return new Date(t).toLocaleDateString(void 0,{month:"short",day:"numeric"})}catch{return""}}function b(t,e){try{return window.PPS?.getTieredPriceCents?.(t,e)??Math.round(Number(t?.priceCents)||0)}catch{return Math.round(Number(t?.priceCents)||0)}}function y(t,e){const s=Math.max(1,Math.floor(Number(e)||1));return Number.isFinite(t?.stock)&&t.stock>0?Math.min(s,t.stock):s}function f(t,e){const s=Number(e)||0,a=t?.stock<=0||Number.isFinite(t?.stock)&&t.stock>0&&t.stock<s,o=b(t,s),i=s>=20?n("specials.bulk.20","20+ boxes"):s>=15?n("specials.bulk.15","15+ boxes"):n("specials.bulk.10","10+ boxes");return`
      <button class="pricing-tier" type="button" data-tier-qty="${s}" ${a?"disabled":""}>
        <strong>${i}</strong>
        <span>${window.PPS.money(o,t.currency)}</span>
      </button>
    `}function H(t){const e=document.getElementById("spotQty"),s=document.getElementById("spotQtyMinus"),a=document.getElementById("spotQtyPlus"),o=document.getElementById("spotQtyTotal"),i=document.getElementById("spotQtyNote"),d=document.getElementById("spotDeliveryEstimate"),c=document.getElementById("spotShareBtn"),l=document.getElementById("spotShareMsg");function p(){if(!e||!o||!i)return;const r=y(t,e.value);e.value=String(r);const u=b(t,r),g=u*r;o.textContent=`Total: ${window.PPS.money(g,t.currency)}`;const h=r>=20?"20+ pricing applied":r>=15?"15+ pricing applied":r>=10?"10+ pricing applied":"Standard pricing";i.textContent=`${window.PPS.money(u,t.currency)} / box \xB7 ${h}`}function m(r){e&&(e.value=String(y(t,r)),p())}if(e&&(e.addEventListener("input",p),e.addEventListener("blur",()=>m(e.value)),p()),s&&s.addEventListener("click",()=>m((Number(e?.value)||1)-1)),a&&a.addEventListener("click",()=>m((Number(e?.value)||1)+1)),document.querySelectorAll("[data-tier-qty]").forEach(r=>{r.addEventListener("click",()=>{const u=Number(r.getAttribute("data-tier-qty")||0)||1;if(m(u),!window.PPS?.addToCart||t?.stock<=0)return;window.PPS.addToCart(t,u);const g=r.innerHTML,h=n("specials.added_qty","Added {{qty}}")||"Added {{qty}}";r.innerHTML=`<strong>${h.replace("{{qty}}",String(u))}</strong><span>${window.PPS.money(b(t,u),t.currency)}</span>`,r.disabled=!0,setTimeout(()=>{r.innerHTML=g,r.disabled=!1},900)})}),d){const r=q(new Date,2),u=q(new Date,5);d.textContent=`Estimated delivery: ${M(r)} \u2013 ${M(u)} (business days)`}function v(r){l&&(l.textContent=r||"")}if(c){const r=new URL("./product.html",window.location.href);r.searchParams.set("slug",String(t?.slug||""));const u={title:String(t?.name||""),text:`${String(t?.name||"")} - Power Poly Supplies`,url:r.toString()};c.addEventListener("click",async()=>{if(navigator.share)try{await navigator.share(u),v(window.PPS_I18N?.t("product.share.sent")||"Thanks for sharing.");return}catch(g){if(g&&g.name==="AbortError")return;v(window.PPS_I18N?.t("product.share.fail")||"Unable to share right now.");return}if(navigator.clipboard?.writeText)try{await navigator.clipboard.writeText(u.url),v(window.PPS_I18N?.t("product.share.copied")||"Link copied to clipboard.");return}catch{}v(window.PPS_I18N?.t("product.share.manual")||"Copy the URL from the address bar.")})}}function R(t,e,s){if(!t)return;const a=w(e),o=k(a),i=n("specials.save_pct","Save {{pct}}%"),d=n("specials.limited","Limited-time"),c=n("specials.deal_of_day","Deal of the day"),l=(n("specials.ends_on","Ends {{date}}")||"Ends {{date}}").replace("{{date}}",o),p=n("specials.view","View"),m=n("specials.add","Add"),v=n("product.bulk_quote","Bulk quote");t.style.display="",t.innerHTML=`
      <div class="specials-spotlight-head">
        <div>
          <div class="specials-spotlight-kicker">${c}</div>
          <div class="specials-spotlight-badges">
            <span class="specials-badge specials-badge-save">${i.replace("{{pct}}",String(s.pct))}</span>
            <span class="specials-badge specials-badge-limited">${d}</span>
            <span class="specials-badge specials-badge-ends">${l}</span>
          </div>
        </div>
        <div class="specials-countdown" data-ends="${a}"></div>
      </div>

      <div class="specials-spotlight-body">
        <a class="specials-spotlight-media" href="./product.html?slug=${encodeURIComponent(e.slug)}">
          <img src="${e.image}" alt="${e.name||""}" loading="lazy" decoding="async" width="640" height="280">
        </a>
         <div class="specials-spotlight-info">
           <a class="specials-spotlight-title" href="./product.html?slug=${encodeURIComponent(e.slug)}">${e.name||""}</a>
           <div class="card-meta">${P(e.category)}</div>
           <div class="member-pricing">
             <div>
               <div class="market-label" data-i18n="market.price.label">Market price</div>
               <span class="compare-price">${window.PPS.money(s.compareCents,e.currency)}</span>
             </div>
             <div>
               <div class="member-label" data-i18n="member.price.label">Power Poly Member Price</div>
               <span class="price">${window.PPS.money(s.memberCents,e.currency)}</span>
             </div>
           </div>
           <div class="stock ${$(e.stock)}" style="margin-top:10px;">
             <span class="dot"></span>
             ${S(e.stock)}
           </div>

           <div class="pricing-tiers">
             <div class="pricing-tiers-header" data-i18n="product.bulk">${n("product.bulk","Bulk pricing")}</div>
             <div class="pricing-tiers-grid">
               ${f(e,10)}
               ${f(e,15)}
               ${f(e,20)}
             </div>
           </div>

           <div class="qty-row" style="margin-top:16px;">
             <div class="qty-stepper" aria-label="Quantity selector">
               <button class="qty-btn" type="button" id="spotQtyMinus" aria-label="Decrease quantity">-</button>
               <input class="qty-input" id="spotQty" inputmode="numeric" pattern="[0-9]*" value="1" aria-label="Quantity">
               <button class="qty-btn" type="button" id="spotQtyPlus" aria-label="Increase quantity">+</button>
             </div>
             <div class="qty-meta">
               <div class="qty-total" id="spotQtyTotal"></div>
               <div class="qty-note" id="spotQtyNote"></div>
             </div>
           </div>

           <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
             <a class="btn btn-outline" href="./product.html?slug=${encodeURIComponent(e.slug)}">${p}</a>
             <button class="btn btn-primary" ${e.stock<=0?"disabled":""} data-add-id="${e.id}" data-qty-input="spotQty">${m}</button>
             <a class="btn" href="./cart.html" data-i18n="specials.action.cart">${n("specials.action.cart","Go to cart")}</a>
             <a class="btn btn-outline" href="./contact.html?subject=${encodeURIComponent("Bulk quote")}&product=${encodeURIComponent(e.name||"")}">${v}</a>
           </div>

           <div class="delivery-estimate" id="spotDeliveryEstimate" aria-live="polite"></div>
           <div style="margin-top:10px;">
             <button class="share-btn" type="button" id="spotShareBtn" aria-label="${window.PPS_I18N?.t("product.share")||"Share"}">
               <span class="share-icon" aria-hidden="true">
                 <svg viewBox="0 0 24 24" width="16" height="16" focusable="false" aria-hidden="true">
                   <path d="M5 12v7a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                   <path d="M12 4v12" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                   <path d="M7.5 8.5 12 4l4.5 4.5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                 </svg>
               </span>
               <span data-i18n="product.share">Share</span>
             </button>
             <div id="spotShareMsg" style="color:var(--muted); font-size:12px; margin-top:6px;"></div>
           </div>
         </div>
       </div>
     `}function U(t,e,s){const o=(window.PPS_I18N?.getLang?.()||"en")==="es"&&window.PPS_I18N?.autoTranslate?.(t.name||"","es")||t.name,i=!!window.PPS.getSession?.(),c=(n("member.banner","Log in to save {{amount}} with Power Poly Member Pricing")||"Log in to save {{amount}} with Power Poly Member Pricing").replace("{{amount}}",window.PPS.money(e.savingsCents,t.currency)),l=n("specials.save_pct","Save {{pct}}%"),p=n("specials.limited","Limited-time"),m=k(s),v=(n("specials.ends_on","Ends {{date}}")||"Ends {{date}}").replace("{{date}}",m);return`
      <div class="card fade-in specials-card" data-ends="${s}">
        <div class="specials-media">
          <a href="./product.html?slug=${encodeURIComponent(t.slug)}">
            <img src="${t.image}" alt="${o}" loading="lazy" decoding="async" width="400" height="190">
          </a>
          <div class="specials-badges">
            <span class="specials-badge specials-badge-save">${l.replace("{{pct}}",String(e.pct))}</span>
            <span class="specials-badge specials-badge-limited">${p}</span>
          </div>
          <div class="specials-ends">${v}</div>
        </div>

        <div class="card-body">
          <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(t.slug)}">${o}</a>
          <div class="specials-meta-row">
            <div class="card-meta">${P(t.category)}</div>
            <div class="specials-countdown" data-ends="${s}"></div>
          </div>
          ${B(t.category)}

          <div class="member-pricing">
            <div>
              <div class="market-label" data-i18n="market.price.label">Market price</div>
              <span class="compare-price">${window.PPS.money(e.compareCents,t.currency)}</span>
            </div>
            <div>
              <div class="member-label" data-i18n="member.price.label">Power Poly Member Price</div>
              <span class="price">${window.PPS.money(e.memberCents,t.currency)}</span>
            </div>
            ${N(t.id)}
          </div>

          ${!i&&e.savingsCents>0?`<a class="member-banner" href="./login.html">${c}</a>`:""}

          <div class="stock ${$(t.stock)}">
            <span class="dot"></span>
            ${S(t.stock)}
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <a class="btn" href="./product.html?slug=${encodeURIComponent(t.slug)}">${n("specials.view","View")}</a>
            <button class="btn btn-primary" ${t.stock<=0?"disabled":""} data-add-id="${t.id}">${n("specials.add","Add")}</button>
            <a class="btn btn-outline" href="./cart.html" data-i18n="specials.action.cart">${n("specials.action.cart","Go to cart")}</a>
          </div>

          <div class="bulk-quick">
            <button class="btn btn-outline" ${t.stock<=0?"disabled":""} data-bulk-id="${t.id}" data-bulk-qty="10">${n("specials.bulk.10","10+ boxes")}</button>
            <button class="btn btn-outline" ${t.stock<=0?"disabled":""} data-bulk-id="${t.id}" data-bulk-qty="15">${n("specials.bulk.15","15+ boxes")}</button>
            <button class="btn btn-outline" ${t.stock<=0?"disabled":""} data-bulk-id="${t.id}" data-bulk-qty="20">${n("specials.bulk.20","20+ boxes")}</button>
          </div>
        </div>
      </div>
    `}function L(){const t=Date.now();document.querySelectorAll(".specials-countdown[data-ends]").forEach(e=>{const s=Number(e.getAttribute("data-ends")||0),a=s-t;if(e.classList.remove("urgent","soon","expired"),!Number.isFinite(s)||s<=0){e.textContent="";return}if(a<=0){e.textContent=n("specials.expired","Expired"),e.classList.add("expired");return}a<=1440*60*1e3?e.classList.add("urgent"):a<=4320*60*1e3&&e.classList.add("soon");const o=n("specials.ends_in","Ends in {{time}}")||"Ends in {{time}}";e.textContent=o.replace("{{time}}",T(a))})}function F(t){document.addEventListener("click",e=>{const s=e.target.closest("[data-add-id]");if(s){const o=s.getAttribute("data-add-id"),i=t.find(v=>v.id===o);if(!i||i.stock<=0)return;const d=s.getAttribute("data-qty-input"),c=d?document.getElementById(d):null,l=y(i,c?.value||1);window.PPS.addToCart(i,l);const p=s.textContent,m=n("specials.added_qty","Added {{qty}}")||"Added {{qty}}";s.textContent=l>1?m.replace("{{qty}}",String(l)):n("specials.added","Added"),s.disabled=!0,setTimeout(()=>{s.textContent=p,s.disabled=!1},800);return}const a=e.target.closest("[data-bulk-id]");if(a){const o=a.getAttribute("data-bulk-id"),i=Number(a.getAttribute("data-bulk-qty")||0)||0,d=t.find(p=>p.id===o);if(!d||d.stock<=0||i<=0)return;window.PPS.addToCart(d,i);const c=a.textContent,l=n("specials.added_qty","Added {{qty}}")||"Added {{qty}}";a.textContent=l.replace("{{qty}}",String(i)),a.disabled=!0,setTimeout(()=>{a.textContent=c,a.disabled=!1},800)}})}async function G(){const t=document.getElementById("grid");if(t){D(),_(t);try{const s=(await window.PPS.loadProducts()).filter(i=>i.special===!0);if(s.length===0){const i=n("specials.none","No specials yet.");t.innerHTML=`<div class="card" style="padding:14px;">${i}</div>`;return}const a=s.map(i=>{const d=Q(i),c=w(i);return{p:i,deal:d,endsAt:c}}),o=a.slice().sort((i,d)=>d.deal.pct-i.deal.pct||d.deal.savingsCents-i.deal.savingsCents)[0];R(document.getElementById("specialsSpotlight"),o.p,o.deal);try{H(o.p)}catch{}t.innerHTML=a.sort((i,d)=>d.deal.pct-i.deal.pct||i.endsAt-d.endsAt).map(({p:i,deal:d,endsAt:c})=>U(i,d,c)).join(""),document.querySelectorAll(".fade-in").forEach(i=>i.classList.add("show")),F(s),L(),setInterval(L,1e3)}catch(e){const s=n("specials.error","Unable to load specials right now. Please refresh.");t.innerHTML=`<div class="card" style="padding:14px;">${s}</div>`,console.error("Failed to load specials",e)}}}window.addEventListener("DOMContentLoaded",G)})();
