(()=>{"use strict";const i=e=>document.querySelector(e),n={msg:i("#paymentMethodsMsg"),list:i("#paymentMethodsList"),setupMsg:i("#pmSetupMsg"),cardSlot:i("#squareCard"),cardholder:i("#pmCardholder"),saveBtn:i("#pmSaveCard")},c=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),u=()=>window.PPS?.getSession?.()||null,S=()=>String(window.PPS?.API_BASE||"").trim().replace(/\/+$/,""),d=e=>{n.msg&&(n.msg.textContent=String(e||""))},s=e=>{n.setupMsg&&(n.setupMsg.textContent=String(e||""))},v=()=>{const e=String(window.SQUARE_APP_ID||"").trim(),t=String(window.SQUARE_LOCATION_ID||"").trim();return!!(e&&t)},h=()=>String(window.SQUARE_ENV||"").trim().toLowerCase()==="sandbox"?"sandbox":"production",y=async()=>{if(window.Square&&window.Square.payments)return!0;const e=document.querySelector('script[data-square-payments="1"]');if(e)return await new Promise(a=>{e.addEventListener("load",a,{once:!0}),e.addEventListener("error",a,{once:!0})}),!!(window.Square&&window.Square.payments);const t=document.createElement("script");return t.dataset.squarePayments="1",t.src=h()==="sandbox"?"https://sandbox.web.squarecdn.com/v1/square.js":"https://web.squarecdn.com/v1/square.js",t.async=!0,document.head.appendChild(t),await new Promise(a=>{t.addEventListener("load",a,{once:!0}),t.addEventListener("error",a,{once:!0})}),!!(window.Square&&window.Square.payments)},m=async(e,t={})=>{const a=S();if(!a)throw new Error("API base not configured.");const r=await fetch(`${a}${e}`,t),o=await r.json().catch(()=>({}));if(!r.ok||o?.ok===!1){const w=o?.message||`Request failed (${r.status})`;throw new Error(w)}return o},f=async()=>{const e=u();if(!e)return d("Log in to manage payment methods."),[];try{const t=await m("/api/account/payment-methods",{headers:{Authorization:`Bearer ${e.token}`}});return Array.isArray(t.methods)?t.methods:[]}catch(t){return d(String(t?.message||"Unable to load payment methods.")),[]}},l=async()=>{if(!n.list)return;const e=await f();e.length?n.list.innerHTML=e.map(t=>{const a=String(t.brand||t.cardBrand||"Card"),r=String(t.last4||""),o=t.expMonth&&t.expYear?`${String(t.expMonth).padStart(2,"0")}/${String(t.expYear).slice(-2)}`:"",w=String(t.id||"");return`
            <div class="pm-item" data-pm-id="${c(w)}">
              <div class="pm-top">
                <div>
                  <div style="font-weight:1000;">${c(a)} ${r?`\u2022\u2022\u2022\u2022 ${c(r)}`:""}</div>
                  <div class="pm-meta">${o?`Expires ${c(o)}`:""}</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn btn-outline btn-sm" type="button" data-pm-remove>Remove</button>
                </div>
              </div>
            </div>
          `}).join(""):n.list.innerHTML='<div style="color:var(--muted); font-size:13px;">No saved cards yet.</div>'};let g=null,p=null;const b=async()=>{if(!n.cardSlot||!n.saveBtn)return;if(!u()){s("Log in to add a card."),n.saveBtn.disabled=!0;return}if(!v()){s("Square card saving is not configured. Set `window.SQUARE_APP_ID`, `window.SQUARE_LOCATION_ID`, and `window.SQUARE_ENV` in `frontend/config.js`."),n.saveBtn.disabled=!0;return}if(!await y()){s("Unable to load Square card input."),n.saveBtn.disabled=!0;return}try{const a=String(window.SQUARE_APP_ID||"").trim(),r=String(window.SQUARE_LOCATION_ID||"").trim();g=window.Square.payments(a,r),p=await g.card(),await p.attach("#squareCard"),n.saveBtn.disabled=!1,s("")}catch(a){s(String(a?.message||"Unable to initialize card input.")),n.saveBtn.disabled=!0}},E=async()=>{const e=u();if(e&&p){n.saveBtn.disabled=!0,s("Saving card...");try{const t=await p.tokenize({cardholderName:String(n.cardholder?.value||"").trim()||void 0});if(t.status!=="OK"||!t.token)throw new Error("Card verification failed.");await m("/api/account/payment-methods",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`},body:JSON.stringify({sourceId:t.token})}),s("Card saved."),await l()}catch(t){s(String(t?.message||"Unable to save card."))}finally{n.saveBtn.disabled=!1}}},_=async e=>{const t=u();if(t){d("Removing card...");try{await m(`/api/account/payment-methods/${encodeURIComponent(e)}`,{method:"DELETE",headers:{Authorization:`Bearer ${t.token}`}}),d(""),await l()}catch(a){d(String(a?.message||"Unable to remove card."))}}},q=async()=>{window.__pps_payment_methods_inited||n.list&&(window.__pps_payment_methods_inited=!0,await l(),await b(),n.saveBtn?.addEventListener("click",E),document.addEventListener("click",e=>{const t=e.target.closest("[data-pm-remove]");if(!t)return;const r=t.closest("[data-pm-id]")?.getAttribute("data-pm-id")||"";r&&_(r)}))};window.PPS_PAYMENT_METHODS={init:q,render:l}})();
