document.getElementById("y").textContent=new Date().getFullYear(),PPS.updateCartBadge();let productMap=null,productsList=[];const goCheckout=document.getElementById("goCheckout"),GO_CHECKOUT_DEFAULT=goCheckout?{href:goCheckout.getAttribute("href")||"./checkout.html",i18n:goCheckout.getAttribute("data-i18n")||"cart.checkout",text:(goCheckout.textContent||"").trim()}:null;function setCheckoutCtaState(t){if(goCheckout){if(t){goCheckout.dataset.checkoutEmpty="1",goCheckout.dataset.i18n="cart.empty.checkout_cta",goCheckout.setAttribute("href","./products.html"),goCheckout.textContent=window.PPS_I18N?.t("cart.empty.checkout_cta")||"Browse products";return}delete goCheckout.dataset.checkoutEmpty,goCheckout.dataset.i18n=GO_CHECKOUT_DEFAULT?.i18n||"cart.checkout",goCheckout.setAttribute("href",GO_CHECKOUT_DEFAULT?.href||"./checkout.html"),goCheckout.textContent=window.PPS_I18N?.t(GO_CHECKOUT_DEFAULT?.i18n||"cart.checkout")||GO_CHECKOUT_DEFAULT?.text||"Go to checkout"}}const productsPromise=PPS.loadProducts().then(t=>{productsList=Array.isArray(t)?t:[],productMap=new Map(productsList.map(e=>[e.id,e]))});function addBusinessDays(t,e){const s=new Date(t.getTime());let r=Math.max(0,Number(e)||0);for(;r>0;){s.setDate(s.getDate()+1);const d=s.getDay();d!==0&&d!==6&&(r-=1)}return s}function formatShortDate(t){try{return new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"}).format(t)}catch{return t.toDateString()}}function getLastOrderKey(){const t=PPS.getSession?.(),e=String(t?.email||"").trim().toLowerCase();return e?`pps_last_order_${e}`:"pps_last_order_guest"}function readLastOrder(){try{const t=localStorage.getItem(getLastOrderKey()),e=JSON.parse(t||"null");return!e||!Array.isArray(e.items)?null:e}catch{return null}}function getItemDescription(t){const e=window.PPS_I18N?.getLang?.()||"en",s=e==="fr"?t.description_fr||t.description||"":e==="ko"?t.description_ko||t.description||"":e==="hi"?t.description_hi||t.description||"":e==="ta"?t.description_ta||t.description||"":e==="es"?window.PPS_I18N?.autoTranslate?.(t.description_es||t.description||"","es")||t.description_es||t.description||"":t.description||t.description_fr||t.description_ko||t.description_hi||t.description_ta||t.description_es||"";if(s)return s;if(!productMap)return"";const r=productMap.get(t.id);return r?e==="fr"?r.description_fr||r.description||"":e==="ko"?r.description_ko||r.description||"":e==="hi"?r.description_hi||r.description||"":e==="ta"?r.description_ta||r.description||"":e==="es"?window.PPS_I18N?.autoTranslate?.(r.description_es||r.description||"","es")||r.description_es||r.description||"":r.description||r.description_fr||r.description_ko||r.description_hi||r.description_ta||r.description_es||"":""}function render(){const t=PPS.getCart(),e=document.getElementById("cartList"),s=document.getElementById("total"),r=document.getElementById("cartEstimate"),d=document.getElementById("bulkSavingsRow"),p=document.getElementById("bulkSavingsAmount"),i=document.getElementById("reorderBtn"),y=document.getElementById("crossSellSection"),g=document.getElementById("crossSellGrid"),b=document.querySelector(".cart-hero-illustration"),f=document.getElementById("cartLoadBoxes");function S(n){b&&(b.setAttribute("data-cart-state",n),n==="empty"&&f&&(f.innerHTML=""))}function v(){if(!b||!f)return;const n=Array.isArray(t)?t.reduce((o,c)=>o+(Number(c?.qty)||0),0):0;if(n<=0){S("empty");return}S("filled");const a=Math.min(7,Math.max(2,Math.ceil(n/3)));f.innerHTML=Array.from({length:a}).map((o,c)=>{const l=(c*.32).toFixed(2),h=10+c%3*6,m=22+c%2*5,k=15+c%2*2,P=11+(c+1)%2*2;return`<span class="cart-load-box" style="--d:${l}s; left:${h}px; bottom:${m}px; width:${k}px; height:${P}px;"></span>`}).join("")}if(v(),t.length===0){setCheckoutCtaState(!0);const n=window.PPS_I18N?.t("cart.empty")||"Your cart is empty.",a=window.PPS_I18N?.t("cart.empty.title")||n,o=window.PPS_I18N?.t("cart.empty.body")||"Browse products and build your next bulk order in minutes.",c=window.PPS_I18N?.t("cart.empty.cta")||"Browse products";e.innerHTML=`
      <div class="card cart-empty fade-in">
        <div class="cart-empty-visual" aria-hidden="true">
          <svg class="cart-empty-cart" viewBox="0 0 260 160" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="ppsCartEmptyStroke" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="rgba(17,24,39,.22)"/>
                <stop offset="1" stop-color="rgba(17,24,39,.12)"/>
              </linearGradient>
              <linearGradient id="ppsCartEmptyAccent" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0" stop-color="#ff7a1a"/>
                <stop offset="1" stop-color="#d94a1f"/>
              </linearGradient>
            </defs>

            <path d="M40 142c26 10 154 10 180 0" fill="none" stroke="rgba(17,24,39,.08)" stroke-width="12" stroke-linecap="round"/>
            <g class="thank-road" opacity=".9">
              <path d="M16 146H244" stroke="rgba(17,24,39,.10)" stroke-width="10" stroke-linecap="round"/>
              <g class="thank-road-track">
                <path d="M18 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                <path d="M74 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                <path d="M130 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                <path d="M186 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                <g transform="translate(260 0)">
                  <path d="M18 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                  <path d="M74 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                  <path d="M130 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                  <path d="M186 146h44" stroke="rgba(255,255,255,.70)" stroke-width="4" stroke-linecap="round"/>
                </g>
              </g>
            </g>

            <g class="thank-cart-float">
              <path d="M46 40h26" stroke="rgba(17,24,39,.26)" stroke-width="10" stroke-linecap="round"/>
              <path d="M62 40l10 60" stroke="rgba(17,24,39,.18)" stroke-width="8" stroke-linecap="round"/>

              <path d="M78 58h118l-10 48H92L78 58Z" fill="rgba(255,255,255,.78)" stroke="url(#ppsCartEmptyStroke)" stroke-width="3" />
              <path d="M86 64h100" stroke="rgba(17,24,39,.10)" stroke-width="3" stroke-linecap="round"/>
              <path d="M94 76h82" stroke="rgba(17,24,39,.08)" stroke-width="3" stroke-linecap="round"/>
              <path d="M102 90h64" stroke="rgba(17,24,39,.08)" stroke-width="3" stroke-linecap="round"/>

              <path d="M86 106h94" stroke="url(#ppsCartEmptyAccent)" stroke-width="8" stroke-linecap="round" opacity=".92"/>

              <g class="thank-wheel" transform="translate(106 132)">
                <g class="thank-wheel-spin">
                  <circle r="14" fill="#111827" opacity=".88"/>
                  <circle r="7" fill="rgba(255,255,255,.92)"/>
                  <path d="M0-10V10M-10 0H10M-7-7l14 14M-7 7l14-14" stroke="rgba(17,24,39,.35)" stroke-width="2" stroke-linecap="round"/>
                </g>
              </g>
              <g class="thank-wheel" transform="translate(176 132)">
                <g class="thank-wheel-spin">
                  <circle r="14" fill="#111827" opacity=".88"/>
                  <circle r="7" fill="rgba(255,255,255,.92)"/>
                  <path d="M0-10V10M-10 0H10M-7-7l14 14M-7 7l14-14" stroke="rgba(17,24,39,.35)" stroke-width="2" stroke-linecap="round"/>
                </g>
              </g>
            </g>
          </svg>
        </div>
        <div class="cart-empty-body">
          <div class="cart-empty-title">${a}</div>
          <div class="cart-empty-desc">${o}</div>
          <div class="cart-empty-actions">
            <a class="btn btn-primary" href="./products.html">${c}</a>
            <a class="btn btn-outline" href="./resources.html">${window.PPS_I18N?.t("nav.resources")||"Resources"}</a>
          </div>
        </div>
      </div>
    `,s.textContent=PPS.money(0),r&&(r.textContent="--"),d&&(d.style.display="none"),i&&(i.style.display="none"),g&&(g.innerHTML="");return}setCheckoutCtaState(!1);const u=PPS.getCurrency();let w=0;const C=t.reduce((n,a)=>{const o=productMap?.get(a.id),c=o?Number(o.priceCents||0):a.priceCentsBase??a.priceCents,l=o?PPS.getTieredPriceCents(o,a.qty):c;o&&c>l&&(w+=(c-l)*a.qty);const h=l*a.qty,m=o?.currency||a.currencyBase||a.currency||"CAD";return n+PPS.convertCents(h,m,u)},0);if(s.textContent=PPS.money(C,u,u),d&&p&&(w>0?(d.style.display="",p.textContent=`- ${PPS.money(w,"CAD",u)}`):d.style.display="none"),r){const n=addBusinessDays(new Date,2),a=addBusinessDays(new Date,5);r.textContent=`${formatShortDate(n)} - ${formatShortDate(a)}`}if(e.innerHTML=t.map(n=>{const o=(window.PPS_I18N?.getLang?.()||"en")==="es"&&window.PPS_I18N?.autoTranslate?.(n.name||"","es")||n.name,c=getItemDescription(n),l=productMap?.get(n.id),h=l?.image||n.image||"./assets/poly%20logo%20without%20background.png",m=l?PPS.getTieredPriceCents(l,n.qty):n.priceCentsBase??n.priceCents,k=l?.currency||n.currencyBase||n.currency||"CAD",P=m*n.qty,_=PPS.money(PPS.convertCents(P,k,u),u,u),M=l&&Number(l.stock)>0&&Number(l.stock)<=5?`<div class="cart-stock-warning">Only ${l.stock} left - order soon.</div>`:"",$=c?`<div style="color:var(--muted); font-size:13px; margin-top:4px;">${c}</div>`:"",x=window.PPS_I18N?.t("cart.save")||"Save for later",I=window.PPS_I18N?.t("cart.remove")||"Remove";return`
    <div class="card cart-item fade-in" data-cart-item-id="${String(n.id||"")}">
      <div class="cart-item-main">
        <div class="cart-item-thumb" aria-hidden="true">
          <img src="${h}" alt="" loading="lazy" decoding="async">
        </div>
        <div class="cart-item-info">
          <div class="cart-item-title">${o||""}</div>
          <div class="cart-item-prices">
            <span class="cart-item-unit">${PPS.money(m,k)}</span>
            <span class="cart-item-sep">\xB7</span>
            <span class="cart-item-line">${_}</span>
          </div>
          ${$}
          ${M}
        </div>
      </div>

      <div class="cart-item-actions">
        <div class="cart-qty" role="group" aria-label="Quantity">
          <button class="btn btn-sm cart-qty-btn" type="button" onclick="dec('${n.id}')" aria-label="Decrease quantity">\u2212</button>
          <div class="cart-qty-value" aria-label="Quantity">${n.qty}</div>
          <button class="btn btn-sm cart-qty-btn" type="button" onclick="inc('${n.id}')" aria-label="Increase quantity">+</button>
        </div>
        <div class="cart-item-links">
          <button class="btn btn-outline btn-sm" type="button" onclick="saveForLater('${n.id}')">${x}</button>
          <button class="btn btn-outline btn-sm" type="button" onclick="removeItem('${n.id}')">${I}</button>
        </div>
      </div>
    </div>
  `}).join(""),document.querySelectorAll(".fade-in").forEach(n=>n.classList.add("show")),g&&productsList.length){const n=new Set(t.map(o=>productMap?.get(o.id)?.category).filter(Boolean)),a=productsList.filter(o=>!t.some(c=>c.id===o.id)).filter(o=>n.size?n.has(o.category):!0).slice(0,4);y&&(y.style.display=a.length?"":"none"),g.innerHTML=a.length?a.map(o=>`
        <div class="card">
          <a href="./product.html?slug=${encodeURIComponent(o.slug)}">
            <img src="${o.image}" alt="${o.name}" loading="lazy" decoding="async" width="320" height="170">
          </a>
          <div class="card-body">
            <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(o.slug)}">${o.name}</a>
            <div class="member-pricing">
              <div>
                <div class="market-label">Market price</div>
                <span class="compare-price">${PPS.money((Number(o.priceCents)||0)+1e3,o.currency)}</span>
              </div>
              <div>
                <div class="member-label">Power Poly Member Price</div>
                <span class="price">${PPS.money(Number(o.priceCents)||0,o.currency)}</span>
              </div>
            </div>
            <div style="margin-top:10px;">
              <button class="btn btn-primary btn-sm" type="button" onclick="addCrossSell('${o.id}')">Add</button>
            </div>
          </div>
        </div>
      `).join(""):'<div style="color:var(--muted); font-size:13px;">No cross-sell picks yet.</div>'}else y&&(y.style.display="none");if(i){const n=readLastOrder();PPS.getSession?.()&&n?.items?.length?(i.style.display="",i.onclick=()=>{PPS.setCart(n.items),render()}):i.style.display="none"}}function cssEscape(t){try{if(window.CSS&&typeof window.CSS.escape=="function")return window.CSS.escape(String(t))}catch{}return String(t).replace(/["\\]/g,"\\$&")}function pulseCartItem(t){const e=cssEscape(t),s=document.querySelector(`[data-cart-item-id="${e}"]`);s&&(s.classList.remove("cart-item-updated"),s.offsetWidth,s.classList.add("cart-item-updated"),setTimeout(()=>s.classList.remove("cart-item-updated"),520))}function removeCartItemWithAnim(t,e){const s=cssEscape(t),r=document.querySelector(`[data-cart-item-id="${s}"]`);if(!r){e();return}r.classList.add("cart-item-removing"),setTimeout(e,200)}window.inc=t=>{const e=PPS.getCart(),s=e.find(r=>r.id===t);s&&(s.qty+=1,PPS.setCart(e),render(),pulseCartItem(t))},window.dec=t=>{const e=PPS.getCart(),s=e.find(d=>d.id===t);if(!s)return;const r=(Number(s.qty)||1)-1;if(r<=0){removeCartItemWithAnim(t,()=>{const d=e.filter(p=>p.id!==t);PPS.setCart(d),render()});return}s.qty=r,PPS.setCart(e),render(),pulseCartItem(t)},window.removeItem=t=>{removeCartItemWithAnim(t,()=>{const e=PPS.getCart().filter(s=>s.id!==t);PPS.setCart(e),render()})},window.saveForLater=t=>{if(!PPS.getSession?.()){window.location.href="./login.html";return}PPS.addToWishlist?.(t);const s=PPS.getCart().filter(r=>r.id!==t);PPS.setCart(s),render()},window.addCrossSell=t=>{const e=productMap?.get(t);e&&(PPS.addToCart(e,1),render())},render(),productsPromise.then(()=>render()),goCheckout&&goCheckout.addEventListener("click",t=>{try{const e=PPS.getCart();if(!Array.isArray(e)||e.length===0){t.preventDefault();const i=window.PPS_I18N?.t("cart.empty.checkout_notice")||"Your cart is empty. Add products before checking out.";try{window.alert(i)}catch{}window.location.href="./products.html";return}const s=e.filter(i=>i&&i.id&&Number(i.qty)>0).map(i=>[String(i.id),Math.max(1,Number(i.qty)||1)]),d=btoa(unescape(encodeURIComponent(JSON.stringify(s)))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,""),p=new URL(goCheckout.href,window.location.href);p.searchParams.set("cart",d),t.preventDefault(),window.location.href=p.toString()}catch{}});
