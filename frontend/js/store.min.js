const DEFAULT_API_BASE="http://127.0.0.1:5000",DEFAULT_CAD_TO_USD=.74,FAVORITES_KEY="pps_favorites",CART_KEY="pps_cart",CART_COOKIE="pps_cart",CAPED_WE_LOVE_IMAGE="./assets/welovecaped%20hanger.webp",CLEAR_POLYBAG_IMAGE="./assets/polybag%20clear.webp",GARMENT_BAGS_IMAGE="./assets/polybag%20clear.webp",SHIRT_HANGER_ID="hanger-shirt-18-plain",SHIRT_HANGER_MEMBER_CENTS=3259,SHIRT_HANGER_COMPARE_CENTS=4959,PRODUCTS_CACHE_KEY="pps_products_cache_v2",PRODUCTS_FAST_MS=400,WISHLISTS_SUFFIX="wishlists_v1";function normalizeImagePath(t){return t&&String(t).replace(/ /g,"%20")}function isShirtHangerPlain(t){const e=String(t?.id||"").trim().toLowerCase(),r=String(t?.slug||"").trim().toLowerCase(),n=String(t?.name||"").trim().toLowerCase();return e===SHIRT_HANGER_ID||r==="shirt-hangers-18-plain"?!0:/shirt\s*hangers?\s*plain\s*\(18/.test(n)}function normalizeProductImage(t){if(!t)return t;const e=normalizeImagePath(t.image),r=Array.isArray(t.images)?t.images.map(normalizeImagePath).filter(Boolean):[];if(isShirtHangerPlain(t))return{...t,image:e,images:r,priceCents:3259,comparePriceCents:4959};if(t.id==="hanger-caped-16-we-love"&&(!e||/welovefinal|caped%20we%20love\.png/i.test(e)))return{...t,image:CAPED_WE_LOVE_IMAGE,images:r};const n=String(t.category||"").trim(),i=String(t.name||"").trim(),s=String(t.slug||"").trim();return n==="Polybags"&&/clear poly bags/i.test(i||s)?{...t,image:CLEAR_POLYBAG_IMAGE,images:r}:n==="Garment Bags"&&(!e||/clear%20poly%20bags\.webp|clear poly bags\.webp/i.test(e))?{...t,image:GARMENT_BAGS_IMAGE,images:r}:{...t,image:e,images:r}}function readCachedProducts(){if(Array.isArray(window._products)&&window._products.length)return window._products;try{const t=sessionStorage.getItem(PRODUCTS_CACHE_KEY);if(!t)return null;const e=JSON.parse(t);if(Array.isArray(e)&&e.length)return window._products=e,e}catch{}return null}function cacheProducts(t){if(!(!Array.isArray(t)||!t.length)){window._products=t;try{sessionStorage.setItem(PRODUCTS_CACHE_KEY,JSON.stringify(t))}catch{}}}function wrapProducts(t){return Array.isArray(t)?t.map(normalizeProductImage):null}function fastTimeout(t){return new Promise(e=>setTimeout(()=>e({source:"timeout",data:null}),t))}async function fetchBackendProducts(){try{const t=await fetch(`${API_BASE}/api/products`,{cache:"no-store"});if(!t.ok)return null;const e=await t.json();if(e?.ok&&Array.isArray(e.products))return wrapProducts(e.products)}catch{}return null}async function fetchLocalProducts(){try{const t=await fetch("./data/products.json",{cache:"force-cache"});if(!t.ok)return null;const e=await t.json();return wrapProducts(e||[])}catch{}return null}function inferApiBase(){function t(s){const a=String(s||"").trim();if(!a)return"";let o=a.replace(/\/+$/,"");return o=o.replace(/\/api$/i,""),o}if(window.API_BASE_URL)return t(window.API_BASE_URL);if(window.PPS_API_BASE)return t(window.PPS_API_BASE);const e=new URLSearchParams(window.location.search).get("api");if(e)return t(e);const r=localStorage.getItem("pps_api_base");if(r)return t(r);const n=window.location.hostname||"127.0.0.1",i=window.location.protocol&&window.location.protocol.startsWith("http")?window.location.protocol:"http:";return n==="localhost"||n==="127.0.0.1"?`${i}//127.0.0.1:5000`:window.location.origin&&window.location.origin!=="null"?t(window.location.origin):DEFAULT_API_BASE}const API_BASE=inferApiBase();function getCadUsdRate(){const t=Number(localStorage.getItem("pps_cad_usd_rate"));if(Number.isFinite(t)&&t>0)return t;const e=Number(window.PPS_CAD_USD_RATE);return Number.isFinite(e)&&e>0?e:.74}function getCurrency(){try{const r=new URLSearchParams(window.location.search).get("currency");if(r)return r==="USD"?"USD":"CAD"}catch{}try{const r=localStorage.getItem("pps_currency");if(r)return r==="USD"?"USD":"CAD"}catch{}const t=document.cookie.match(/(?:^|; )pps_currency=([^;]*)/);return(t?decodeURIComponent(t[1]):"")==="USD"?"USD":"CAD"}function setCurrency(t){const e=t==="USD"?"USD":"CAD",r=getCurrency();try{localStorage.setItem("pps_currency",e)}catch{}const n=3600*24*365;document.cookie=`pps_currency=${encodeURIComponent(e)}; max-age=${n}; path=/; samesite=lax`;try{const i=new URL(window.location.href);i.searchParams.set("currency",e),window.history.replaceState({},"",i.toString())}catch{}r!==e&&(window.dispatchEvent(new CustomEvent("pps:currency",{detail:{currency:e}})),window.location.reload())}function convertCents(t,e="CAD",r){const n=String(e||"CAD").toUpperCase(),i=String(r||getCurrency()).toUpperCase(),s=Math.round(Number(t)||0);if(n===i)return s;const a=getCadUsdRate();return n==="CAD"&&i==="USD"?Math.round(s*a):n==="USD"&&i==="CAD"?Math.round(s/a):s}function getTieredPriceCents(t,e){if(!t)return 0;const r=Math.round(Number(t.priceCents)||0);if(isShirtHangerPlain(t)){const n=Math.max(0,Number(e)||0);return n>=20?2959:n>=15?3059:n>=10?3159:3259}if((t.category||"")==="Garment Bags"){const n=Math.max(0,Number(e)||0);if(n>=20)return 3699;if(n>=15)return 3799;if(n>=10)return 3899}return r}function getComparePriceCents(t){if(!t)return 0;if(isShirtHangerPlain(t))return 4959;const e=Math.round(Number(t.comparePriceCents));return Number.isFinite(e)&&e>0?e:Math.round(Number(t.priceCents)||0)+1e3}function money(t,e="CAD",r){const n=String(r||getCurrency()).toUpperCase(),i=String(e||"CAD").toUpperCase(),s=convertCents(Number(t)||0,i,n),a=n==="USD"?"en-US":"en-CA";return new Intl.NumberFormat(a,{style:"currency",currency:n}).format(s/100)}async function pingBackend(){try{const t=new AbortController,e=setTimeout(()=>t.abort(),8e3),r=await fetch(`${API_BASE}/api/health`,{cache:"no-store",signal:t.signal});return clearTimeout(e),r.ok}catch{return!1}}async function loadProducts(){const t=readCachedProducts();if(t){try{const o=window.PPS?.getSession?.();if(o?.email&&window.PPS_NOTIFS?.refreshFromAccount){const c=window.PPS?.getFavorites?.()||[];window.PPS_NOTIFS.refreshFromAccount({session:o,orders:[],products:t,favorites:c,frequent:[]})}}catch{}return t}const e=fetchBackendProducts(),r=fetchLocalProducts(),n=await Promise.race([e.then(o=>({source:"backend",data:o})),r.then(o=>({source:"local",data:o})),fastTimeout(400)]);if(n.source!=="timeout"&&Array.isArray(n.data)){cacheProducts(n.data);try{const o=window.PPS?.getSession?.();if(o?.email&&window.PPS_NOTIFS?.refreshFromAccount){const c=window.PPS?.getFavorites?.()||[];window.PPS_NOTIFS.refreshFromAccount({session:o,orders:[],products:n.data,favorites:c,frequent:[]})}}catch{}return n.data}const[i,s]=await Promise.all([e,r]),a=Array.isArray(i)?i:Array.isArray(s)?s:[];cacheProducts(a);try{const o=window.PPS?.getSession?.();if(o?.email&&window.PPS_NOTIFS?.refreshFromAccount){const c=window.PPS?.getFavorites?.()||[];window.PPS_NOTIFS.refreshFromAccount({session:o,orders:[],products:a,favorites:c,frequent:[]})}}catch{}return a}async function fetchReviews(t){const e=`${API_BASE}/api/products/${encodeURIComponent(t)}/reviews`,r=await fetch(e);if(!r.ok)throw new Error("Failed to load reviews");return r.json()}async function submitReview(t,e){const r=`${API_BASE}/api/products/${encodeURIComponent(t)}/reviews`,n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),i=await n.json().catch(()=>({}));if(!n.ok||!i.ok)throw new Error(i?.message||"Failed to submit review");return i}function readCookie(t){const e=document.cookie.match(new RegExp(`(?:^|; )${t}=([^;]*)`));return e?decodeURIComponent(e[1]):""}function writeCookie(t,e,r=30){const n=86400*r;document.cookie=`${t}=${encodeURIComponent(e)}; max-age=${n}; path=/; samesite=lax`}function serializeCartForCookie(t){if(!Array.isArray(t)||!t.length)return"[]";const e=t.filter(r=>r&&r.id&&Number(r.qty)>0).map(r=>[String(r.id),Math.max(1,Number(r.qty)||1)]);return JSON.stringify(e)}function readCartFromCookie(){try{const t=readCookie(CART_COOKIE);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e.filter(r=>Array.isArray(r)&&r[0]).map(([r,n])=>({id:String(r),qty:Math.max(1,Number(n)||1)})):[]}catch{return[]}}function normalizeCartItems(t){return(t||[]).map(e=>({...e,qty:Math.max(1,Number(e.qty)||1),priceCentsBase:Number(e.priceCentsBase??e.priceCents??0),currencyBase:(e.currencyBase||e.currency||"CAD").toUpperCase()}))}function readCartFromQuery(){try{const e=new URLSearchParams(window.location.search).get("cart");if(!e)return[];const r=e.replace(/-/g,"+").replace(/_/g,"/"),n=r.length%4?"=".repeat(4-r.length%4):"",i=decodeURIComponent(escape(atob(r+n))),s=JSON.parse(i);return!Array.isArray(s)||!s.length?[]:s.filter(a=>Array.isArray(a)&&a[0]).map(([a,o])=>({id:String(a),qty:Math.max(1,Number(o)||1)}))}catch{return[]}}function getCart(){try{const s=JSON.parse(localStorage.getItem(CART_KEY)||"[]");if(Array.isArray(s)&&s.length){const a=normalizeCartItems(s);return writeCookie(CART_COOKIE,serializeCartForCookie(a)),a}}catch{}const t=readCartFromQuery();if(t.length){try{localStorage.setItem(CART_KEY,JSON.stringify(t))}catch{}return writeCookie(CART_COOKIE,JSON.stringify(t)),normalizeCartItems(t)}const e=readCartFromCookie();if(!e.length)return[];const r=readCachedProducts()||[],n=new Map(r.map(s=>[s.id,s])),i=e.map(({id:s,qty:a})=>{const o=n.get(s),c=(o?.currency||"CAD").toUpperCase();return normalizeCartItems([{id:s,qty:a,name:o?.name||"Item",priceCents:Number(o?.priceCents||0),currency:c,priceCentsBase:Number(o?.priceCents||0),currencyBase:c,description:o?.description||"",description_fr:o?.description_fr||"",description_ko:o?.description_ko||"",description_hi:o?.description_hi||"",description_ta:o?.description_ta||"",description_es:o?.description_es||""}])[0]});try{localStorage.setItem(CART_KEY,JSON.stringify(i))}catch{}return i}function setCart(t){const e=normalizeCartItems(t);try{localStorage.setItem(CART_KEY,JSON.stringify(e))}catch{}writeCookie(CART_COOKIE,serializeCartForCookie(e)),updateCartBadge();try{const r=e.reduce((n,i)=>n+(Number(i?.qty)||0),0);window.dispatchEvent(new CustomEvent("pps:cart",{detail:{cart:e,count:r}})),window.PPS_ANALYTICS?.record?.("cart_update",{count:r})}catch{}}function getFavorites(){try{const t=JSON.parse(localStorage.getItem(FAVORITES_KEY)||"[]");return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function setFavorites(t){const e=Array.from(new Set((t||[]).filter(Boolean)));localStorage.setItem(FAVORITES_KEY,JSON.stringify(e)),window.dispatchEvent(new CustomEvent("pps:favorites",{detail:{favorites:e}}))}function isFavorite(t){return getFavorites().includes(t)}function toggleFavorite(t){if(!t)return getFavorites();const e=getFavorites(),r=e.indexOf(t);return r>=0?e.splice(r,1):e.push(t),setFavorites(e),e}function updateCartBadge(){const t=document.querySelectorAll("[data-cart-badge]");if(!t.length)return;const r=getCart().reduce((n,i)=>n+i.qty,0);t.forEach(n=>{n.textContent=r})}function addToCart(t,e=1){const r=Math.max(1,Number(e)||1),n=getCart(),i=n.find(s=>s.id===t.id);i?(i.qty+=r,i.description=t.description||i.description||"",i.description_fr=t.description_fr||i.description_fr||"",i.description_ko=t.description_ko||i.description_ko||"",i.description_hi=t.description_hi||i.description_hi||"",i.description_ta=t.description_ta||i.description_ta||"",i.description_es=t.description_es||i.description_es||"",i.priceCentsBase=i.priceCentsBase??t.priceCents,i.currencyBase=i.currencyBase||t.currency||"CAD"):n.push({id:t.id,name:t.name,priceCents:t.priceCents,currency:t.currency,qty:r,description:t.description||"",description_fr:t.description_fr||"",description_ko:t.description_ko||"",description_hi:t.description_hi||"",description_ta:t.description_ta||"",description_es:t.description_es||"",priceCentsBase:t.priceCents,currencyBase:t.currency||"CAD"}),setCart(n);try{window.PPS_ANALYTICS?.record?.("add_to_cart",{id:t.id,qty:r,name:t.name})}catch{}}function setApiBaseOverride(t){t&&(localStorage.setItem("pps_api_base",t),window.location.reload())}function getSession(){try{const t=localStorage.getItem("pps_session");if(!t)return null;const e=JSON.parse(t);return!e?.token||!e?.email?null:e.expiresAt&&Date.now()>e.expiresAt?(localStorage.removeItem("pps_session"),null):e}catch{return null}}function setSession(t){!t||!t.token||!t.email||localStorage.setItem("pps_session",JSON.stringify(t))}function clearSession(){localStorage.removeItem("pps_session")}function getAccountEmail(){const t=getSession();return String(t?.email||"").trim().toLowerCase()||""}function accountKey(t,e){const r=String(t||"").trim().toLowerCase();return r?`pps_account_${r}_${e}`:""}function readJson(t,e){try{const r=localStorage.getItem(t);return r?JSON.parse(r):e}catch{return e}}function writeJson(t,e){try{return localStorage.setItem(t,JSON.stringify(e)),!0}catch{return!1}}function normalizeWishlists(t){const r=(Array.isArray(t?.lists)?t.lists:[]).map(n=>({id:String(n?.id||""),name:String(n?.name||"Wishlist").trim()||"Wishlist",createdAt:String(n?.createdAt||""),items:Array.isArray(n?.items)?n.items.map(i=>({productId:String(i?.productId||i?.id||""),addedAt:String(i?.addedAt||"")})).filter(i=>i.productId):[]})).filter(n=>n.id);return r.length?{lists:r}:{lists:[{id:`wl_${Date.now()}`,name:"Wishlist",createdAt:new Date().toISOString(),items:[]}]}}function getWishlists(){const t=getAccountEmail();if(!t)return null;const e=accountKey(t,WISHLISTS_SUFFIX),r=normalizeWishlists(readJson(e,null));return writeJson(e,r),r}function setWishlists(t){const e=getAccountEmail();if(!e)return null;const r=accountKey(e,WISHLISTS_SUFFIX),n=normalizeWishlists(t);return writeJson(r,n),window.dispatchEvent(new CustomEvent("pps:wishlists",{detail:{email:e,wishlists:n}})),n}function createWishlist(t){const e=getWishlists();if(!e)return null;const r=String(t||"").trim()||"Wishlist",n=`wl_${Date.now()}_${Math.random().toString(16).slice(2)}`;return setWishlists({lists:[{id:n,name:r,createdAt:new Date().toISOString(),items:[]},...e.lists]})}function renameWishlist(t,e){const r=getWishlists();if(!r)return null;const n=String(e||"").trim();return n?setWishlists({lists:r.lists.map(i=>i.id===String(t)?{...i,name:n}:i)}):r}function deleteWishlist(t){const e=getWishlists();if(!e)return null;const r=String(t||""),n=e.lists.filter(i=>i.id!==r);return setWishlists({lists:n})}function addToWishlist(t,e){const r=getWishlists();if(!r)return null;const n=String(t||"").trim();if(!n)return r;const i=String(e||r.lists[0]?.id||"");return setWishlists({lists:r.lists.map(s=>s.id!==i||s.items.some(o=>o.productId===n)?s:{...s,items:[{productId:n,addedAt:new Date().toISOString()},...s.items]})})}function removeFromWishlist(t,e){const r=getWishlists();if(!r)return null;const n=String(t||"").trim();if(!n)return r;const i=String(e||"");return setWishlists({lists:r.lists.map(s=>i&&s.id!==i?s:{...s,items:s.items.filter(a=>a.productId!==n)})})}function isInAnyWishlist(t){const e=getWishlists();if(!e)return!1;const r=String(t||"").trim();return r?e.lists.some(n=>n.items.some(i=>i.productId===r)):!1}function addItemsToCart(t){Array.isArray(t)&&t.forEach(e=>{if(!e)return;const r=Number(e.qty)||1,n=Number(e.priceCentsBase??e.priceCents??0),i=e.currencyBase||e.currency||"CAD";addToCart({id:e.id,name:e.name,priceCents:n,currency:i,description:e.description||"",description_fr:e.description_fr||"",description_ko:e.description_ko||"",description_hi:e.description_hi||"",description_ta:e.description_ta||"",description_es:e.description_es||""},r)})}window.PPS={API_BASE,money,convertCents,getTieredPriceCents,getComparePriceCents,getCurrency,setCurrency,pingBackend,loadProducts,fetchReviews,submitReview,getCart,setCart,updateCartBadge,addToCart,addItemsToCart,getFavorites,isFavorite,toggleFavorite,getSession,setSession,clearSession,setApiBaseOverride,getWishlists,createWishlist,renameWishlist,deleteWishlist,addToWishlist,removeFromWishlist,isInAnyWishlist};
