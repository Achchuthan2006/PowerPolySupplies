(()=>{"use strict";const et="notifications_v1",rt="notif_prefs_v1",ct="notif_snapshot_v1",dt="notif_web_last_v1",q={orderUpdates:!0,backInStock:!0,memberDeals:!0,lowStock:!0,priceDrops:!0,browserNotifications:!1,lowStockThreshold:20,priceDropPercent:5,watchedProductIds:[]},lt={order_update:{label:"Order update"},back_in_stock:{label:"Back in stock"},member_deal:{label:"Member deal"},low_stock:{label:"Low stock"},price_drop:{label:"Price drop"}},ot=new Map,I=()=>new Date().toISOString(),P=e=>String(e||"").trim().toLowerCase(),E=(e,t)=>`pps_account_${P(e)}_${t}`,W=(e,t)=>{try{const n=localStorage.getItem(e);return n?JSON.parse(n):t}catch{return t}},K=(e,t)=>{try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch{return!1}},ut=(e,t="")=>{try{const n=localStorage.getItem(e);return n==null?t:String(n)}catch{return t}},ft=(e,t)=>{try{return localStorage.setItem(e,String(t??"")),!0}catch{return!1}},H=e=>{const t={...q,...e||{}};return t.lowStockThreshold=Math.max(0,Math.round(Number(t.lowStockThreshold)||q.lowStockThreshold)),t.priceDropPercent=Math.max(0,Math.min(90,Math.round(Number(t.priceDropPercent)||q.priceDropPercent))),t.watchedProductIds=Array.from(new Set((t.watchedProductIds||[]).map(n=>String(n||"").trim()).filter(Boolean))),t.orderUpdates=!!t.orderUpdates,t.backInStock=!!t.backInStock,t.memberDeals=!!t.memberDeals,t.lowStock=!!t.lowStock,t.priceDrops=!!t.priceDrops,t.browserNotifications=!!t.browserNotifications,t},L=e=>H(W(E(e,rt),q)),nt=(e,t)=>{const n=H(t);return K(E(e,rt),n),X(e),n},_=e=>{const t=W(E(e,et),[]);return Array.isArray(t)?t:[]},$=(e,t)=>{const n=(Array.isArray(t)?t:[]).filter(Boolean).slice(0,250);return K(E(e,et),n),X(e),n},O=e=>_(e).reduce((n,i)=>n+(i?.readAt?0:1),0),X=e=>{const t=O(e);window.dispatchEvent(new CustomEvent("pps:notifs",{detail:{email:P(e),unread:t}}))},pt=e=>{try{const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}catch{return""}},T=e=>`${e}_${Date.now()}_${Math.random().toString(16).slice(2)}`,D=(e,t,n)=>e.some(i=>i?.type===t&&String(i?.meta?.dedupeKey||"")===String(n||"")),j=()=>typeof window<"u"&&"Notification"in window,G=e=>{if(!j())return"Browser notifications are not supported on this device/browser.";const t=Notification.permission;return e?t==="granted"?"Browser notifications are enabled.":t==="denied"?"Browser notifications are blocked in your browser settings.":"Browser notifications are enabled, but permission is not granted yet. Click Save preferences to allow.":"Enable to receive a single pop-up notification for new updates (when this site is open)."},J=e=>{const t=document.getElementById("notifBrowserStatus");t&&(t.textContent=String(e||""))},st=async()=>{if(!("serviceWorker"in navigator))return null;try{const e=await navigator.serviceWorker.getRegistration("./");if(e)return e}catch{}try{return await navigator.serviceWorker.register("./sw.js",{scope:"./"})}catch{return null}},mt=async()=>{if(!j())return!1;if(Notification.permission==="granted")return!0;if(Notification.permission==="denied")return!1;try{return await Notification.requestPermission()==="granted"}catch{return!1}},gt=async(e,t)=>{const n=P(e);if(!n||!L(n).browserNotifications||!j()||Notification.permission!=="granted")return;try{const g=typeof document.hasFocus=="function"?document.hasFocus():!0;if(document.visibilityState==="visible"&&g)return}catch{}const l=String(t?.id||"");if(!l)return;const o=E(n,dt);if(ut(o,"")===l)return;const a=String(t?.title||"Power Poly Supplies"),u=String(t?.message||""),b="./account.html#notifications",f="./assets/poly%20logo%20without%20background.png",m={body:u,icon:f,badge:f,tag:l,renotify:!1,data:{url:b}};try{const g=await st();g?.showNotification?await g.showNotification(a,m):new Notification(a,m),ft(o,l)}catch{}},ht=({session:e,orders:t,products:n,favorites:i,frequent:l})=>{const o=P(e?.email);if(!o)return{created:0,unread:0};const a=L(o),u=_(o),b=E(o,ct),f=W(b,{orders:{},products:{}}),m=f?.orders&&typeof f.orders=="object"?f.orders:{},g=f?.products&&typeof f.products=="object"?f.products:{},r=Array.isArray(n)?n:[],s=new Map(r.map(d=>[String(d?.id||""),d]).filter(d=>d[0])),c=Array.isArray(i)?i.map(d=>String(d||"")):[],h=Array.isArray(l)?l.filter(d=>(Number(d?.count)||0)>=2).map(d=>String(d?.id||"")).filter(Boolean):[],B=a.watchedProductIds.length?a.watchedProductIds:c,F=new Set(B.filter(Boolean)),Y=new Set(h),k=[];if(a.orderUpdates&&Array.isArray(t)&&t.forEach(d=>{const p=String(d?.id||"");if(!p)return;const w=String(d?.status||"pending"),y=String(m[p]||"");if(m[p]=w,!y||y===w)return;const M=`order:${p}:${y}->${w}`;D(u,"order_update",M)||k.push({id:T("n"),type:"order_update",title:`Order ${p} updated`,message:`Status changed from ${y} to ${w}.`,createdAt:I(),readAt:"",meta:{orderId:p,prevStatus:y,nextStatus:w,dedupeKey:M}})}),r.forEach(d=>{const p=String(d?.id||"");if(!p)return;const w=Math.max(0,Math.round(Number(d?.stock)||0)),y=Math.max(0,Math.round(Number(d?.priceCents)||0)),M=!!d?.special,Q=g[p]&&typeof g[p]=="object"?g[p]:{},U=Math.max(0,Math.round(Number(Q.stock)||0)),N=Math.max(0,Math.round(Number(Q.priceCents)||0)),it=!!Q.special;g[p]={stock:w,priceCents:y,special:M};const C=String(d?.name||"Item"),bt=String(d?.slug||""),R={productId:p,slug:bt,name:C},Z=F.has(p),at=Y.has(p);if(a.backInStock&&Z&&U===0&&w>0){const S=`back:${p}:${U}->${w}`;D(u,"back_in_stock",S)||k.push({id:T("n"),type:"back_in_stock",title:"Back in stock",message:`${C} is available again (${w} in stock).`,createdAt:I(),readAt:"",meta:{...R,dedupeKey:S}})}if(a.lowStock&&at){const S=Math.max(0,Math.round(Number(a.lowStockThreshold)||0)),tt=U>S&&w<=S;if(S>0&&tt){const x=`low:${p}:${U}->${w}:t${S}`;D(u,"low_stock",x)||k.push({id:T("n"),type:"low_stock",title:"Low stock warning",message:`${C} is low on stock (${w} left).`,createdAt:I(),readAt:"",meta:{...R,stock:w,threshold:S,dedupeKey:x}})}}if(a.priceDrops&&Z&&N>0&&y>0&&y<N){const S=Math.round((N-y)/N*100),tt=Math.max(0,Math.round(Number(a.priceDropPercent)||0));if(S>=tt){const x=`price:${p}:${N}->${y}`;D(u,"price_drop",x)||k.push({id:T("n"),type:"price_drop",title:"Price drop",message:`${C} dropped by ${S}% (from ${(N/100).toFixed(2)} to ${(y/100).toFixed(2)}).`,createdAt:I(),readAt:"",meta:{...R,prevPriceCents:N,priceCents:y,pct:S,dedupeKey:x}})}}if(a.memberDeals&&(Z||at)&&M&&!it){const S=`deal:${p}:${it?1:0}->${M?1:0}`;D(u,"member_deal",S)||k.push({id:T("n"),type:"member_deal",title:"Member-only deal",message:`${C} is now in Special Offers.`,createdAt:I(),readAt:"",meta:{...R,dedupeKey:S}})}}),K(b,{orders:m,products:g}),k.length){const d=[...k,...u].slice(0,250);$(o,d),gt(o,k[0])}else X(o);return ot.set(o,{email:o,productsById:s,favorites:c,frequentIds:h}),{created:k.length,unread:O(o)}},v=()=>P(window.PPS?.getSession?.()?.email),z=e=>{const t=O(e);Array.from(document.querySelectorAll("[data-notif-badge], #notifCountBadge")).forEach(i=>{i.textContent=String(t),i.style.display=t?"":"none"})},A=()=>{const e=v();if(!e)return;const t=document,n=t.getElementById("notificationsList"),i=t.getElementById("notificationsMsg"),l=t.getElementById("notifTypeFilter"),o=Array.from(t.querySelectorAll("[data-notif-tab]"));if(!n)return;const a=String(t.body?.dataset?.notifTab||"all"),u=String(l?.value||"");let f=_(e).slice();a==="unread"&&(f=f.filter(r=>!r?.readAt)),u&&(f=f.filter(r=>String(r?.type||"")===u)),o.forEach(r=>r.classList.toggle("active",String(r.getAttribute("data-notif-tab"))===a)),i&&(i.textContent=f.length?"":a==="unread"?"No unread updates right now.":"No notifications yet.");const m=ot.get(e),g=r=>{const s=String(r?.meta?.slug||"");return s?`./product.html?slug=${encodeURIComponent(s)}`:""};n.innerHTML=f.map(r=>{const s=String(r?.type||""),c=lt[s]?.label||s,h=!r?.readAt,B=pt(r?.createdAt),F=String(r?.title||""),Y=String(r?.message||""),k=s==="order_update"?"./account.html#orders":g(r),d=s==="order_update"?"View orders":k?"View item":"",p=`notif-pill ${s}`;return`
          <div class="notif-item ${h?"unread":""}" data-notif-id="${String(r?.id||"")}">
            <div class="notif-top">
              <span class="${p}">${c}</span>
              <span class="notif-time">${B}</span>
            </div>
            <div class="notif-title">${V(F)}</div>
            <div class="notif-body">${V(Y)}</div>
            <div class="notif-row">
              ${d?`<a class="btn btn-outline btn-sm" href="${k}">${d}</a>`:""}
              <div class="notif-row-spacer"></div>
              <button class="btn btn-outline btn-sm" type="button" data-notif-toggle-read>${h?"Mark read":"Mark unread"}</button>
              <button class="btn btn-outline btn-sm" type="button" data-notif-delete>Remove</button>
            </div>
          </div>
        `}).join(""),St(e,m?.productsById,m?.favorites||[]),z(e)},V=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),St=(e,t,n)=>{const i=L(e),l=document.getElementById("notifPrefsForm");if(!l)return;const o=(s,c)=>{const h=l.querySelector(`[name="${s}"]`);h&&(h.checked=!!c)},a=(s,c)=>{const h=l.querySelector(`[name="${s}"]`);h&&(h.value=String(c??""))};o("orderUpdates",i.orderUpdates),o("backInStock",i.backInStock),o("memberDeals",i.memberDeals),o("lowStock",i.lowStock),o("priceDrops",i.priceDrops),o("browserNotifications",i.browserNotifications),a("lowStockThreshold",i.lowStockThreshold),a("priceDropPercent",i.priceDropPercent),J(G(i.browserNotifications));const u=document.getElementById("notifWatchlist"),b=document.getElementById("notifWatchHint");if(!u)return;const m=(Array.isArray(n)?n:[]).filter(Boolean);if(!t||!m.length){b&&(b.textContent="Tip: favorite items to watch them for back-in-stock and price drops."),u.innerHTML="";return}const g=new Set(i.watchedProductIds||[]),r=m.map(s=>{const c=t.get(String(s));return c?{id:String(c.id),name:String(c.name||"Item")}:null}).filter(Boolean).sort((s,c)=>s.name.localeCompare(c.name));b&&(b.textContent=i.watchedProductIds.length?"Watched items are used for back-in-stock + price-drop alerts.":"No custom watchlist set. Favorites are watched by default."),u.innerHTML=r.map(s=>{const c=g.size?g.has(s.id):!0;return`
          <label class="notif-watch-item">
            <input type="checkbox" data-watch-id="${s.id}" ${c?"checked":""}/>
            <span>${V(s.name)}</span>
          </label>
        `}).join("")},wt=()=>{if(window.__pps_notif_center_inited)return;const e=document;if(!e.getElementById("notificationsList"))return;window.__pps_notif_center_inited=!0;const n=v();n&&z(n),e.addEventListener("click",o=>{const a=o.target.closest("[data-notif-tab]");if(a){e.body.dataset.notifTab=String(a.getAttribute("data-notif-tab")||"all"),A();return}if(o.target.closest("[data-notif-toggle-read]")){const r=o.target.closest("[data-notif-id]"),s=String(r?.getAttribute("data-notif-id")||"");if(!s)return;const c=v();if(!c)return;const h=_(c).map(B=>{if(String(B?.id||"")!==s)return B;const F=!!B?.readAt;return{...B,readAt:F?"":I()}});$(c,h),A();return}if(o.target.closest("[data-notif-delete]")){const r=o.target.closest("[data-notif-id]"),s=String(r?.getAttribute("data-notif-id")||"");if(!s)return;const c=v();if(!c)return;$(c,_(c).filter(h=>String(h?.id||"")!==s)),A();return}if(o.target.closest("#notifMarkAllRead")){const r=v();if(!r)return;const s=_(r).map(c=>c?.readAt?c:{...c,readAt:I()});$(r,s),A();return}if(o.target.closest("#notifClearRead")){const r=v();if(!r)return;$(r,_(r).filter(s=>!s?.readAt)),A();return}if(o.target.closest("#notifClearAll")){const r=v();if(!r)return;$(r,[]),A()}});const i=e.getElementById("notifTypeFilter");i&&i.addEventListener("change",A);const l=e.getElementById("notifPrefsForm");l&&l.addEventListener("submit",o=>{o.preventDefault();const a=v();if(!a)return;const u=H({orderUpdates:!!l.querySelector("[name=orderUpdates]")?.checked,backInStock:!!l.querySelector("[name=backInStock]")?.checked,memberDeals:!!l.querySelector("[name=memberDeals]")?.checked,lowStock:!!l.querySelector("[name=lowStock]")?.checked,priceDrops:!!l.querySelector("[name=priceDrops]")?.checked,browserNotifications:!!l.querySelector("[name=browserNotifications]")?.checked,lowStockThreshold:Number(l.querySelector("[name=lowStockThreshold]")?.value),priceDropPercent:Number(l.querySelector("[name=priceDropPercent]")?.value),watchedProductIds:[]}),b=e.getElementById("notifWatchlist"),f=Array.from(b?.querySelectorAll("[data-watch-id]")||[]).filter(m=>m.checked).map(m=>String(m.getAttribute("data-watch-id")||"")).filter(Boolean);u.watchedProductIds=f.length?f:[],nt(a,u),u.browserNotifications?(async()=>{await st();const m=await mt();J(G(!!u.browserNotifications))})():J(G(!1)),A()}),window.addEventListener("pps:notifs",o=>{const a=P(o?.detail?.email);!a||a!==v()||z(a)}),A()};window.PPS_NOTIFS={getPrefs:L,setPrefs:nt,getNotifications:_,setNotifications:$,computeUnreadCount:O,refreshFromAccount:ht,renderAccountCenter:A,initAccountCenter:wt}})();
