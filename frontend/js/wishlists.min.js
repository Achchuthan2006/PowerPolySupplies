(()=>{"use strict";const c=e=>document.querySelector(e),l=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),E=e=>{try{const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch{return""}},d={orders:[],products:[],productsById:new Map,activeListId:""},n={listSelect:c("#wishlistSelect"),createInput:c("#wishlistName"),createBtn:c("#wishlistCreate"),renameInput:c("#wishlistRename"),renameBtn:c("#wishlistRenameBtn"),deleteBtn:c("#wishlistDelete"),msg:c("#wishlistsMsg"),items:c("#wishlistItems"),soon:c("#wishlistSoon"),soonMsg:c("#wishlistSoonMsg")},L=()=>window.PPS?.getSession?.()||null,x=()=>{const e=L(),t=String(e?.email||"").trim().toLowerCase();return t?`pps_wishlist_alerts_${t}`:"pps_wishlist_alerts_guest"},y=()=>{try{const e=localStorage.getItem(x()),t=JSON.parse(e||"{}");return t&&typeof t=="object"?t:{}}catch{return{}}},P=e=>{try{localStorage.setItem(x(),JSON.stringify(e||{}))}catch{}},B=()=>!(!L()||!window.PPS?.getWishlists),p=e=>{const t=document.getElementById("accountMsg");t&&(t.textContent=String(e||""))},C=e=>{d.activeListId=String(e||""),u()},S=()=>window.PPS?.getWishlists?.(),f=()=>{const e=S();if(!e?.lists?.length)return null;const t=e.lists.find(s=>s.id===d.activeListId)||e.lists[0];return t?(d.activeListId!==t.id&&(d.activeListId=t.id),t):null},$=(e,t)=>window.PPS?.money?.(Number(e)||0,t||"CAD")||"",_=()=>{if(!n.listSelect)return;const e=S();if(!e?.lists?.length){n.listSelect.innerHTML='<option value="">Wishlist</option>';return}n.listSelect.innerHTML=e.lists.map(s=>`<option value="${l(s.id)}">${l(s.name)}</option>`).join("");const t=f();t&&(n.listSelect.value=t.id),n.renameInput&&(n.renameInput.value=t?.name||"")},N=()=>{if(!n.items)return;const e=f();if(!e){n.items.innerHTML='<div style="color:var(--muted); font-size:13px;">Log in to use wishlists.</div>';return}const t=(e.items||[]).map(o=>String(o.productId||"")).filter(Boolean),s=t.map(o=>{const r=d.productsById.get(o);if(!r)return null;const i=Number(r.stock||0),a=i<=0?"Out of stock":i<=10?"Almost out":"In stock",g=window.PPS?.getTieredPriceCents?.(r,1)??r.priceCents,w=y()[o]||{},b=Number(w.targetCents)||g,v=w.enabled!==!1;return`
          <div class="wishlist-item">
            <div style="display:flex; gap:12px; align-items:flex-start;">
              <img class="wishlist-thumb" src="${l(r.image||"")}" alt="" loading="lazy" decoding="async" width="70" height="54">
              <div style="flex:1 1 auto;">
                <div style="font-weight:1000;">${l(r.name||"Item")}</div>
                <div style="color:var(--muted); font-size:13px; margin-top:4px;">${l(r.category||"")} \xB7 ${l(a)}</div>
                <div style="font-weight:900; margin-top:6px;">${$(g,r.currency)}</div>
                <div class="wishlist-alert">
                  <label class="filter-chip">
                    <input type="checkbox" data-alert-toggle="${l(r.id)}" ${v?"checked":""}>
                    <span>Price alert</span>
                  </label>
                  <input class="input" type="number" min="0" step="0.01" data-alert-target="${l(r.id)}" value="${(b/100).toFixed(2)}" style="max-width:120px;">
                </div>
                <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                  <a class="btn btn-outline btn-sm" href="./product.html?slug=${encodeURIComponent(r.slug||"")}">View</a>
                  <button class="btn btn-primary btn-sm" type="button" data-wl-addcart="${l(r.id)}">Add to cart</button>
                  <button class="btn btn-outline btn-sm" type="button" data-wl-remove="${l(r.id)}">Remove</button>
                </div>
              </div>
            </div>
          </div>
        `}).filter(Boolean);n.msg&&(n.msg.textContent=t.length?"":"No items in this wishlist yet."),n.items.innerHTML=s.length?s.join(""):'<div style="color:var(--muted); font-size:13px;">No items in this wishlist yet.</div>'},M=(e,t)=>Math.round((t-e)/(1e3*60*60*24)),T=()=>{const e=new Map;d.orders.forEach(i=>{const a=new Date(i.createdAt).getTime();Number.isFinite(a)&&(i.items||[]).forEach(g=>{const m=String(g.id||"");m&&(e.has(m)||e.set(m,[]),e.get(m).push(a))})});const t=Date.now(),s=[];e.forEach((i,a)=>{const g=Array.from(new Set(i)).sort((h,I)=>h-I);if(g.length<2)return;const m=[];for(let h=1;h<g.length;h++)m.push(M(g[h-1],g[h]));m.sort((h,I)=>h-I);const w=m[Math.floor(m.length/2)]||0;if(w<14)return;const b=g[g.length-1],v=M(b,t);v<Math.max(7,Math.round(w*.6))||v>Math.round(w*1.8)||s.push({id:a,score:v/w,sinceDays:v,cadenceDays:w})});const o=new Set((window.PPS?.getCart?.()||[]).map(i=>String(i?.id||"")).filter(Boolean)),r=s.filter(i=>!o.has(i.id)).filter(i=>!window.PPS?.isInAnyWishlist?.(i.id));return r.sort((i,a)=>a.score-i.score),r.slice(0,6)},A=()=>{if(!n.soon)return;if(!f()){n.soon.innerHTML="",n.soonMsg&&(n.soonMsg.textContent="");return}const t=T();n.soonMsg&&(n.soonMsg.textContent=t.length?"":"No suggestions right now."),n.soon.innerHTML=t.map(s=>{const o=d.productsById.get(s.id);return o?`
          <div class="card" style="padding:14px;">
            <div style="font-weight:1000;">${l(o.name||"Item")}</div>
            <div style="color:var(--muted); font-size:13px; margin-top:6px;">Last ordered ${l(String(s.sinceDays))} days ago</div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <a class="btn btn-outline btn-sm" href="./product.html?slug=${encodeURIComponent(o.slug||"")}">View</a>
              <button class="btn btn-primary btn-sm" type="button" data-wl-add="${l(o.id)}">Add to wishlist</button>
            </div>
          </div>
        `:""}).join("")},u=()=>{if(!B()){n.msg&&(n.msg.textContent="Log in to use wishlists."),n.items&&(n.items.innerHTML=""),n.soon&&(n.soon.innerHTML="");return}_(),N(),A()},W=({orders:e,products:t})=>{d.orders=Array.isArray(e)?e:[],d.products=Array.isArray(t)?t:[],d.productsById=new Map(d.products.map(s=>[String(s?.id||""),s]).filter(s=>s[0])),u()},k=()=>{window.__pps_wishlists_inited||!c("#wishlistItems")||(window.__pps_wishlists_inited=!0,n.listSelect&&n.listSelect.addEventListener("change",t=>C(t.target.value)),n.createBtn?.addEventListener("click",()=>{const t=String(n.createInput?.value||"").trim();if(!t)return;const s=window.PPS?.createWishlist?.(t);n.createInput.value="",s?.lists?.length&&p("Wishlist created."),u()}),n.renameBtn?.addEventListener("click",()=>{const t=f();if(!t)return;const s=String(n.renameInput?.value||"").trim();s&&(window.PPS?.renameWishlist?.(t.id,s),p("Wishlist renamed."),u())}),n.deleteBtn?.addEventListener("click",()=>{const t=S(),s=f();if(!(!t?.lists?.length||!s)){if(t.lists.length<=1){p("Keep at least one wishlist.");return}window.PPS?.deleteWishlist?.(s.id),p("Wishlist deleted."),d.activeListId="",u()}}),document.addEventListener("click",t=>{const s=t.target.closest("[data-wl-remove]");if(s){const i=f();if(!i)return;window.PPS?.removeFromWishlist?.(s.getAttribute("data-wl-remove"),i.id),u();return}const o=t.target.closest("[data-wl-addcart]");if(o){const i=String(o.getAttribute("data-wl-addcart")||""),a=d.productsById.get(i);a&&window.PPS?.addToCart?.(a,1),A(),p("Added to cart.");return}const r=t.target.closest("[data-wl-add]");if(r){const i=f();if(!i)return;window.PPS?.addToWishlist?.(r.getAttribute("data-wl-add"),i.id),u(),p("Added to wishlist.")}}),document.addEventListener("change",t=>{const s=t.target.closest("[data-alert-toggle]");if(s){const r=s.getAttribute("data-alert-toggle"),i=y();i[r]=i[r]||{},i[r].enabled=s.checked,P(i),p("Price alert updated.");return}const o=t.target.closest("[data-alert-target]");if(o){const r=o.getAttribute("data-alert-target"),i=Math.max(0,Math.round(Number(o.value||0)*100)),a=y();a[r]=a[r]||{},a[r].targetCents=i,P(a),p("Alert price updated.")}}),window.addEventListener("pps:wishlists",u),window.addEventListener("pps:currency",u),window.addEventListener("pps:lang",u))};window.PPS_WISHLISTS={init:k,setContext:W,render:u}})();
