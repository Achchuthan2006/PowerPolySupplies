<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Special Offers | Power Poly Supplies</title>
  <link rel="stylesheet" href="./css/styles.css"/>
  <link rel="icon" type="image/png" href="./assets/poly%20logo%20without%20background.png"/>
</head>
<body>
  <header class="site-header">
    <div class="promo-strip">
      <div class="container promo-inner">
        <div><strong data-i18n="brand.name">Power Poly Supplies</strong> | <span data-i18n="brand.tagline">Power your packaging</span></div>
        <div style="font-weight:700;" data-i18n="promo.right">Bulk-ready stock | Fast response | Canada-wide supply</div>
      </div>
    </div>
    <div class="navbar">
      <div class="container navbar-inner">
        <a class="brand" href="./index.html">
          <img src="./assets/poly%20logo%20without%20background.png" alt="Power Poly Supplies"/>
          <div class="brand-text">
            <span class="brand-title" data-i18n="brand.name">Power Poly Supplies</span>
            <span class="brand-tagline" data-i18n="brand.tagline">Power your packaging</span>
          </div>
        </a>
        <button class="menu-btn" id="menuBtn" aria-label="Open menu" data-i18n="nav.menu">Menu</button>
        <nav class="navlinks" id="navLinks">
          <a href="./index.html" data-i18n="nav.home">Home</a>
          <a href="./specials.html" data-i18n="nav.specials">Special Offers</a>
          <div class="dropdown">
            <button class="dropbtn" type="button"><span data-i18n="nav.shop">Shop by Category</span> <span class="caret" aria-hidden="true"></span></button>
            <div class="dropdown-menu">
              <a href="./products.html?cat=Garment%20Bags" data-i18n="nav.garment">Garment Cover Bags</a>
              <a href="./products.html?cat=Polybags" data-i18n="nav.polybags">Polybags</a>
              <a href="./products.html?cat=Hangers" data-i18n="nav.hangers">Hangers</a>
              <a href="./products.html?cat=Wraps" data-i18n="nav.wraps">Wraps</a>
              <a href="./products.html?cat=Racks" data-i18n="nav.racks">Racks</a>
            </div>
          </div>
          <a href="./about.html" data-i18n="nav.about">About Us</a>
          <a href="./contact.html"><span class="nav-icon phone-icon" aria-hidden="true"></span><span data-i18n="nav.contact">Contact</span></a>
          <a href="./feedback.html"><span class="nav-icon pen-icon" aria-hidden="true"></span><span data-i18n="nav.feedback">Feedback</span></a>
          <a href="./login.html"><span class="nav-icon user-icon" aria-hidden="true"></span><span data-i18n="nav.account">Account</span></a>
          <a href="./cart.html"><span class="nav-icon cart-icon" aria-hidden="true"></span><span data-i18n="nav.cart">Cart</span> <span class="badge" data-cart-badge>0</span></a>
          <form class="search-bar nav-search" action="./products.html" method="get" role="search">
            <input type="search" name="q" placeholder="Search" aria-label="Search products">
            <button type="submit">Search</button>
          </form>

        </nav>
      </div>
    </div>
  </header>

  <div class="container page">
    <section class="hero fade-in">
      <p style="margin:0; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted);" data-i18n="specials.kicker">Offers</p>
      <h1 data-i18n="specials.title">Special offers</h1>
      <p data-i18n="specials.subtitle">Limited-time deals on select sizes and bundles. Grab stock before it sells out.</p>
      <a class="btn btn-primary" href="./products.html" data-i18n="specials.shop_all">Shop all products</a>
    </section>

    <h2 style="margin:20px 0 12px;" data-i18n="specials.deals">Deals</h2>
    <div class="grid grid-4" id="grid"></div>

    <div class="footer">&copy; <span id="y"></span> Power Poly Supplies. Power your packaging.</div>
  </div>

  <script src="./config.js"></script>

  <script src="./js/store.js"></script>
  <script src="./js/i18n.js"></script>
  <script src="./js/ui.js"></script>
  <script>
    document.getElementById("y").textContent = new Date().getFullYear();
    PPS.updateCartBadge();

    function categoryLabel(category){
      const lang = window.PPS_I18N?.getLang?.() || "en";
      if(lang === "fr"){
        const map = {
          "Garment Bags": "Housses de vetements",
          "Hangers": "Cintres",
          "Polybags": "Sacs en poly",
          "Wraps": "Films",
          "Racks": "Portants"
        };
        return map[category] || category || "";
      }
      if(lang === "ko"){
        const map = {
          "Garment Bags": "Garment Bags",
          "Hangers": "Hangers",
          "Polybags": "Polybags",
          "Wraps": "Wraps",
          "Racks": "Racks"
        };
        return map[category] || category || "";
      }
      if(lang === "es"){
        const map = {
          "Garment Bags": "Bolsas para prendas",
          "Hangers": "Ganchos",
          "Polybags": "Bolsas de polietileno",
          "Wraps": "Film",
          "Racks": "Percheros"
        };
        return map[category] || category || "";
      }
      return category || "";
    }

    function stockClass(stock){
      if(stock <= 0) return "out";
      if(stock <= 10) return "low";
      return "in";
    }
    function stockLabel(stock){
      if(stock <= 0) return window.PPS_I18N?.t("specials.stock.out") || "Out of stock";
      if(stock <= 10) return window.PPS_I18N?.t("specials.stock.low") || "Almost out of stock";
      return window.PPS_I18N?.t("specials.stock.in") || "In stock";
    }

    const heartIcon = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s-6.7-4.4-9.5-7.2A5.6 5.6 0 0 1 12 5.6a5.6 5.6 0 0 1 9.5 8.2C18.7 16.6 12 21 12 21z"/></svg>';

    function favoriteTitle(active){
      return active
        ? (window.PPS_I18N?.t("favorite.remove") || "Remove from favorites")
        : (window.PPS_I18N?.t("favorite.add") || "Add to favorites");
    }

    function favoriteButton(productId){
      const active = PPS.isFavorite(productId);
      return `<button class="favorite-btn ${active ? "active" : ""}" type="button" data-fav-id="${productId}" aria-pressed="${active ? "true" : "false"}" title="${favoriteTitle(active)}">${heartIcon}</button>`;
    }

    function syncFavoriteButton(btn){
      const id = btn.dataset.favId;
      const active = PPS.isFavorite(id);
      btn.classList.toggle("active", active);
      btn.setAttribute("aria-pressed", active ? "true" : "false");
      btn.title = favoriteTitle(active);
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".favorite-btn");
      if(!btn) return;
      e.preventDefault();
      e.stopPropagation();
      PPS.toggleFavorite(btn.dataset.favId);
      syncFavoriteButton(btn);
    });

    window.addEventListener("pps:favorites", ()=>{
      document.querySelectorAll(".favorite-btn").forEach(syncFavoriteButton);
    });
    function renderSkeletons(grid, count=8){
      grid.innerHTML = new Array(count).fill(0).map(()=>`<div class="card skeleton"></div>`).join("");
    }

    (async ()=>{
      const grid = document.getElementById("grid");
      renderSkeletons(grid);
      try{
        const products = await PPS.loadProducts();
        const specials = products.filter(p => p.special === true);

        if(specials.length === 0){
          const none = window.PPS_I18N?.t("specials.none") || "No specials yet.";
          grid.innerHTML = `<div class="card" style="padding:14px;">${none}</div>`;
          return;
        }

        grid.innerHTML = specials.map(p=>{
          const lang = window.PPS_I18N?.getLang?.() || "en";
          const displayName = lang === "es"
            ? (window.PPS_I18N?.autoTranslate?.(p.name || "", "es") || p.name)
            : p.name;
          const compareCents = (Number(p.priceCents) || 0) + 1000;
          const memberCents = Number(p.priceCents) || 0;
          const savingsCents = Math.max(0, compareCents - memberCents);
          const isMember = Boolean(PPS.getSession?.());
          const bannerTemplate = window.PPS_I18N?.t("member.banner") || "Log in to save {{amount}} with Power Poly Member Pricing";
          const bannerText = bannerTemplate.replace("{{amount}}", PPS.money(savingsCents, p.currency));
          return `
          <div class="card fade-in">
            <a href="./product.html?slug=${encodeURIComponent(p.slug)}">
              <img src="${p.image}" alt="${displayName}">
            </a>
            <div class="card-body">
              <a class="card-title" style="text-decoration:none; display:inline-block;" href="./product.html?slug=${encodeURIComponent(p.slug)}">${displayName}</a>
              <div class="card-meta">${categoryLabel(p.category)}</div>
              <div class="member-pricing">
                <div>
                  <div class="market-label" data-i18n="market.price.label">Market price</div>
                  <span class="compare-price">${PPS.money(compareCents,p.currency)}</span>
                </div>
                <div>
                  <div class="member-label" data-i18n="member.price.label">Power Poly Member Price</div>
                  <span class="price">${PPS.money(memberCents,p.currency)}</span>
                </div>
                ${favoriteButton(p.id)}
              </div>
              ${!isMember && savingsCents > 0 ? `<a class="member-banner" href="./login.html">${bannerText}</a>` : ""}
              <div class="stock ${stockClass(p.stock)}">
                <span class="dot"></span>
                ${stockLabel(p.stock)}
              </div>
              <div style="margin-top:12px; display:flex; gap:10px;">
                <a class="btn" href="./product.html?slug=${encodeURIComponent(p.slug)}">${window.PPS_I18N?.t("specials.view") || "View"}</a>
                <button class="btn btn-primary" ${p.stock<=0?'disabled':''} onclick='add(event,"${p.id}")'>${window.PPS_I18N?.t("specials.add") || "Add"}</button>
                <a class="btn btn-outline" href="./cart.html" data-i18n="specials.action.cart">${window.PPS_I18N?.t("specials.action.cart") || "Go to cart"}</a>
              </div>
              <div class="bulk-quick">
                <button class="btn btn-outline" ${p.stock<=0?'disabled':''} onclick='addBulk(event,"${p.id}",10)'>${window.PPS_I18N?.t("specials.bulk.10") || "10+ boxes"}</button>
                <button class="btn btn-outline" ${p.stock<=0?'disabled':''} onclick='addBulk(event,"${p.id}",15)'>${window.PPS_I18N?.t("specials.bulk.15") || "15+ boxes"}</button>
                <button class="btn btn-outline" ${p.stock<=0?'disabled':''} onclick='addBulk(event,"${p.id}",20)'>${window.PPS_I18N?.t("specials.bulk.20") || "20+ boxes"}</button>
              </div>
            </div>
          </div>
        `;}).join("");

        document.querySelectorAll(".fade-in").forEach(el => el.classList.add("show"));

        window.add = (e,id)=>{
          const p = specials.find(x=>x.id===id);
          if(!p || p.stock<=0) return;
          PPS.addToCart(p);
          if(e && e.target){
            const btn = e.target;
            const prev = btn.textContent;
            btn.textContent = window.PPS_I18N?.t("specials.added") || "Added";
            btn.disabled = true;
            setTimeout(()=>{
              btn.textContent = prev;
              btn.disabled = false;
            }, 800);
          }
        };

        window.addBulk = (e,id,qty)=>{
          const p = specials.find(x=>x.id===id);
          if(!p || p.stock<=0) return;
          PPS.addToCart(p, qty);
          if(e && e.target){
            const btn = e.target;
            const prev = btn.textContent;
            const addedLabel = window.PPS_I18N?.t("specials.added_qty") || "Added {{qty}}";
            btn.textContent = addedLabel.replace("{{qty}}", qty);
            btn.disabled = true;
            setTimeout(()=>{
              btn.textContent = prev;
              btn.disabled = false;
            }, 800);
          }
        };
      }catch(err){
        const errMsg = window.PPS_I18N?.t("specials.error") || "Unable to load specials right now. Please refresh.";
        grid.innerHTML = `<div class="card" style="padding:14px;">${errMsg}</div>`;
        console.error("Failed to load specials", err);
      }
    })();
  </script>
</body>
</html>
